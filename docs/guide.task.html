

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing a Task &mdash; Autopilot 0.2 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="docs.auto-pi-lot.comguide.task.html"/>
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/autopilot_theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Writing a Hardware Class" href="guide.hardware.html" />
    <link rel="prev" title="Training a Subject" href="guide.training.html" />

    <link href="https://fonts.googleapis.com/css?family=Cutive+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Dosis&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lexend+Deca&display=swap" rel="stylesheet">


</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Autopilot
          

          
            
            <img src="_static/autopilot_logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="guide.overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="guide.installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="guide.installation.pilot.html">Setup a Pilot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="guide.installation.pilot.html#scripted-installation">Scripted Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="guide.installation.pilot.html#manual-preinstall">Manual Preinstall</a><ul>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.pilot.html#rasbian-installation">Rasbian Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.pilot.html#raspbian-performance-improvements">Raspbian Performance Improvements</a></li>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.pilot.html#audio-setup">Audio Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.pilot.html#video-setup">Video Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.pilot.html#optional-installation-steps">Optional Installation Steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="guide.installation.terminal.html">Setup a Terminal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="guide.installation.terminal.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="guide.installation.terminal.html#scripted-terminal-setup">Scripted Terminal Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="guide.installation.terminal.html#manual-terminal-presetup">Manual Terminal Presetup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.terminal.html#compiling-installing-qt4-linux">Compiling &amp; Installing Qt4 - Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.terminal.html#installing-qt4-macos">Installing Qt4 - MacOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="guide.installation.terminal.html#compiling-installing-pyside-linux-macos">Compiling &amp; Installing PySide - Linux + macOS</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="guide.training.html">Training a Subject</a><ul>
<li class="toctree-l2"><a class="reference internal" href="guide.training.html#connecting-the-pilot">Connecting the Pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="guide.training.html#creating-a-protocol">Creating a Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="guide.training.html#using-the-protocol-wizard">Using the Protocol Wizard</a></li>
<li class="toctree-l3"><a class="reference internal" href="guide.training.html#manual-protocol-creation">Manual Protocol Creation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="guide.training.html#creating-a-subject">Creating a Subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="guide.training.html#running-the-task">Running the Task</a></li>
<li class="toctree-l2"><a class="reference internal" href="guide.training.html#debugging-a-task">Debugging a Task</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing a Task</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-nafc-task">The Nafc Task</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-task-class">The <code class="docutils literal notranslate"><span class="pre">Task</span></code> class</a></li>
<li class="toctree-l3"><a class="reference internal" href="#four-task-attributes">Four Task Attributes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#params">PARAMS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data">Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plot">PLOT</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hardware">HARDWARE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stage-methods">Stage Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#request">Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="#discrim">Discrim</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reinforcement">Reinforcement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#additional-methods">Additional Methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#distributed-go-no-go-using-child-agents">Distributed Go/No-Go - Using Child Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#additional-prefs">Additional Prefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#go-no-go-parameterization">Go/No-Go Parameterization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-child-task">The Child Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-very-smart-wheel">A Very Smart Wheel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#go-no-go-stage-methods">Go/No-Go Stage Methods</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="guide.hardware.html">Writing a Hardware Class</a></li>
</ul>
<p class="caption"><span class="caption-text">API Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="autopilot.core.html">Core Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.gui.html">gui</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.hardware.html">hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.networking.html">networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.pilot.html">pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.plots.html">plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.subject.html">mouse</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.terminal.html">terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.core.utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autopilot.tasks.html">Tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="autopilot.tasks.free_water.html">free_water</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.tasks.graduation.html">graduation</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.tasks.nafc.html">nafc</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.tasks.task.html">task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autopilot.stim.html">Stimuli</a><ul>
<li class="toctree-l2"><a class="reference internal" href="autopilot.stim.managers.html">managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.stim.sound.html">sound</a><ul>
<li class="toctree-l3"><a class="reference internal" href="autopilot.stim.sound.jackclient.html">jackclient</a></li>
<li class="toctree-l3"><a class="reference internal" href="autopilot.stim.sound.pyoserver.html">pyoserver</a></li>
<li class="toctree-l3"><a class="reference internal" href="autopilot.stim.sound.sounds.html">sounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autopilot.viz.html">Visualization Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="autopilot.viz.trial_viewer.html">trial_viewer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autopilot.setup.html">Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="autopilot.setup.setup_pilot.html">setup_pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.setup.setup_scale.html">setup_scale</a></li>
<li class="toctree-l2"><a class="reference internal" href="autopilot.setup.setup_terminal.html">setup_terminal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autopilot.prefs.html">Prefs</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="todo.html">To-Do</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Autopilot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Writing a Task</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/guide.task.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-a-task">
<span id="guide-task"></span><h1>Writing a Task<a class="headerlink" href="#writing-a-task" title="Permalink to this headline">¶</a></h1>
<p>Some concepts of task design are also discussed in section 3.1 of the <a class="reference external" href="auto-pi-lot.com/autopilot_whitepaper.pdf">whitepaper</a>.</p>
<div class="section" id="the-nafc-task">
<h2>The Nafc Task<a class="headerlink" href="#the-nafc-task" title="Permalink to this headline">¶</a></h2>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Nafc</span></code> class serves as an example for new task designs.</p>
<p>To demonstrate the general structure of Autopilot tasks, let’s build it from scratch.</p>
<div class="section" id="the-task-class">
<h3>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code> class<a class="headerlink" href="#the-task-class" title="Permalink to this headline">¶</a></h3>
<p>We start by subclassing the <a class="reference internal" href="autopilot.tasks.task.html#autopilot.tasks.task.Task" title="autopilot.tasks.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">autopilot.tasks.task.Task</span></code></a> class and initializing it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">autopilot.tasks</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">Nafc</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Nafc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
<p>This gives our new task some basic attributes and methods,
including the <a class="reference internal" href="autopilot.tasks.task.html#autopilot.tasks.task.Task.init_hardware" title="autopilot.tasks.task.Task.init_hardware"><code class="xref py py-meth docutils literal notranslate"><span class="pre">init_hardware()</span></code></a> method for initializing the <code class="docutils literal notranslate"><span class="pre">HARDWARE</span></code> dictionary
and the <a class="reference internal" href="autopilot.tasks.task.html#autopilot.tasks.task.Task.handle_trigger" title="autopilot.tasks.task.Task.handle_trigger"><code class="xref py py-meth docutils literal notranslate"><span class="pre">handle_trigger()</span></code></a> method for handling GPIO triggers.</p>
</div>
<div class="section" id="four-task-attributes">
<h3>Four Task Attributes<a class="headerlink" href="#four-task-attributes" title="Permalink to this headline">¶</a></h3>
<p>We then add the four elements of a task description:</p>
<ol class="arabic simple">
<li>A <strong>PARAMS</strong> dictionary defines what parameters are needed to define the task</li>
<li>A <strong>Data</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">tables.IsDescription</span></code>) descriptor describes what data will be returned from the task</li>
<li>A <strong>PLOT</strong> dictionary that maps the data output to graphical elements in the GUI.</li>
<li>A <strong>HARDWARE</strong> dictionary that describes what hardware will be needed to run the task.</li>
</ol>
<div class="section" id="params">
<h4>PARAMS<a class="headerlink" href="#params" title="Permalink to this headline">¶</a></h4>
<p>Each parameter needs a human readable <code class="docutils literal notranslate"><span class="pre">tag</span></code> that will be used for GUI elements,
and a <code class="docutils literal notranslate"><span class="pre">type</span></code>, currently one of:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">int</span></code>: integers</li>
<li><code class="docutils literal notranslate"><span class="pre">bool</span></code>: boolean (checkboxes in GUI)</li>
<li><code class="docutils literal notranslate"><span class="pre">list</span></code>: list of possible values in {‘Name’:int} pairs</li>
<li><code class="docutils literal notranslate"><span class="pre">sounds</span></code>: a <code class="xref py py-class docutils literal notranslate"><span class="pre">autopilot.core.gui.Sound_Widget</span></code> to define sounds.</li>
</ul>
<p>To maintain order when opened by the GUI we use a <code class="xref py py-class docutils literal notranslate"><span class="pre">odict</span></code> rather than a normal dictionary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">odict</span>

<span class="n">PARAMS</span> <span class="o">=</span> <span class="n">odict</span><span class="p">()</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Reward Duration (ms)&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;int&#39;</span><span class="p">}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;req_reward&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Request Rewards&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;bool&#39;</span><span class="p">}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;punish_stim&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;White Noise Punishment&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;bool&#39;</span><span class="p">}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;punish_dur&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Punishment Duration (ms)&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;int&#39;</span><span class="p">}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Correction Trials&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;bool&#39;</span><span class="p">}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;correction_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;% Correction Trials&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;depends&#39;</span><span class="p">:{</span><span class="s1">&#39;correction&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;bias_mode&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Bias Correction Mode&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;values&#39;</span><span class="p">:{</span><span class="s1">&#39;None&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;Proportional&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="s1">&#39;Thresholded Proportional&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;bias_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;Bias Correction Threshold (%)&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;int&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;depends&#39;</span><span class="p">:{</span><span class="s1">&#39;bias_mode&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}}</span>
<span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Sounds&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;sounds&#39;</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">See the <code class="xref py py-class docutils literal notranslate"><span class="pre">Nafc</span></code> class for descriptions of the task parameters.</p>
</div>
<p>These will be taken as key-value pairs when the task is initialized. ie.:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span>  <span class="s1">&#39;Correction Trials&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>will be used to initialize the task like:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">Nafc</span><span class="p">(</span><span class="n">correction</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># or False</span>
</pre></div>
</div>
</div>
<div class="section" id="data">
<h4>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h4>
<p>There are two types of data,</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">TrialData</span></code> - where a single value for several variables is returned per ‘trial’, and</li>
<li><code class="docutils literal notranslate"><span class="pre">ContinuousData</span></code> - where values and timestamps are taken continuously, with either a fixed or variable interval</li>
</ul>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Support for saving continuous data is in place, but less tested than trial data storage. See <a href="#id1"><span class="problematic" id="id2">:ref:`todo`_</span></a>.</p>
</div>
<p>Both are defined by <a class="reference external" href="https://www.pytables.org/index.html">pytables</a> <code class="xref py py-class docutils literal notranslate"><span class="pre">tables.IsDescription</span></code> objects.
Specify each variable that will be returned and its type using a <code class="xref py py-class docutils literal notranslate"><span class="pre">tables.Col</span></code> object:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">See <a class="reference external" href="https://www.pytables.org/usersguide/libref/declarative_classes.html#col-sub-classes">the pytables documentation</a> for a list of <code class="docutils literal notranslate"><span class="pre">Col</span></code> types</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tables</span>

<span class="k">class</span> <span class="nc">TrialData</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="n">trial_num</span>    <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>
    <span class="n">target</span>       <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">response</span>     <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">correct</span>      <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>
    <span class="n">correction</span>   <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>
    <span class="n">RQ_timestamp</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
    <span class="n">DC_timestamp</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
    <span class="n">bailed</span>       <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>
</pre></div>
</div>
<p>The column types are names with their type and their bit depth except for the <code class="xref py py-class docutils literal notranslate"><span class="pre">StringCol</span></code>
which takes a string length in characters.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TrialData</span></code> object is used by the <code class="xref py py-class docutils literal notranslate"><span class="pre">Subject</span></code> class when a task is assigned to create the data storage table.</p>
</div>
<div class="section" id="plot">
<h4>PLOT<a class="headerlink" href="#plot" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">PLOT</span></code> dictionary maps the data returned from the task to graphical elements in the <code class="xref py py-class docutils literal notranslate"><span class="pre">Terminal</span></code>’s <code class="xref py py-class docutils literal notranslate"><span class="pre">Plot</span></code>.
Specifically, when the task is started, the <code class="xref py py-class docutils literal notranslate"><span class="pre">Plot</span></code> object creates the graphical element (eg. a <code class="xref py py-class docutils literal notranslate"><span class="pre">Point</span></code>)
and then calls its <code class="docutils literal notranslate"><span class="pre">update</span></code> method with any data that is received through its <code class="xref py py-class docutils literal notranslate"><span class="pre">Node</span></code>.</p>
<p>Data-to-graphical mappings are defined in a <code class="docutils literal notranslate"><span class="pre">data</span></code> subdictionary, and additional parameters can be passed to the plot – in the below example, for example,
a <code class="docutils literal notranslate"><span class="pre">chance_bar</span></code> is drawn as a horizontal line across the plot. By default it is drawn at 0.5, but its height can be set with an additional parameter <code class="docutils literal notranslate"><span class="pre">chance_level</span></code>.
Available graphical primitives are registered in the <code class="xref py py-attr docutils literal notranslate"><span class="pre">plots.PLOT_LIST</span></code>, and additional parameters are documented in the <code class="xref py py-class docutils literal notranslate"><span class="pre">Plot</span></code> class.</p>
<p>Data is plotted either by trial (default) or by timestamp (if <code class="docutils literal notranslate"><span class="pre">PLOT['continuous']</span> <span class="pre">!=</span> <span class="pre">True</span></code>). Numerical data is plotted (on the y-axis) as expected, but
further mappings can be defined by extending the graphical element’s <code class="docutils literal notranslate"><span class="pre">update</span></code> method – eg. ‘L’(eft) maps to 0 and ‘R’(ight) maps to 1 by default.</p>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Non-numeric mappings will be supported in the <code class="docutils literal notranslate"><span class="pre">PLOT</span></code> specification after parameters are unified into a single structure.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PLOT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;target&#39;</span>   <span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
        <span class="s1">&#39;response&#39;</span> <span class="p">:</span> <span class="s1">&#39;segment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;correct&#39;</span>  <span class="p">:</span> <span class="s1">&#39;rollmean&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;chance_bar&#39;</span>  <span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c1"># Draw a red bar at 50%</span>
    <span class="s1">&#39;roll_window&#39;</span> <span class="p">:</span> <span class="mi">50</span>    <span class="c1"># n trials to take rolling mean over</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above <code class="docutils literal notranslate"><span class="pre">PLOT</span></code> dictionary produces this pretty little plot:</p>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">screenshot of default nafc plot</p>
</div>
</div>
<div class="section" id="hardware">
<h4>HARDWARE<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">HARDWARE</span></code> dictionary maps a hardware type (eg. <code class="docutils literal notranslate"><span class="pre">POKES</span></code>) and identifier (eg. <code class="docutils literal notranslate"><span class="pre">'L'</span></code>)
to a <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Hardware" title="autopilot.core.hardware.Hardware"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hardware</span></code></a> object. The task uses the hardware parameterization in the
<code class="xref py py-mod docutils literal notranslate"><span class="pre">prefs</span></code> file (also see <a class="reference internal" href="guide.installation.pilot.html#setup-pilot"><span class="std std-ref">Pilot Setup</span></a>) to instantiate each of the hardware objects, so their naming
system must match (ie. there must be a <code class="docutils literal notranslate"><span class="pre">prefs.PINS['POKES']['L']</span></code> entry in <code class="docutils literal notranslate"><span class="pre">prefs</span></code> for a task that has a
<code class="docutils literal notranslate"><span class="pre">task.HARDWARE['POKES']['L']</span></code> object).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">autopilot.core</span> <span class="kn">import</span> <span class="n">hardware</span>

<span class="n">HARDWARE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;POKES&#39;</span><span class="p">:{</span>
        <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Beambreak</span><span class="p">,</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Beambreak</span><span class="p">,</span>
        <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Beambreak</span>
    <span class="p">},</span>
    <span class="s1">&#39;LEDS&#39;</span><span class="p">:{</span>
        <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">LED_RGB</span><span class="p">,</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">LED_RGB</span><span class="p">,</span>
        <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">LED_RGB</span>
    <span class="p">},</span>
    <span class="s1">&#39;PORTS&#39;</span><span class="p">:{</span>
        <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Solenoid</span><span class="p">,</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Solenoid</span><span class="p">,</span>
        <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Solenoid</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<p>First, the parameters that are given to the task when it is initialized are stored as attributes, either by unpacking <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code>…</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Nafc</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Or explicitly, which is recommended as it is more transparent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Nafc</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_block</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reward</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">req_reward</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">punish_stim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">punish_dur</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">correction_pct</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span>
                 <span class="n">bias_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bias_threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">current_trial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req_reward</span>     <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">req_reward</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">punish_stim</span>    <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">punish_stim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">punish_dur</span>     <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">punish_dur</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction</span>     <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">correction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_pct</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">correction_pct</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_mode</span>      <span class="o">=</span> <span class="n">bias_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bias_threshold</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>

        <span class="c1"># etc...</span>
</pre></div>
</div>
<p>Then the hardware is instantiated using a method inherited from the <a class="reference internal" href="autopilot.tasks.task.html#autopilot.tasks.task.Task" title="autopilot.tasks.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">init_hardware</span><span class="p">()</span>
</pre></div>
</div>
<p>Stimulus managers need to be instantiated separately. Currently, stimulus management details like
correction trial percentage or bias correction are given as separate parameters, but will be included in the
<code class="docutils literal notranslate"><span class="pre">stim</span></code> parameter in the future:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the init_manager wrapper to choose the correct stimulus manager</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span> <span class="o">=</span> <span class="n">init_manager</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>

<span class="c1"># give the sounds a function to call when they end</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span><span class="o">.</span><span class="n">set_triggers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_end</span><span class="p">)</span>

<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correction</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span><span class="o">.</span><span class="n">do_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">correction_pct</span><span class="p">)</span>

<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_mode</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span><span class="o">.</span><span class="n">do_bias</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_mode</span><span class="p">,</span>
                              <span class="n">thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_threshold</span><span class="p">)</span>
</pre></div>
</div>
<p>There are a few attributes that can be set at initialization that are unique:</p>
<ul class="simple">
<li><strong>stage_block</strong> - if the task is structured such that the <code class="xref py py-class docutils literal notranslate"><span class="pre">Pilot</span></code> calls each stage method and returns the resulting data, this <a class="reference external" href="https://docs.python.org/2/library/threading.html#threading.Event" title="(in Python v2.7)"><code class="xref py py-class docutils literal notranslate"><span class="pre">threading.Event</span></code></a> is used to wait between stages – an example will be shown below.</li>
<li><strong>stages</strong> - an iterator or generator that yields stage methods.</li>
</ul>
<p>In this example we have structured the task such that its stages (described below) are called in an endless cycle:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This allows us to cycle through the task by just repeatedly calling self.stages.next()</span>
<span class="n">stage_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reinforcement</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">stage_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="stage-methods">
<h3>Stage Methods<a class="headerlink" href="#stage-methods" title="Permalink to this headline">¶</a></h3>
<p>The logic of a task is implemented in one or several <strong>stages</strong>. This example Nafc class uses three:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">request</span></code> - precomputes the target and distractor ports, caches the stimulus, and sets the stimulus to play when the center port is entered</li>
<li><code class="docutils literal notranslate"><span class="pre">discrim</span></code> - sets the reward and punishment triggers for the target and distractor ports</li>
<li><code class="docutils literal notranslate"><span class="pre">reinforcement</span></code> - computes the trial result and readies the task for the next trial.</li>
</ol>
<p>This task does not call its own stage methods, as we will see in the Wheel task example,
but allows the <code class="xref py py-class docutils literal notranslate"><span class="pre">Pilot</span></code> to control them, and advances through stages using a
<code class="docutils literal notranslate"><span class="pre">stage_block</span></code> that allows passage whenever a GPIO trigger is activated. Data is returned from each of the stage methods and is then
returned to the <code class="xref py py-class docutils literal notranslate"><span class="pre">Terminal</span></code> by the <code class="xref py py-class docutils literal notranslate"><span class="pre">Pilot</span></code>.</p>
<div class="section" id="request">
<h4>Request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h4>
<p>First, the <code class="docutils literal notranslate"><span class="pre">stage_block</span></code> is cleared so that the task will not advance until one of the triggers is called.
The target and distractor ports are yielded by the <code class="docutils literal notranslate"><span class="pre">stim_manager</span></code> along with the stimulus object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Set the event block</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># get next stim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distractor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span><span class="o">.</span><span class="n">next_stim</span><span class="p">()</span>
    <span class="c1"># buffer it</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">buffer</span><span class="p">()</span>
</pre></div>
</div>
<p>Then triggers are stored under the name of the trigger (eg. <cite>‘C’</cite> for a trigger that comes from the center poke).
All triggers need to be callable, and can be set either individually or as a series, as in this example.
A <code class="docutils literal notranslate"><span class="pre">lambda</span></code> function is used to set a trigger with arguments – the center LED is set from green to blue when the stimulus starts playing.</p>
<p>A single task class can support multiple operating modes depending on its parameters. If the task has been asked to give
request rewards (see <a class="reference internal" href="guide.training.html#training"><span class="std std-ref">Training a Subject</span></a>), it adds an additional trigger to open the center solenoid.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the center light to green before the stimulus is played.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">set_leds</span><span class="p">({</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">]})</span>

<span class="c1"># Set sound trigger and LEDs</span>
<span class="c1"># We make two triggers to play the sound and change the light color</span>
<span class="n">change_to_blue</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="s1">&#39;LEDS&#39;</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">])</span>

<span class="c1"># set triggers</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_reward</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">play</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">stim_start</span><span class="p">,</span>
                          <span class="n">change_to_blue</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="s1">&#39;PORTS&#39;</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">play</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">stim_start</span><span class="p">,</span>
                          <span class="n">change_to_blue</span><span class="p">]</span>
</pre></div>
</div>
<p>Finally, the data for this stage of the trial is gathered and returned to the Pilot.
Since stimuli have variable numbers and names of parameters, both the table set up by the <code class="xref py py-class docutils literal notranslate"><span class="pre">Subject</span></code> and
the data returning routine here extract stimulus parameters programmatically.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;target&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
    <span class="s1">&#39;trial_num&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span><span class="p">,</span>
    <span class="s1">&#39;correction&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">correction_trial</span>
<span class="p">}</span>
<span class="c1"># get stim info and add to data dict</span>
<span class="n">sound_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">}</span>
<span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sound_info</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">type</span><span class="p">})</span>

<span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>At the end of this function, the center LED is green, and if the subject pokes the center port the stimulus will play and then the next stage method will be called.</p>
<p>The center LED also turns from green to blue when the stimulus begins to play and then turns off when it is finished. This relies on
additional methods that will be explained below.</p>
</div>
<div class="section" id="discrim">
<h4>Discrim<a class="headerlink" href="#discrim" title="Permalink to this headline">¶</a></h4>
<p>The discrim method simply sets the next round of triggers and returns the request timestamp from the current trial.
If either the <code class="docutils literal notranslate"><span class="pre">target</span></code> or <code class="docutils literal notranslate"><span class="pre">distractor</span></code> ports are triggered, the appropriate solenoid is opened or the <code class="docutils literal notranslate"><span class="pre">punish</span></code> method is called.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">trial_num</span></code> is returned each stage for an additional layer of redundancy in data alignment.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">discrim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># clear stage block to wait for triggers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># set triggers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>     <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="s1">&#39;PORTS&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">distractor</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distractor</span><span class="p">),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">punish</span><span class="p">]</span>

    <span class="c1"># Only data is the timestamp</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RQ_timestamp&#39;</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;trial_num&#39;</span>    <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p class="last">pigpio can give us 5 microsecond measurement precision for triggers, currently we just use <a class="reference external" href="https://docs.python.org/2/library/datetime.html#datetime.datetime.now" title="(in Python v2.7)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">datetime.datetime.now()</span></code></a>
for timestamps, but highly accurate timestamps can be had by stashing the <code class="docutils literal notranslate"><span class="pre">ticks</span></code> argument given by pigpio to the
<a class="reference internal" href="autopilot.tasks.task.html#autopilot.tasks.task.Task.handle_trigger" title="autopilot.tasks.task.Task.handle_trigger"><code class="xref py py-meth docutils literal notranslate"><span class="pre">handle_trigger()</span></code></a> method. We will implement this if you don’t first :)</p>
</div>
</div>
<div class="section" id="reinforcement">
<h4>Reinforcement<a class="headerlink" href="#reinforcement" title="Permalink to this headline">¶</a></h4>
<p>This method computes the results of the tasks and returns them with another timestamp.
This stage doesn’t clear the <code class="docutils literal notranslate"><span class="pre">stage_block</span></code> because we want the next trial to be started immediately after
this stage completes.</p>
<p>The results of the current trial are given to the stimulus manager’s <code class="xref py py-meth docutils literal notranslate"><span class="pre">update()</span></code> method
so that it can keep track of trial history and do things like bias correction, etc.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TRIAL_END</span></code> flag in the data signals to the <code class="xref py py-class docutils literal notranslate"><span class="pre">Subject</span></code> class that the trial is finished
and its row of data should be written to disk. This, along with providing the <code class="docutils literal notranslate"><span class="pre">trial_num</span></code> on each stage,
ensure that data is not misaligned between trials.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reinforcement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># update stim manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;DC_timestamp&#39;</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s1">&#39;response&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
        <span class="s1">&#39;correct&#39;</span>      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct</span><span class="p">,</span>
        <span class="s1">&#39;trial_num&#39;</span>    <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span><span class="p">,</span>
        <span class="s1">&#39;TRIAL_END&#39;</span>    <span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="additional-methods">
<h3>Additional Methods<a class="headerlink" href="#additional-methods" title="Permalink to this headline">¶</a></h3>
<p>Autopilot doesn’t confine the logic of a task to its stage methods, instead users can use additional methods
to give their task additional functionality.</p>
<p>These can range from trivial methods that just store values, such as the <code class="docutils literal notranslate"><span class="pre">respond</span></code> and <code class="docutils literal notranslate"><span class="pre">stim_start</span></code> methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">pin</span>

<span class="k">def</span> <span class="nf">stim_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discrim_playing</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>To more complex methods that operate effectively like stages, like the <code class="docutils literal notranslate"><span class="pre">punish</span></code> method, which flashes the LEDs and plays
a punishment stimulus like white noise if it has been configured to do so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">punish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># clear the punish block to the task doesn&#39;t advance while</span>
    <span class="c1"># punishment is delivered</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">punish_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># if there is some punishment stimulus, play it</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">punish_stim</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim_manager</span><span class="o">.</span><span class="n">play_punishment</span><span class="p">()</span>

    <span class="c1"># flash LEDs and then clear the block once they are finished.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flash_leds</span><span class="p">()</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">punish_dur</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">punish_block</span><span class="o">.</span><span class="n">set</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Additionally, since we gave the stimulus manager a trigger method that is called
when the stimulus ends, we can turn the light blue when a stimulus is playing, and
turn it off when it finishes</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stim_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    called by stimulus callback</span>

<span class="sd">    set outside lights blue</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Called by the discrim sound&#39;s table trigger when playback is finished</span>
    <span class="c1"># Used in punishing leaving early</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discrim_playing</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1">#if not self.bailed and self.current_stage == 1:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_leds</span><span class="p">({</span><span class="s1">&#39;L&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;R&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="distributed-go-no-go-using-child-agents">
<h2>Distributed Go/No-Go - Using Child Agents<a class="headerlink" href="#distributed-go-no-go-using-child-agents" title="Permalink to this headline">¶</a></h2>
<div class="figure align-right">
<img alt="_images/gonogo.png" src="_images/gonogo.png" />
</div>
<p>To demonstrate the use of Child agents, we’ll build the distributed Go/No-Go task described in section 4.3 of the Autopilot whitepaper.</p>
<p>In short, a subject runs on a circular running wheel whose velocity is measured by a laser computer mouse.
When the subject ‘fixates’ by slowing below a threshold velocity, an drifting Gabor grating is presented.
If the grating changes angles, the subject is rewarded if they lick in an IR beambreak sensor.
If the grating doesn’t change angles, the subject is rewarded if they refrain from licking until the stimulus has ended.</p>
<div class="section" id="additional-prefs">
<h3>Additional Prefs<a class="headerlink" href="#additional-prefs" title="Permalink to this headline">¶</a></h3>
<p>To use a Child with this task, we will need to have a second Raspberry Pi setup with the same routine as a Pilot, except it needs the following values in its <code class="docutils literal notranslate"><span class="pre">prefs.json</span></code> file:</p>
<p><strong>Child Prefs</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;NAME&quot;</span> <span class="p">:</span> <span class="s2">&quot;wheel_child&quot;</span><span class="p">,</span>
    <span class="nt">&quot;LINEAGE&quot;</span> <span class="p">:</span> <span class="s2">&quot;CHILD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;PARENTID&quot;</span> <span class="p">:</span> <span class="s2">&quot;parent_pilot&quot;</span><span class="p">,</span>
    <span class="nt">&quot;PARENTIP&quot;</span> <span class="p">:</span> <span class="s2">&quot;ip.of.parent.pilot&quot;</span><span class="p">,</span>
    <span class="nt">&quot;PARENTPORT&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;MSGPORT of parent&gt;&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And the parent pilot needs to have</p>
<p><strong>Parent Prefs</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;parent_pilot&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CHILDID&quot;</span><span class="p">:</span> <span class="s2">&quot;wheel_child&quot;</span><span class="p">,</span>
    <span class="nt">&quot;LINEAGE&quot;</span><span class="p">:</span> <span class="s2">&quot;PARENT&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-no-go-parameterization">
<h3>Go/No-Go Parameterization<a class="headerlink" href="#go-no-go-parameterization" title="Permalink to this headline">¶</a></h3>
<p>The parameterization for this task is similar to that of the Nafc task above with a few extensions…</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">autopilot.tasks</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">GoNoGo</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>


    <span class="c1"># Task parameterization</span>
    <span class="n">PARAMS</span> <span class="o">=</span> <span class="n">odict</span><span class="p">()</span>
    <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;Reward Duration (ms)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">}</span>
    <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span><span class="s1">&#39;Delay Timeout (ms)&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;int&#39;</span><span class="p">}</span>
    <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span>  <span class="s1">&#39;Visuals&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;visuals&#39;</span><span class="p">}</span>

    <span class="c1"># Plot parameterization</span>
    <span class="n">PLOT</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;shaded&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
            <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="s1">&#39;segment&#39;</span>
        <span class="p">},</span>
        <span class="c1"># our plot will use time as its x-axis rather than the trial number</span>
        <span class="s1">&#39;continuous&#39;</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>

    <span class="c1"># TrialData descriptor</span>
    <span class="k">class</span> <span class="nc">TrialData</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="n">trial_num</span>    <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>
        <span class="n">target</span>       <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">BoolCol</span><span class="p">()</span>
        <span class="n">response</span>     <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span>      <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>
        <span class="n">RQ_timestamp</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
        <span class="n">DC_timestamp</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
        <span class="n">shift</span>        <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
        <span class="n">angle</span>        <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
        <span class="n">delay</span>        <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
</pre></div>
</div>
<p>We add one additional data descriptor that describes the continuous data that will be sent from the <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Wheel" title="autopilot.core.hardware.Wheel"><code class="xref py py-class docutils literal notranslate"><span class="pre">Wheel</span></code></a> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ContinuousData</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
</pre></div>
</div>
<p>The hardware specification is also similar, with one additional <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Flag" title="autopilot.core.hardware.Flag"><code class="xref py py-class docutils literal notranslate"><span class="pre">Flag</span></code></a> object which
behaves identically to the <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Beambreak" title="autopilot.core.hardware.Beambreak"><code class="xref py py-class docutils literal notranslate"><span class="pre">Beambreak</span></code></a> object with reversed logic (triggered by 0-&gt;1 rather than 1-&gt;0).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">HARDWARE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;POKES&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Beambreak</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;LEDS&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">LED_RGB</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;PORTS&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Solenoid</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;FLAGS&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">hardware</span><span class="o">.</span><span class="n">Flag</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, we add an additional <code class="docutils literal notranslate"><span class="pre">CHILDREN</span></code> dictionary to specify the type of Child
that we need to run the task, as well as any additional parameters needed to configure it.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">task_type</span></code> must refer to some key in the <a href="#id3"><span class="problematic" id="id4">:var:`autopilot.tasks.CHILDREN_LIST`</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">Child</span></code> agent is a subconfiguration of the <code class="docutils literal notranslate"><span class="pre">Pilot</span></code> agent, they will be delineated more
explicitly as the agent framework is solidified.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CHILDREN</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;WHEEL&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s2">&quot;Wheel Child&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>Initialization<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>When initializing this task, we need to make our own <a class="reference internal" href="autopilot.core.networking.html#autopilot.core.networking.Net_Node" title="autopilot.core.networking.Net_Node"><code class="xref py py-class docutils literal notranslate"><span class="pre">Net_Node</span></code></a> object
as well as initialize our child. Assuming that the child is
connected to the parent and appropriately configured (see the
additional params above), then things should go smoothly.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Some of the parameters – most egregiously the Grating stimulus – are
hardcoded in the initialization routine. <strong>This is bad practice</strong> but
an unfortunately necessary evil because the visual stimulus infrastructure is not well developed yet.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">autopilot.stim.visual.visuals</span> <span class="kn">import</span> <span class="n">Grating</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="mf">50.</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">stage_block</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
             <span class="n">punish_dur</span> <span class="o">=</span> <span class="mf">500.</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">GoNoGo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># we receive a stage_block from the pilot as usual, we won&#39;t use it</span>
    <span class="c1"># for task operation though.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span> <span class="o">=</span> <span class="n">stage_block</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># save parameters passed to us as arguments</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">punish_dur</span> <span class="o">=</span> <span class="n">punish_dur</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reward</span> <span class="o">=</span> <span class="n">reward</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span>


    <span class="c1"># init hardware and set reward as before</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_hardware</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_reward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward</span><span class="p">)</span>

    <span class="c1"># hardcoding stimulus while visual stim still immature</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">Grating</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reinforce</span><span class="p">])</span>
</pre></div>
</div>
<p><strong>Initializing the :class:`~autopilot.core.networking.Net_Node`.</strong></p>
<p>It gets the following arguments:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">id</span></code>: The name that is used to identify the task’s networking object so other networking objects can send it messages. We prefix the pilot’s <code class="docutils literal notranslate"><span class="pre">prefs.NAME</span></code> with <code class="docutils literal notranslate"><span class="pre">T_</span></code> because it is a task, though this is not required.</li>
<li><code class="docutils literal notranslate"><span class="pre">upstream</span></code>: The name of the network node that is directly upstream from us, we will be sending our messages to the <code class="xref py py-class docutils literal notranslate"><span class="pre">Pilot</span></code> that is running us – and thus address it by its name</li>
<li><code class="docutils literal notranslate"><span class="pre">port</span></code>: The port of our upstream mode, most commonly the <code class="docutils literal notranslate"><span class="pre">prefs.MSGPORT</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">listens</span></code>: A dictionary that maps messages with different <a href="#id6"><span class="problematic" id="id7">``</span></a>KEY``s to specific handling methods. Since we don’t need to receive any data for this task, this is blank,</li>
<li><code class="docutils literal notranslate"><span class="pre">instance</span></code>: Optional, denotes whether this node shouldn’t be the only node that exists within the Agent – ie. it uses the same instance of the <code class="docutils literal notranslate"><span class="pre">tornado</span></code> IOLoop as other nodes.</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">Net_Node</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;T_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="p">),</span>
                     <span class="n">upstream</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
                     <span class="n">port</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">MSGPORT</span><span class="p">,</span>
                     <span class="n">listens</span><span class="o">=</span><span class="p">{},</span>
                     <span class="n">instance</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>And then to initialize our Child we construct a message to send along to it.</p>
<p>Note that we send the message to <code class="docutils literal notranslate"><span class="pre">prefs.NAME</span></code> – we don’t want to have to know the IP address/etc.
for our child because it connects to us – so the <a class="reference internal" href="autopilot.core.networking.html#autopilot.core.networking.Station" title="autopilot.core.networking.Station"><code class="xref py py-class docutils literal notranslate"><span class="pre">Station</span></code></a> object handles
sending it along with its <a class="reference internal" href="autopilot.core.networking.html#autopilot.core.networking.Pilot_Station.l_child" title="autopilot.core.networking.Pilot_Station.l_child"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Pilot_Station.l_child()</span></code></a> <code class="docutils literal notranslate"><span class="pre">listen</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct a message to send to the child</span>
<span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;child&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">},</span>
    <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHILDREN</span><span class="p">[</span><span class="s1">&#39;WHEEL&#39;</span><span class="p">][</span><span class="s1">&#39;task_type&#39;</span><span class="p">],</span>
    <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span>
<span class="p">}</span>

<span class="c1"># send to the station object with a &#39;CHILD&#39; key</span>
<span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;CHILD&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-child-task">
<h3>The Child Task<a class="headerlink" href="#the-child-task" title="Permalink to this headline">¶</a></h3>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Wheel_Child</span></code> task is a very thin
wrapper around a <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Wheel" title="autopilot.core.hardware.Wheel"><code class="xref py py-class docutils literal notranslate"><span class="pre">Wheel</span></code></a> object, which does most of the work.</p>
<p>It creates a <code class="docutils literal notranslate"><span class="pre">stages</span></code> iterator with a function that returns nothing to fit in with the general task structure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Wheel_Child</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">STAGE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">]</span>

    <span class="n">PARAMS</span> <span class="o">=</span> <span class="n">odict</span><span class="p">()</span>
    <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;Velocity Reporting Rate (Hz)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">}</span>
    <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;Distance Threshold&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">}</span>

    <span class="n">HARDWARE</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;OUTPUT&quot;</span><span class="p">:</span> <span class="n">Digital_Out</span><span class="p">,</span>
        <span class="s2">&quot;WHEEL&quot;</span><span class="p">:</span>  <span class="n">Wheel</span>
    <span class="p">}</span>



    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_block</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="n">thresh</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Digital_Out</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">PINS</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware</span><span class="p">[</span><span class="s1">&#39;WHEEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Wheel</span><span class="p">(</span><span class="n">digi_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">],</span>
                                       <span class="n">fs</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span>
                                       <span class="n">thresh</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresh</span><span class="p">,</span>
                                       <span class="n">mode</span>     <span class="o">=</span> <span class="s2">&quot;steady&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span> <span class="o">=</span> <span class="n">stage_block</span>

    <span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># just fitting in with the task structure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware</span><span class="p">[</span><span class="s1">&#39;WHEEL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="a-very-smart-wheel">
<h3>A Very Smart Wheel<a class="headerlink" href="#a-very-smart-wheel" title="Permalink to this headline">¶</a></h3>
<p>Most of the Child’s contribution to the task is performed by the <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Wheel" title="autopilot.core.hardware.Wheel"><code class="xref py py-class docutils literal notranslate"><span class="pre">Wheel</span></code></a> object.</p>
<p>The Wheel accesses a USB mouse connected to the Pilot,
continuously collects its movements, and reports them back to the
Terminal with a specified frequency (<code class="docutils literal notranslate"><span class="pre">fs</span></code>) with an internal <a class="reference internal" href="autopilot.core.networking.html#autopilot.core.networking.Net_Node" title="autopilot.core.networking.Net_Node"><code class="xref py py-class docutils literal notranslate"><span class="pre">Net_Node</span></code></a></p>
<p>An abbreviated version…</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">inputs</span> <span class="kn">import</span> <span class="n">devices</span>

<span class="k">class</span> <span class="nc">Wheel</span><span class="p">(</span><span class="n">Hardware</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mouse_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">thresh_type</span><span class="o">=</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">digi_out</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;vel_total&#39;</span><span class="p">,</span> <span class="n">integrate_dur</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">mice</span><span class="p">[</span><span class="n">mouse_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="n">thresh</span>
        <span class="c1"># time between updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_dur</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
<p>The Wheel has three message types,</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">'MEASURE'</span></code> - the main task is telling us to monitor for a threshold crossing, ie. previous trial is over and it’s ready for another one.</li>
<li><code class="docutils literal notranslate"><span class="pre">'CLEAR'</span></code> - stop measuring for a threshold crossing event!</li>
<li><code class="docutils literal notranslate"><span class="pre">'STOP'</span></code> - the task is over, clear resources and shut down.</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># initialize networking</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">listens</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MEASURE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_measure</span><span class="p">,</span>
                    <span class="s1">&#39;CLEAR&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_clear</span><span class="p">,</span>
                    <span class="s1">&#39;STOP&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_stop</span><span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">Net_Node</span><span class="p">(</span><span class="s1">&#39;wheel_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mouse_idx</span><span class="p">),</span>
                         <span class="n">upstream</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
                         <span class="n">port</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">MSGPORT</span><span class="p">,</span>
                         <span class="n">listens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="p">,</span>
                         <span class="p">)</span>

    <span class="c1"># if we are being used in a child object,</span>
    <span class="c1"># we send our trigger via a GPIO pin</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">digi_out</span> <span class="o">=</span> <span class="n">digi_out</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>The wheel starts two threads, one that captures mouse movement events and
puts them in a queue, and another that processes movements, transmits them
to the Terminal, and handles the threshold triggers when the subject falls
below a certain velocity.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_mouse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># read mouse movements and put them in a queue</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit_evt</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mouse</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># a threading.Event is used to terminate the wheel&#39;s operation</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit_evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>

    <span class="c1"># ... mouse movements are collected into a 2d numpy array ...</span>

    <span class="c1"># if the main task has told us to measure for a velocity threshold</span>
    <span class="c1"># we check if our recent movements (move) trigger the threshold</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">do_trigger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_thresh</span><span class="p">(</span><span class="n">move</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_trigger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresh_trig</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># and we report recent movements back to the Terminal</span>
    <span class="c1"># the recent velocities and timestamp have been calculated as</span>
    <span class="c1"># x_vel, y_vel, and nowtime</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;CONTINUOUS&#39;</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="p">{</span>
                       <span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x_vel</span><span class="p">,</span>
                       <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y_vel</span><span class="p">,</span>
                       <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">nowtime</span>
                   <span class="p">})</span>
</pre></div>
</div>
<p>If the threshold is triggered, a method (…``thresh_trig``…) is called that
sends a voltage pulse through the <a class="reference internal" href="autopilot.core.hardware.html#autopilot.core.hardware.Digital_Out" title="autopilot.core.hardware.Digital_Out"><code class="xref py py-class docutils literal notranslate"><span class="pre">Digital_Out</span></code></a>
given to it by the Child task.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">thresh_trig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digi_out</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digi_out</span><span class="o">.</span><span class="n">pulse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="go-no-go-stage-methods">
<h3>Go/No-Go Stage Methods<a class="headerlink" href="#go-no-go-stage-methods" title="Permalink to this headline">¶</a></h3>
<p>After the child is initialized, the Parent pilot begins to call the three stage
functions for the task in a cycle</p>
<p>Very similar to the Nafc task above…</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">request</span></code> - Tell the Child to begin measuring for a velocity threshold crossing, prepare the stimulus for delivery</li>
<li><code class="docutils literal notranslate"><span class="pre">discrim</span></code> - Present the stimulus</li>
<li><code class="docutils literal notranslate"><span class="pre">reinforce</span></code> - Reward the subject if they were correct</li>
</ul>
<p>The code here has been abbreviated for the purpose of the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Set the event lock</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stage_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1"># wait on any ongoing punishment stimulus</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">punish_block</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>



    <span class="c1"># set triggers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># tell our wheel to start measuring</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">prefs</span><span class="o">.</span><span class="n">CHILDID</span><span class="p">,</span> <span class="s1">&#39;wheel_0&#39;</span><span class="p">],</span>
                   <span class="n">key</span><span class="o">=</span><span class="s2">&quot;MEASURE&quot;</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;steady&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;thresh&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">})</span>

    <span class="c1"># return data from current stage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="c1"># whether to &#39;go&#39; or &#39;not go&#39;</span>
        <span class="s1">&#39;shift&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span>   <span class="c1"># how much to shift the</span>
                               <span class="c1"># angle of the stimulus</span>
        <span class="s1">&#39;trial_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">discrim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># if the subject licks on a good trial, reward.</span>
    <span class="c1"># set a trigger to respond false if delay time elapses</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="bp">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="s1">&#39;PORTS&#39;</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">punish</span><span class="p">]</span>
    <span class="c1"># otherwise punish</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="bp">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">punish</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">(</span><span class="bp">False</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="s1">&#39;PORTS&#39;</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">]</span>

    <span class="c1"># the stimulus has just started playing, wait a bit and then shift it (if we&#39;re gonna</span>
    <span class="c1"># choose a random delay</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mf">3000.0</span><span class="p">)</span><span class="o">+</span><span class="mf">1000.0</span>
        <span class="c1"># a delay timer is set that shifts the stimulus after</span>
        <span class="c1"># &lt;delay&gt; milliseconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayed_set</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>

    <span class="c1"># trigger the timeout in 5 seconds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_trigger</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># return data to the pilot</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="n">delay</span><span class="p">,</span>
        <span class="s1">&#39;RQ_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s1">&#39;trial_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">reinforce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1"># stop timer if it&#39;s still going</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;DC_timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
        <span class="s1">&#39;correct&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct</span><span class="p">,</span>
        <span class="s1">&#39;trial_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span><span class="p">,</span>
        <span class="s1">&#39;TRIAL_END&#39;</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="guide.hardware.html" class="btn btn-neutral float-right" title="Writing a Hardware Class" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="guide.training.html" class="btn btn-neutral float-left" title="Training a Subject" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jonny Saunders

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>