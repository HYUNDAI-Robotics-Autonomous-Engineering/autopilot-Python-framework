<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>rpilot.core.mouse &#8212; rpilot 0.2 documentation</title>
    <link rel="stylesheet" href="//////////////////../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="//////////////////../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/restyle.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="//////////////////../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/jquery.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/underscore.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/doctools.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/language_data.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//////////////////../../../_static/bootstrap-sphinx.js"></script>
    <link rel="canonical" href="http://docs.rpilot.net/_modules/rpilot/core/mouse.html" />
    <link rel="index" title="Index" href="//////////////////../../../genindex.html" />
    <link rel="search" title="Search" href="//////////////////../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          RPilot</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">RPilot Docs <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.core.html">core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.gui.html">gui</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.gui.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.gui.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.gui.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.hardware.html">hardware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.hardware.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.hardware.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.mouse.html">mouse</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.mouse.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.mouse.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.networking.html">networking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.networking.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.networking.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.pilot.html">pilot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.pilot.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.pilot.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.plots.html">plots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.plots.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.plots.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.plots.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.terminal.html">terminal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.terminal.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.terminal.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.utils.html">utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.utils.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.utils.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.tasks.html">tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.free_water.html">free_water</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.free_water.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.free_water.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.graduation.html">graduation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.graduation.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.graduation.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.nafc.html">nafc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.nafc.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.nafc.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.task.html">task</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.task.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.task.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.stim.html">stim</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.stim.managers.html">managers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.managers.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.managers.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.stim.sound.html">sound</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.sound.jackclient.html">jackclient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.sound.pyoserver.html">pyoserver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.sound.sounds.html">sounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.viz.html">viz</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.viz.trial_viewer.html">trial_viewer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.setup.html">setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.setup.setup_pilot.html">setup_pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.setup.setup_scale.html">setup_scale</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.setup.setup_terminal.html">setup_terminal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.prefs.html">prefs</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
    <div class="col-md-9 content">
      
  <h1>Source code for rpilot.core.mouse</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Classes for managing data and protocol access and storage.</span>

<span class="sd">Currently named mouse, but will likely be refactored to include other data</span>
<span class="sd">models should the need arise.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO: store pilot in biography</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">from</span> <span class="nn">tables.nodes</span> <span class="kn">import</span> <span class="n">filenode</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
<span class="kn">from</span> <span class="nn">rpilot</span> <span class="kn">import</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">rpilot</span> <span class="kn">import</span> <span class="n">prefs</span>
<span class="kn">from</span> <span class="nn">rpilot.stim.sound.sounds</span> <span class="kn">import</span> <span class="n">STRING_PARAMS</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">queue</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="kn">as</span> <span class="nn">queue</span>



<div class="viewcode-block" id="Subject"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject">[docs]</a><span class="k">class</span> <span class="nc">Subject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for managing one mouse&#39;s data and protocol.</span>

<span class="sd">    Creates a :mod:`tables` hdf5 file in `prefs.DATADIR` with the general structure::</span>

<span class="sd">        / root</span>
<span class="sd">        |--- current (tables.filenode) storing the current task as serialized JSON</span>
<span class="sd">        |--- data (group)</span>
<span class="sd">        |    |--- task_name  (group)</span>
<span class="sd">        |         |--- S##_step_name</span>
<span class="sd">        |         |    |--- trial_data</span>
<span class="sd">        |         |    |--- continuous_data</span>
<span class="sd">        |         |--- ...</span>
<span class="sd">        |--- history (group)</span>
<span class="sd">        |    |--- hashes - history of git commit hashes</span>
<span class="sd">        |    |--- history - history of changes: protocols assigned, params changed, etc.</span>
<span class="sd">        |    |--- weights - history of pre and post-task weights</span>
<span class="sd">        |    |--- past_protocols (group) - stash past protocol params on reassign</span>
<span class="sd">        |         |--- date_protocol_name - tables.filenode of a previous protocol&#39;s params.</span>
<span class="sd">        |         |--- ...</span>
<span class="sd">        |--- info - group with biographical information as attributes</span>

<span class="sd">    Attributes:</span>
<span class="sd">        lock (:class:`threading.Lock`): manages access to the hdf5 file</span>
<span class="sd">        name (str): Subject ID</span>
<span class="sd">        file (str): Path to hdf5 file - usually `{prefs.DATADIR}/{self.name}.h5`</span>
<span class="sd">        current (dict): current task parameters. loaded from</span>
<span class="sd">            the &#39;current&#39; :mod:`~tables.filenode` of the h5 file</span>
<span class="sd">        step (int): current step</span>
<span class="sd">        protocol_name (str): name of currently assigned protocol</span>
<span class="sd">        current_trial (int): number of current trial</span>
<span class="sd">        running (bool): Flag that signals whether the mouse is currently running a task or not.</span>
<span class="sd">        data_queue (:class:`queue.Queue`): Queue to dump data while running task</span>
<span class="sd">        thread (:class:`threading.Thread`): thread used to keep file open while running task</span>
<span class="sd">        did_graduate (:class:`threading.Event`): Event used to signal if the mouse has graduated the current step</span>
<span class="sd">        STRUCTURE (list): list of tuples with order:</span>

<span class="sd">            * full path, eg. &#39;/history/weights&#39;</span>
<span class="sd">            * relative path, eg. &#39;/history&#39;</span>
<span class="sd">            * name, eg. &#39;weights&#39;</span>
<span class="sd">            * type, eg. :class:`.Subject.Weight_Table` or &#39;group&#39;</span>

<span class="sd">        node locations (eg. &#39;/data&#39;) to types, either &#39;group&#39; for groups or a</span>
<span class="sd">            :class:`tables.IsDescriptor` for tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">biography</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            name (str): mouse ID</span>
<span class="sd">            dir (str): path where the .h5 file is located, if `None`, `prefs.DATADIR` is used</span>
<span class="sd">            new (bool): if True, a new file is made (a new file is made if one does not exist anyway)</span>
<span class="sd">            biography (dict): If making a new mouse file, a dictionary with biographical data can be passed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">STRUCTURE</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/hashes&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;hashes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hash_Table</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/history&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">History_Table</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/weights&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Weight_Table</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/past_protocols&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;past_protocols&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/info&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">dir</span><span class="p">:</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">DATADIR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_mouse_file</span><span class="p">(</span><span class="n">biography</span><span class="p">)</span>

        <span class="c1"># before we open, make sure we have the stuff we need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_structure</span><span class="p">()</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="c1"># If mouse has a protocol, load it to a dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span>    <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s2">&quot;/current&quot;</span> <span class="ow">in</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="c1"># We load the info from &#39;current&#39; but don&#39;t keep the node open</span>
            <span class="c1"># Stash it as a dict so better access from Python</span>
            <span class="n">current_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">open_node</span><span class="p">(</span><span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">protocol_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;protocol_name&#39;</span><span class="p">]</span>

        <span class="c1"># We will get handles to trial and continuous data when we start running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span>  <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Is the mouse currently running (ie. we expect data to be incoming)</span>
        <span class="c1"># Used to keep the mouse object alive, otherwise we close the file whenever we don&#39;t need it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># We use a threading queue to dump data into a kept-alive h5f file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">did_graduate</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Every time we are initialized we stash the git hash</span>
        <span class="n">history_row</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">row</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">HASH</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">history_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

        <span class="c1"># we have to always open and close the h5f</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

<div class="viewcode-block" id="Subject.open_hdf"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.open_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">open_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the hdf5 file.</span>

<span class="sd">        This should be called at the start of every method that access the h5 file</span>
<span class="sd">        and :meth:`~.Subject.close_hdf` should be called at the end. Otherwise</span>
<span class="sd">        the file will close and we risk file corruption.</span>

<span class="sd">        See the pytables docs</span>
<span class="sd">        `here &lt;https://www.pytables.org/cookbook/threading.html&gt;`_ and</span>
<span class="sd">        `here &lt;https://www.pytables.org/FAQ.html#can-pytables-be-used-in-concurrent-access-scenarios&gt;`_</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (str): a file access mode, can be:</span>

<span class="sd">                * &#39;r&#39;: Read-only - no data can be modified.</span>
<span class="sd">                * &#39;w&#39;: Write - a new file is created (an existing file with the same name would be deleted).</span>
<span class="sd">                * &#39;a&#39; Append - an existing file is opened for reading and writing, and if the file does not exist it is created.</span>
<span class="sd">                * &#39;r+&#39; (default) - Similar to &#39;a&#39;, but file must already exist.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`tables.File`: Opened hdf file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use a decorator around methods instead of explicitly calling</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.close_hdf"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.close_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">close_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5f</span><span class="p">):</span>
        <span class="c1"># type: (tables.file.File) -&gt; None</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes &amp; closes the open hdf file.</span>
<span class="sd">        Must be called whenever :meth:`~.Subject.open_hdf` is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            h5f (:class:`tables.File`): the hdf file opened by :meth:`~.Subject.open_hdf`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">h5f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Subject.new_mouse_file"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.new_mouse_file">[docs]</a>    <span class="k">def</span> <span class="nf">new_mouse_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">biography</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new mouse file and make the general filestructure.</span>

<span class="sd">        If a file already exists, open it in append mode, otherwise create it.</span>

<span class="sd">        Args:</span>
<span class="sd">            biography (dict): Biographical details like DOB, mass, etc.</span>
<span class="sd">                Typically created by :class:`~.gui.New_Subject_Wizard.Biography_Tab`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If a file already exists, we open it for appending so we don&#39;t lose data.</span>
        <span class="c1"># For now we are assuming that the existing file has the basic structure,</span>
        <span class="c1"># but that&#39;s probably a bad assumption for full reliability</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
            <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Make Basic file structure</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="s2">&quot;Trial Record Data&quot;</span><span class="p">)</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="s2">&quot;Biographical Info&quot;</span><span class="p">)</span>
            <span class="n">history_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;history&quot;</span><span class="p">,</span><span class="s2">&quot;History&quot;</span><span class="p">)</span>

            <span class="c1"># When a whole protocol is changed, we stash the old protocol as a filenode in the past_protocols group</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/history&quot;</span><span class="p">,</span> <span class="s2">&quot;past_protocols&quot;</span><span class="p">,</span><span class="s1">&#39;Past Protocol Files&#39;</span><span class="p">)</span>

            <span class="c1"># Also canonical to the basic file structure is the &#39;current&#39; filenode which stores the current protocol,</span>
            <span class="c1"># but since we want to be able to tell that a protocol hasn&#39;t been assigned yet we don&#39;t instantiate it here</span>
            <span class="c1"># See http://www.pytables.org/usersguide/filenode.html</span>
            <span class="c1"># filenode.new_node(h5f, where=&quot;/&quot;, name=&quot;current&quot;)</span>

            <span class="c1"># We keep track of changes to parameters, promotions, etc. in the history table</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">history_group</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">History_Table</span><span class="p">,</span> <span class="s2">&quot;Change History&quot;</span><span class="p">)</span>

            <span class="c1"># Make table for weights</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">history_group</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Weight_Table</span><span class="p">,</span> <span class="s2">&quot;Subject Weights&quot;</span><span class="p">)</span>

            <span class="c1"># And another table to stash the git hash every time we&#39;re open.</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">history_group</span><span class="p">,</span> <span class="s1">&#39;hashes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hash_Table</span><span class="p">,</span> <span class="s2">&quot;Git commit hash history&quot;</span><span class="p">)</span>

        <span class="c1"># Save biographical information as node attributes</span>
        <span class="k">if</span> <span class="n">biography</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">biography</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.ensure_structure"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.ensure_structure">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that our h5f has the appropriate baseline structure as defined in `self.STRUCTURE`</span>

<span class="sd">        Checks that all groups and tables are made, makes them if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRUCTURE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                <span class="c1">#pdb.set_trace()</span>
                <span class="c1"># try to make it</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
                        <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
                    <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Subject.update_biography"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.update_biography">[docs]</a>    <span class="k">def</span> <span class="nf">update_biography</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change or make a new biographical attribute, stored as</span>
<span class="sd">        attributes of the `info` group.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (dict): biographical attributes to be updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.update_history"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.update_history">[docs]</a>    <span class="k">def</span> <span class="nf">update_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the history table when changes are made to the mouse&#39;s protocol.</span>

<span class="sd">        The current protocol is flushed to the past_protocols group and an updated</span>
<span class="sd">        filenode is created.</span>

<span class="sd">        Note:</span>
<span class="sd">            This **only** updates the history table, and does not make the changes itself.</span>

<span class="sd">        Args:</span>
<span class="sd">            type (str): What type of change is being made? Can be one of</span>

<span class="sd">                * &#39;param&#39; - a parameter of one task stage</span>
<span class="sd">                * &#39;step&#39; - the step of the current protocol</span>
<span class="sd">                * &#39;protocol&#39; - the whole protocol is being updated.</span>

<span class="sd">            name (str): the name of either the parameter being changed or the new protocol</span>
<span class="sd">            value (str): the value that the parameter or step is being changed to,</span>
<span class="sd">                or the protocol dictionary flattened to a string.</span>
<span class="sd">            step (int): When type is &#39;param&#39;, changes the parameter at a particular step,</span>
<span class="sd">                otherwise the current step is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure the updates are written to the mouse file</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;param&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">step</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">step</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_current</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_current</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;protocol&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_current</span><span class="p">()</span>


        <span class="c1"># Check that we&#39;re all strings in here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># log the change</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">history_row</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">row</span>

        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">history_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>


    <span class="c1"># def update_params(self, param, value):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Args:</span>
    <span class="c1">#         param:</span>
    <span class="c1">#         value:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # TODO: this</span>
    <span class="c1">#     pass</span>

<div class="viewcode-block" id="Subject.assign_protocol"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.assign_protocol">[docs]</a>    <span class="k">def</span> <span class="nf">assign_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">step_n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a protocol to the mouse.</span>

<span class="sd">        If the mouse has a currently assigned task, stashes it with :meth:`~.Subject.stash_current`</span>

<span class="sd">        Creates groups and tables according to the data descriptions in the task class being assigned.</span>
<span class="sd">        eg. as described in :class:`.Task.TrialData`.</span>

<span class="sd">        Updates the history table.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocol (str): the protocol to be assigned. Can be one of</span>

<span class="sd">                * the name of the protocol (its filename minus .json) if it is in `prefs.PROTOCOLDIR`</span>
<span class="sd">                * filename of the protocol (its filename with .json) if it is in the `prefs.PROTOCOLDIR`</span>
<span class="sd">                * the full path and filename of the protocol.</span>

<span class="sd">            step_n (int): Which step is being assigned?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Protocol will be passed as a .json filename in prefs.PROTOCOLDIR</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>



        <span class="c1">## Assign new protocol</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>

        <span class="c1"># try prepending the protocoldir if we were passed just the name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
            <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">PROTOCOLDIR</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fullpath</span><span class="p">):</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find either {} or {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">))</span>

        <span class="c1"># Set name and step</span>
        <span class="c1"># Strip off path and extension to get the protocol name</span>
        <span class="n">protocol_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">protocol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Load protocol to dict</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="k">as</span> <span class="n">protocol_file</span><span class="p">:</span>
            <span class="n">prot_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">protocol_file</span><span class="p">)</span>

        <span class="c1"># Check if there is an existing protocol, archive it if there is.</span>
        <span class="k">if</span> <span class="s2">&quot;/current&quot;</span> <span class="ow">in</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">protocol_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">prot_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stash_current</span><span class="p">()</span>
            <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="c1"># Make filenode and save as serialized json</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">new_node</span><span class="p">(</span><span class="n">h5f</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prot_dict</span><span class="p">))</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># save some protocol attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">prot_dict</span>

        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;protocol_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="n">protocol_name</span>

        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_n</span><span class="p">)</span>

        <span class="c1"># Make file group for protocol</span>
        <span class="k">if</span> <span class="s2">&quot;/data/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">protocol_name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="n">current_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">protocol_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">protocol_name</span><span class="p">)</span>

        <span class="c1"># Create groups for each step</span>
        <span class="c1"># There are two types of data - continuous and trialwise.</span>
        <span class="c1"># Each gets a single table within a group: since each step should have</span>
        <span class="c1"># consistent data requirements over time and hdf5 doesn&#39;t need to be in</span>
        <span class="c1"># memory, we can just keep appending to keep things simple.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># First we get the task class for this step</span>
            <span class="n">task_class</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">TASK_LIST</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]]</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>
            <span class="c1"># group name is S##_&#39;step_name&#39;</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;S{:02d}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_group</span><span class="p">:</span>
                <span class="n">step_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">current_group</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step_group</span> <span class="o">=</span> <span class="n">current_group</span><span class="o">.</span><span class="n">_f_get_child</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>

            <span class="c1"># The task class *should* have at least one PyTables DataTypes descriptor</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="s2">&quot;TrialData&quot;</span><span class="p">):</span>
                    <span class="n">trial_descriptor</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">TrialData</span>
                    <span class="c1"># add a session column, everyone needs a session column</span>
                    <span class="k">if</span> <span class="s1">&#39;session&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()})</span>
                    <span class="c1"># same thing with trial_num</span>
                    <span class="k">if</span> <span class="s1">&#39;trial_num&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;trial_num&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()})</span>
                    <span class="c1"># if this task has sounds, make columns for them</span>
                    <span class="k">if</span> <span class="s1">&#39;stim&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;sounds&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># for now we just assume they&#39;re floats</span>
                            <span class="n">sound_params</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">side</span><span class="p">,</span> <span class="n">sounds</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;sounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="c1"># each side has a list of sounds</span>
                                <span class="k">for</span> <span class="n">sound</span> <span class="ow">in</span> <span class="n">sounds</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sound</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">STRING_PARAMS</span><span class="p">:</span>
                                            <span class="n">sound_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">sound_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
                            <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sound_params</span><span class="p">)</span>

                    <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">step_group</span><span class="p">,</span> <span class="s2">&quot;trial_data&quot;</span><span class="p">,</span> <span class="n">trial_descriptor</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">NodeError</span><span class="p">:</span>
                <span class="c1"># we already have made this table, that&#39;s fine</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="s2">&quot;ContinuousData&quot;</span><span class="p">):</span>
                    <span class="n">cont_descriptor</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">ContinuousData</span>
                    <span class="n">cont_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()})</span>
                    <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">step_group</span><span class="p">,</span> <span class="s2">&quot;continuous_data&quot;</span><span class="p">,</span> <span class="n">cont_descriptor</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">NodeError</span><span class="p">:</span>
                <span class="c1"># already made it</span>
                <span class="k">pass</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

        <span class="c1"># Update history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="n">protocol_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.flush_current"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.flush_current">[docs]</a>    <span class="k">def</span> <span class="nf">flush_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes the &#39;current&#39; attribute in the mouse object to the current filenode</span>
<span class="sd">        in the .h5</span>

<span class="sd">        Used to make sure the stored .json representation of the current task stays up to date</span>
<span class="sd">        with the params set in the mouse object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="s1">&#39;/current&#39;</span><span class="p">)</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">new_node</span><span class="p">(</span><span class="n">h5f</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">))</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;protocol_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.stash_current"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.stash_current">[docs]</a>    <span class="k">def</span> <span class="nf">stash_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current protocol in the history group and delete the node</span>

<span class="sd">        Typically this is called when assigning a new protocol.</span>

<span class="sd">        Stored as the date that it was changed followed by its name if it has one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protocol_name</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/current&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol_name&#39;</span><span class="p">)</span>
            <span class="n">archive_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">protocol_name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;protocol_name attribute couldn&#39;t be accessed, using timestamp to stash protocol&quot;</span><span class="p">)</span>
            <span class="n">archive_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># TODO: When would we want to prefer the .h5f copy over the live one?</span>
        <span class="c1">#current_node = filenode.open_node(h5f.root.current)</span>
        <span class="c1">#old_protocol = current_node.readall()</span>

        <span class="n">archive_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">new_node</span><span class="p">(</span><span class="n">h5f</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;/history/past_protocols&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">archive_name</span><span class="p">)</span>
        <span class="n">archive_node</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">))</span>

        <span class="n">h5f</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="s1">&#39;/current&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.prepare_run"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.prepare_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the Subject object to receive data while running the task.</span>

<span class="sd">        Gets information about current task, trial number,</span>
<span class="sd">        spawns :class:`~.tasks.graduation.Graduation` object,</span>
<span class="sd">        spawns :attr:`~.Subject.data_queue` and calls :meth:`~.Subject.data_thread`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: the parameters for the current step, with mouse id, step number,</span>
<span class="sd">                current trial, and session number included.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trial_table</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cont_table</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="c1"># Get current task parameters and handles to tables</span>
        <span class="n">task_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">]</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>

        <span class="c1"># file structure is &#39;/data/protocol_name/##_step_name/tables&#39;</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/{}/S{:02d}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
        <span class="c1">#try:</span>
        <span class="n">trial_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;trial_data&#39;</span><span class="p">)</span>
        <span class="c1">#self.trial_row = self.trial_table.row</span>
        <span class="c1">#self.trial_keys = self.trial_table.colnames</span>

        <span class="c1"># get last trial number and session</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">trial_num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cont_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;continuous_data&#39;</span><span class="p">)</span>
            <span class="c1">#self.cont_row   = self.cont_table.row</span>
            <span class="c1">#self.cont_keys  = self.cont_table.colnames</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">cont_table</span><span class="p">,</span> <span class="n">trial_table</span><span class="p">]):</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No data tables exist for step {}! Is there a Trial or Continuous data descriptor in the task class?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>

        <span class="c1"># TODO: Spawn graduation checking object!</span>
        <span class="k">if</span> <span class="s1">&#39;graduation&#39;</span> <span class="ow">in</span> <span class="n">task_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">grad_type</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;graduation&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">grad_params</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;graduation&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># add other params asked for by the task class</span>
            <span class="n">grad_obj</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">GRAD_LIST</span><span class="p">[</span><span class="n">grad_type</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">:</span>
                <span class="c1"># these are params that should be set in the protocol settings</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grad_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># for now, try to find it in our attributes</span>
                        <span class="c1"># TODO: See where else we would want to get these from</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
                            <span class="n">grad_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">param</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)})</span>

            <span class="k">if</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">COLS</span><span class="p">:</span>
                <span class="c1"># these are columns in our trial table</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">COLS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">grad_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)})</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Graduation object requested column {}, but it was not found in the trial table&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>

            <span class="c1">#grad_params[&#39;value&#39;][&#39;current_trial&#39;] = str(self.current_trial) # str so it&#39;s json serializable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span> <span class="o">=</span> <span class="n">grad_obj</span><span class="p">(</span><span class="o">**</span><span class="n">grad_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">did_graduate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

        <span class="c1"># spawn thread to accept data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># return a task parameter dictionary</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">])</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;current_trial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="k">return</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Subject.data_thread"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.data_thread">[docs]</a>    <span class="k">def</span> <span class="nf">data_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thread that keeps hdf file open and receives data while task is running.</span>

<span class="sd">        receives data through :attr:`~.Subject.queue` as dictionaries. Data can be</span>
<span class="sd">        partial-trial data (eg. each phase of a trial) as long as the task returns a dict with</span>
<span class="sd">        &#39;TRIAL_END&#39; as a key at the end of each trial.</span>

<span class="sd">        each dict given to the queue should have the `trial_num`, and this method can</span>
<span class="sd">        properly store data without passing `TRIAL_END` if so. I recommend being explicit, however.</span>

<span class="sd">        Checks graduation state at the end of each trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            queue (:class:`queue.Queue`): passed by :meth:`~.Subject.prepare_run` and used by other</span>
<span class="sd">                objects to pass data to be stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="n">task_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">]</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>

        <span class="c1"># file structure is &#39;/data/protocol_name/##_step_name/tables&#39;</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/{}/S{:02d}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
        <span class="c1">#try:</span>
        <span class="n">trial_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;trial_data&#39;</span><span class="p">)</span>
        <span class="n">trial_keys</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">colnames</span>
        <span class="n">trial_row</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">row</span>

        <span class="c1"># start getting data</span>
        <span class="c1"># stop when &#39;END&#39; gets put in the queue</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
            <span class="c1"># Check if this is the same</span>
            <span class="c1"># if we&#39;ve already recorded a trial number for this row,</span>
            <span class="c1"># and the trial number we just got is not the same,</span>
            <span class="c1"># we edit that row if we already have some data on it or else start a new row</span>
            <span class="k">if</span> <span class="s1">&#39;trial_num&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]):</span>
                    <span class="c1"># find row with this trial number if it exists</span>
                    <span class="n">other_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;trial_num == {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]))]</span>
                    <span class="c1"># this will return a list of rows with matching trial_num.</span>
                    <span class="c1"># if it&#39;s empty, we didn&#39;t receive a TRIAL_END and should create a new row</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">trial_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
                        <span class="c1"># proceed to fill the row below</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># update the row and continue so we don&#39;t double write</span>
                        <span class="c1"># have to be in the middle of iteration to use update()</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;trial_num == {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">])):</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># we have more than one row with this trial_num.</span>
                        <span class="c1"># shouldn&#39;t happen, but we dont&#39; want to throw any data away</span>
                        <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Found multiple rows with same trial_num: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]))</span>
                        <span class="c1"># continue just for data conservancy&#39;s sake</span>
                        <span class="n">trial_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>


            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trial_keys</span><span class="p">:</span>
                    <span class="n">trial_row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="s1">&#39;TRIAL_END&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
                <span class="n">trial_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
                <span class="n">trial_table</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span><span class="p">:</span>
                    <span class="c1"># set our graduation flag, the terminal will get the rest rolling</span>
                    <span class="n">did_graduate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">trial_row</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">did_graduate</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">did_graduate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.save_data"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alternate and equivalent method of putting data in the queue as `Subject.data_queue.put(data)`</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): trial data. each should have a &#39;trial_num&#39;, and a dictionary with key</span>
<span class="sd">                &#39;TRIAL_END&#39; should be passed at the end of each trial.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.stop_run"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.stop_run">[docs]</a>    <span class="k">def</span> <span class="nf">stop_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        puts &#39;END&#39; in the data_queue, which causes :meth:`~.Subject.data_thread` to end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Data thread did not exit&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.get_trial_data"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.get_trial_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_trial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get trial data from the current task.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (int, list, &#39;all&#39;): Step that should be returned, can be one of</span>

<span class="sd">                * -1: most recent step</span>
<span class="sd">                * int: a single step</span>
<span class="sd">                * list of two integers eg. [0, 5], an inclusive range of steps.</span>
<span class="sd">                * anything else, eg. &#39;all&#39;: all steps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: DataFrame of requested steps&#39; trial data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># step= -1 is just most recent step,</span>
        <span class="c1"># step= int is an integer specified step</span>
        <span class="c1"># step= [n1, n2] is from step n1 to n2 inclusive</span>
        <span class="c1"># step= &#39;all&#39; or anything that isn&#39;t an int or a list is all steps</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="n">step_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># find the last trial step with data</span>
            <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">trial_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NROWS&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">step_groups</span> <span class="o">=</span> <span class="n">step_groups</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">step_groups</span> <span class="o">=</span> <span class="n">step_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="k">for</span> <span class="n">step_key</span> <span class="ow">in</span> <span class="n">step_groups</span><span class="p">:</span>
            <span class="n">step_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># beginning of keys will be &#39;S##&#39;</span>
            <span class="n">step_tab</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_key</span><span class="p">]</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="s1">&#39;trial_data&#39;</span><span class="p">]</span>
            <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">step_tab</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_n</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">return_df</span> <span class="o">=</span> <span class="n">return_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="n">return_df</span> <span class="o">=</span> <span class="n">step_df</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">return_df</span></div>


<div class="viewcode-block" id="Subject.get_step_history"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.get_step_history">[docs]</a>    <span class="k">def</span> <span class="nf">get_step_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a dataframe of step numbers, timestamps, and step names</span>
<span class="sd">        as a coarse view of training status.</span>

<span class="sd">        Args:</span>
<span class="sd">            use_history (bool): whether to use the history table or to reconstruct steps and dates from the trial table itself.</span>
<span class="sd">                compatibility fix for old versions that didn&#39;t stash step changes when the whole protocol was updated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_history</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span>
            <span class="c1"># return a dataframe of step number, datetime and step name</span>
            <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">])</span>

            <span class="n">step_df</span> <span class="o">=</span> <span class="n">step_df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;step_n&#39;</span><span class="p">,</span>
                                      <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
                                      <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>

            <span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
                                                  <span class="n">format</span><span class="o">=</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
            <span class="n">step_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># find the last trial step with data</span>
            <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">trial_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NROWS&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="c1"># Iterate through steps, find first timestamp, use that.</span>
            <span class="k">for</span> <span class="n">step_key</span> <span class="ow">in</span> <span class="n">step_groups</span><span class="p">:</span>
                <span class="n">step_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># beginning of keys will be &#39;S##&#39;</span>
                <span class="n">step_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">step_n</span><span class="p">][</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>
                <span class="n">step_tab</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_key</span><span class="p">]</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="s1">&#39;trial_data&#39;</span><span class="p">]</span>
                <span class="c1"># find name of column that is a timestamp</span>
                <span class="n">colnames</span> <span class="o">=</span> <span class="n">step_tab</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">_v_colnames</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ts_column</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="n">step_tab</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">ts_column</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;No Timestamp column found, only returning step numbers and named that were reached&#39;</span><span class="p">)</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;step_n&#39;</span><span class="p">:</span><span class="n">step_n</span><span class="p">,</span>
                     <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span><span class="n">ts</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">step_name</span>
                    <span class="p">})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">return_df</span> <span class="o">=</span> <span class="n">return_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                    <span class="n">return_df</span> <span class="o">=</span> <span class="n">step_df</span>

            <span class="n">step_df</span> <span class="o">=</span> <span class="n">return_df</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">step_df</span></div>

<div class="viewcode-block" id="Subject.get_timestamp"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.get_timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># type: (bool) -&gt; str</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            simple (bool):</span>
<span class="sd">                if True:</span>
<span class="sd">                    returns as format &#39;%y%m%d-%H%M%S&#39;, eg &#39;190201-170811&#39;</span>
<span class="sd">                if False:</span>
<span class="sd">                    returns in isoformat, eg. &#39;2019-02-01T17:08:02.058808&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            basestring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Timestamps have two different applications, and thus two different formats:</span>
        <span class="c1"># coarse timestamps that should be human-readable</span>
        <span class="c1"># fine timestamps for data analysis that don&#39;t need to be</span>
        <span class="k">if</span> <span class="n">simple</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span></div>

<div class="viewcode-block" id="Subject.get_weight"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.get_weight">[docs]</a>    <span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="n">include_baseline</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets start and stop weights.</span>

<span class="sd">        TODO:</span>
<span class="sd">            add ability to get weights by session number, dates, and ranges.</span>

<span class="sd">        Args:</span>
<span class="sd">            which (str):  if &#39;last&#39;, gets most recent weights. Otherwise returns all weights.</span>
<span class="sd">            include_baseline (bool): if True, includes baseline and minimum mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get either the last start/stop weights, optionally including baseline</span>
        <span class="c1"># TODO: Get by session</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">weight_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">column</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">include_baseline</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;baseline_mass&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">*</span><span class="mf">0.8</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;baseline_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;minimum_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimum</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="Subject.set_weight"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.set_weight">[docs]</a>    <span class="k">def</span> <span class="nf">set_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates an existing weight in the weight table.</span>

<span class="sd">        TODO:</span>
<span class="sd">            Yes, i know this is bad. Merge with update_weights</span>

<span class="sd">        Args:</span>
<span class="sd">            date (str): date in the &#39;simple&#39; format, %y%m%d-%H%M%S</span>
<span class="sd">            col_name (&#39;start&#39;, &#39;stop&#39;): are we updating a pre-task or post-task weight?</span>
<span class="sd">            new_value (float): New mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">weight_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span>
        <span class="c1"># there should only be one matching row since it includes seconds</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;date == b&quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">)):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Subject.update_weights"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.update_weights">[docs]</a>    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store either a starting or stopping mass.</span>

<span class="sd">        `start` and `stop` can be passed simultaneously, `start` can be given in one</span>
<span class="sd">        call and `stop` in a later call, but `stop` should not be given before `start`.</span>

<span class="sd">        Args:</span>
<span class="sd">            start (float): Mass before running task in grams</span>
<span class="sd">            stop (float): Mass after running task in grams.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">weight_row</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">row</span>
            <span class="n">weight_row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">weight_row</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
            <span class="n">weight_row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">weight_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># TODO: Make this more robust - don&#39;t assume we got a start weight</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">stop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Need either a start or a stop weight&quot;</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.graduate"><a class="viewcode-back" href="../../../rpilot.core.mouse.html#rpilot.core.mouse.Subject.graduate">[docs]</a>    <span class="k">def</span> <span class="nf">graduate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increase the current step by one, unless it is the last step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Tried to graduate from the last step!</span><span class="se">\n</span><span class="s1"> Task has {} steps and we are on {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># increment step, update_history should handle the rest</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">step</span><span class="p">][</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

    <span class="k">class</span> <span class="nc">History_Table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to describe parameter and protocol change history</span>

<span class="sd">        Attributes:</span>
<span class="sd">            time (str): timestamps</span>
<span class="sd">            type (str): Type of change - protocol, parameter, step</span>
<span class="sd">            name (str): Name - Which parameter was changed, name of protocol, manual vs. graduation step change</span>
<span class="sd">            value (str): Value - What was the parameter/protocol/etc. changed to, step if protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">4028</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Weight_Table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to describe table for weight history</span>

<span class="sd">        Attributes:</span>
<span class="sd">            start (float): Pre-task mass</span>
<span class="sd">            stop (float): Post-task mass</span>
<span class="sd">            date (str): Timestamp in simple format</span>
<span class="sd">            session (int): Session number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
        <span class="n">stop</span>  <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
        <span class="n">date</span>  <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Hash_Table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to describe table for hash history</span>

<span class="sd">        Attributes:</span>
<span class="sd">            time (str): Timestamps</span>
<span class="sd">            hash (str): Hash of the currently checked out commit of the git repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span></div>

</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Jonny Saunders.<br/>
      Created using <a href="//////////////////http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>