<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>rpilot.core.networking &#8212; rpilot 0.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/restyle.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          RPilot</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">RPilot Docs <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.core.html">core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.gui.html">gui</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.gui.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.gui.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.gui.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.hardware.html">hardware</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.hardware.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.hardware.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.mouse.html">mouse</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.mouse.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.mouse.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.networking.html">networking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.networking.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.networking.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.pilot.html">pilot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.pilot.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.pilot.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.plots.html">plots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.plots.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.plots.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.plots.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.terminal.html">terminal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.terminal.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.terminal.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.core.utils.html">utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.utils.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.core.utils.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.tasks.html">tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.free_water.html">free_water</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.free_water.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.free_water.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.graduation.html">graduation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.graduation.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.graduation.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.nafc.html">nafc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.nafc.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.nafc.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.tasks.task.html">task</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.task.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.tasks.task.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.stim.html">stim</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.stim.managers.html">managers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.managers.html#classes">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.managers.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.stim.sound.html">sound</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.sound.jackclient.html">jackclient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.sound.pyoserver.html">pyoserver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../rpilot.stim.sound.sounds.html">sounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.viz.html">viz</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.viz.trial_viewer.html">trial_viewer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.setup.html">setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.setup.setup_pilot.html">setup_pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.setup.setup_scale.html">setup_scale</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rpilot.setup.setup_terminal.html">setup_terminal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpilot.prefs.html">prefs</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
    <div class="col-md-9 content">
      
  <h1>Source code for rpilot.core.networking</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes for network communication.</span>

<span class="sd">There are two general types of network objects -</span>

<span class="sd">* :class:`.Networking` and its children are independent processes that should only be instantiated once</span>
<span class="sd">    per piece of hardware. They are used to distribute messages between :class:`.Net_Node` s,</span>
<span class="sd">    forward messages up the networking tree, and responding to messages that don&#39;t need any input from</span>
<span class="sd">    the :class:`~.pilot.Pilot` or :class:`~.terminal.Terminal`.</span>
<span class="sd">* :class:`.Net_Node` is a pop-in networking class that can be given to any other object that</span>
<span class="sd">    wants to send or receive messages.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">IOLoop</span>
<span class="kn">from</span> <span class="nn">zmq.eventloop.zmqstream</span> <span class="kn">import</span> <span class="n">ZMQStream</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>

<span class="kn">from</span> <span class="nn">rpilot</span> <span class="kn">import</span> <span class="n">prefs</span>

<span class="c1"># TODO: Periodically ping pis to check that they are still responsive</span>

<div class="viewcode-block" id="Networking"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking">[docs]</a><span class="k">class</span> <span class="nc">Networking</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Independent networking class used for messaging between computers.</span>

<span class="sd">    These objects send and handle :class:`.networking.Message` s by using a</span>
<span class="sd">    dictionary of :attr:`~.networking.Networking.listens`, or methods</span>
<span class="sd">    that are called to respond to different types of messages.</span>

<span class="sd">    Each sent message is given an ID, and a thread is spawned to periodically</span>
<span class="sd">    resend it (up until some time-to-live, typically 5 times) until confirmation</span>
<span class="sd">    is received.</span>

<span class="sd">    By default, the only listen these objects have is :meth:`.l_confirm`,</span>
<span class="sd">    which responds to message confirmations. Accordingly, `listens` should be added</span>
<span class="sd">    by using :meth:`dict.update` rather than reassigning the attribute.</span>

<span class="sd">    Networking objects can be made with or without a :attr:`~.networking.Networking.pusher`,</span>
<span class="sd">    a :class:`zmq.DEALER` socket that connects to the :class:`zmq.ROUTER`</span>
<span class="sd">    socket of an upstream Networking object.</span>

<span class="sd">    This class should not be instantiated on its own, but should instead</span>
<span class="sd">    be subclassed in order to provide methods used by :meth:`~.Networking.handle_listen`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ctx (:class:`zmq.Context`):  zeromq context</span>
<span class="sd">        loop (:class:`tornado.ioloop.IOLoop`): a tornado ioloop</span>
<span class="sd">        pusher (:class:`zmq.Socket`): pusher socket - a dealer socket that connects to other routers</span>
<span class="sd">        push_ip (str): If we have a dealer, IP to push messages to</span>
<span class="sd">        push_port (str):  If we have a dealer, port to push messages to</span>
<span class="sd">        push_id (str): :attr:`~zmq.Socket.identity` of the Router we push to</span>
<span class="sd">        listener (:class:`zmq.Socket`): The main router socket to send/recv messages</span>
<span class="sd">        listen_port (str): Port our router listens on</span>
<span class="sd">        logger (:class:`logging.Logger`): Used to log messages and network events.</span>
<span class="sd">        log_handler (:class:`logging.FileHandler`): Handler for logging</span>
<span class="sd">        log_formatter (:class:`logging.Formatter`): Formats log entries as::</span>

<span class="sd">            &quot;%(asctime)s %(levelname)s : %(message)s&quot;</span>

<span class="sd">        id (str): What are we known as? What do we set our :attr:`~zmq.Socket.identity` as?</span>
<span class="sd">        ip (str): Device IP</span>
<span class="sd">        listens (dict): Dictionary of functions to call for different types of messages. keys match the :attr:`.Message.key`.</span>
<span class="sd">        senders (dict): Identities of other sockets (keys, ie. directly connected) and their state (values) if they keep one</span>
<span class="sd">        outbox (dict): Messages that have been sent but have not been confirmed</span>
<span class="sd">        timers (dict): dict of :class:`threading.Timer` s that will check in on outbox messages</span>
<span class="sd">        msg_counter (:class:`itertools.count`): counter to index our sent messages</span>
<span class="sd">        file_block (:class:`threading.Event`): Event to signal when a file is being received.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctx</span>          <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># Context</span>
    <span class="n">loop</span>         <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># IOLoop</span>
    <span class="n">push_ip</span>      <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># IP to push to</span>
    <span class="n">push_port</span>    <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># Publisher Port</span>
    <span class="n">push_id</span>      <span class="o">=</span> <span class="s2">&quot;&quot;</span>      <span class="c1"># Identity of the Router we push to</span>
    <span class="n">listen_port</span>  <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># Listener Port</span>
    <span class="n">pusher</span>       <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># pusher socket - a dealer socket that connects to other routers</span>
    <span class="n">listener</span>     <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># Listener socket - a router socket to send/recv messages</span>
    <span class="n">logger</span>       <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># Logger....</span>
    <span class="n">log_handler</span>  <span class="o">=</span> <span class="bp">None</span>
    <span class="n">log_formatter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nb">id</span>           <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># What are we known as?</span>
    <span class="n">ip</span>           <span class="o">=</span> <span class="bp">None</span>    <span class="c1"># whatismy</span>
    <span class="n">listens</span>      <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># Dictionary of functions to call for different types of messages</span>
    <span class="n">senders</span>      <span class="o">=</span> <span class="p">{}</span> <span class="c1"># who has sent us stuff (ie. directly connected) and their state if they keep one</span>
    <span class="n">outbox</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Messages that are out with unconfirmed delivery</span>
    <span class="n">timers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of timer threads that will check in on outbox messages</span>
    <span class="n">child</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dict of &#39;to&#39; addressee and the route that should be taken to reach them</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Networking</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Prefs should be passed by the terminal, if not, try to load from default locatio</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip</span><span class="p">()</span>

        <span class="c1"># Setup logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_logging</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_block</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span> <span class="c1"># to wait for file transfer</span>

        <span class="c1"># number messages as we send them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

        <span class="c1"># we have a few builtin listens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;CONFIRM&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_confirm</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Networking.run"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A :class:`zmq.Context` and :class:`tornado.IOLoop` are spawned,</span>
<span class="sd">        the listener and optionally the pusher are instantiated and</span>
<span class="sd">        connected to :meth:`~.Networking.handle_listen` using</span>
<span class="sd">        :meth:`~zmq.eventloop.zmqstream.ZMQStream.on_recv` .</span>

<span class="sd">        The process is kept open by the :class:`tornado.IOLoop` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># init zmq objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="p">()</span>

        <span class="c1"># Our networking topology is treelike:</span>
        <span class="c1"># each Networking object binds one Router to</span>
        <span class="c1"># send and receive messages from its descendants</span>
        <span class="c1"># each Networking object may have one Dealer that</span>
        <span class="c1"># connects it with its antecedents.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;tcp://*:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listen_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="n">ZMQStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">on_recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_listen</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;tcp://{}:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_port</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="o">=</span> <span class="n">ZMQStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">on_recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_listen</span><span class="p">)</span>
            <span class="c1"># TODO: Make sure handle_listen knows how to handle ID-less messages</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting IOLoop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Networking.prepare_message"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.prepare_message">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a message originates with us, a :class:`.Message` class</span>
<span class="sd">        is instantiated, given an ID and the rest of its attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            to (str): The identity of the socket this message is to</span>
<span class="sd">            key (str): The type of message - used to select which method the receiver</span>
<span class="sd">                uses to process this message.</span>
<span class="sd">            value: Any information this message should contain. Can be any type, but</span>
<span class="sd">                must be JSON serializable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">to</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">msg_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;{}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg_num</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;NOREPEAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="Networking.send"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message via our :attr:`~.Networking.listener` , ROUTER socket.</span>

<span class="sd">        Either an already created :class:`.Message` should be passed as `msg`,</span>
<span class="sd">        or at least `to` and `key` must be provided for a new message created</span>
<span class="sd">        by :meth:`~.Networking.prepare_message` .</span>

<span class="sd">        A :class:`threading.Timer` is created to resend the message using</span>
<span class="sd">        :meth:`~.Networking.repeat` unless `repeat` is False.</span>

<span class="sd">        Args:</span>
<span class="sd">            to (str): The identity of the socket this message is to</span>
<span class="sd">            key (str): The type of message - used to select which method the receiver</span>
<span class="sd">                uses to process this message.</span>
<span class="sd">            value: Any information this message should contain. Can be any type, but</span>
<span class="sd">                must be JSON serializable.</span>
<span class="sd">            msg (`.Message`): An already created message.</span>
<span class="sd">            repeat (bool): Should this message be resent if confirmation is not received?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Need either a message or </span><span class="se">\&#39;</span><span class="s1">to</span><span class="se">\&#39;</span><span class="s1"> and </span><span class="se">\&#39;</span><span class="s1">key</span><span class="se">\&#39;</span><span class="s1"> fields.</span><span class="se">\</span>
<span class="s1">                Got</span><span class="se">\n</span><span class="s1">to: {}</span><span class="se">\n</span><span class="s1">key: {}</span><span class="se">\n</span><span class="s1">value: {}</span><span class="se">\n</span><span class="s1">msg: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
            <span class="c1"># we&#39;re sending this ourselves, new message.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_message</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repeat</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;NOREPEAT&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Make sure our message has everything</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message Invalid:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

        <span class="c1"># encode message</span>
        <span class="n">msg_enc</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_enc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message could not be encoded:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">msg_enc</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">),</span> <span class="n">msg_enc</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MESSAGE SENT - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">repeat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">:</span>
            <span class="c1"># add to outbox and spawn timer to resend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="s1">&#39;send&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Networking.push"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">to</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message via our :attr:`~.Networking.pusher` , DEALER socket.</span>

<span class="sd">        Unlike :meth:`~.Networking.send` , `to` is not required. Every message</span>
<span class="sd">        is always sent to :attr:`~.Networking.push_id` . `to` can be included</span>
<span class="sd">        to send a message further up the network tree to a networking object</span>
<span class="sd">        we&#39;re not directly connected to.</span>

<span class="sd">        Either an already created :class:`.Message` should be passed as `msg`,</span>
<span class="sd">        or at least `key` must be provided for a new message created</span>
<span class="sd">        by :meth:`~.Networking.prepare_message` .</span>

<span class="sd">        A :class:`threading.Timer` is created to resend the message using</span>
<span class="sd">        :meth:`~.Networking.repeat` unless `repeat` is False.</span>

<span class="sd">        Args:</span>
<span class="sd">            to (str): The identity of the socket this message is to. If not included,</span>
<span class="sd">                sent to :meth:`~.Networking.push_id` .</span>
<span class="sd">            key (str): The type of message - used to select which method the receiver</span>
<span class="sd">                uses to process this message.</span>
<span class="sd">            value: Any information this message should contain. Can be any type, but</span>
<span class="sd">                must be JSON serializable.</span>
<span class="sd">            msg (`.Message`): An already created message.</span>
<span class="sd">            repeat (bool): Should this message be resent if confirmation is not received?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># send message via the dealer</span>
        <span class="c1"># even though we only have one connection over our dealer,</span>
        <span class="c1"># we still include &#39;to&#39; in case we are sending further upstream</span>
        <span class="c1"># but can push without &#39;to&#39;, just fill in with upstream id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Need either a message or a </span><span class="se">\&#39;</span><span class="s1">key</span><span class="se">\&#39;</span><span class="s1"> field.</span><span class="se">\</span>
<span class="s1">                Got</span><span class="se">\n</span><span class="s1">to: {}</span><span class="se">\n</span><span class="s1">key: {}</span><span class="se">\n</span><span class="s1">value: {}</span><span class="se">\n</span><span class="s1">msg: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_id</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_message</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repeat</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;NOREPEAT&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Make sure our message has everything</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message Invalid:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

        <span class="c1"># encode message</span>
        <span class="n">msg_enc</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_enc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message could not be encoded:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># Even if the message is not to our upstream node, we still send it</span>
        <span class="c1"># upstream because presumably our target is upstream.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_id</span><span class="p">),</span> <span class="n">msg_enc</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MESSAGE PUSHED - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">repeat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;CONFIRM&#39;</span><span class="p">:</span>
            <span class="c1"># add to outbox and spawn timer to resend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Networking.repeat"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.repeat">[docs]</a>    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">send_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by a :class:`threading.Timer` to resend a message that hasn&#39;t</span>
<span class="sd">        been confirmed by its recipient.</span>

<span class="sd">        TTL is decremented, and messages are resent until their TTL is 0.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg_id (str): The ID of our message, the key used to store it</span>
<span class="sd">                in :attr:`~.Networking.outbox` .</span>
<span class="sd">            send_type (&#39;send&#39;, &#39;push&#39;): Should this message be resent with</span>
<span class="sd">                our `listener` (send) or pusher?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle repeated messages</span>
        <span class="c1"># If we still have the message in our outbox...</span>
        <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># TODO: Do we really need this warning? this should be normal behavior...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Republish called for message {}, but missing message&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg_id</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># decrement ttl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">ttl</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># If our TTL is now zero, delete the message and log its failure</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;PUBLISH FAILED {} - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1"># Send the message again</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REPUBLISH {} - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">send_type</span> <span class="o">==</span> <span class="s1">&#39;send&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">),</span> <span class="n">msg</span><span class="o">.</span><span class="n">serialize</span><span class="p">()])</span>
        <span class="k">elif</span> <span class="n">send_type</span> <span class="o">==</span> <span class="s1">&#39;push&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_id</span><span class="p">),</span> <span class="n">msg</span><span class="o">.</span><span class="n">serialize</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Republish called without proper send_type!&#39;</span><span class="p">)</span>

        <span class="c1"># Spawn a thread to check in on our message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="n">send_type</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Networking.l_confirm"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.l_confirm">[docs]</a>    <span class="k">def</span> <span class="nf">l_confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confirm that a message was received.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`): The message we are confirming.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># confirmation that a published message was received</span>
        <span class="c1"># value should be the message id</span>

        <span class="c1"># delete message from outbox if we still have it</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

        <span class="c1"># stop a timer thread if we have it</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">]</span></div>

        <span class="c1">#self.logger.info(&#39;CONFIRMED MESSAGE {}&#39;.format(msg.value))</span>

<div class="viewcode-block" id="Networking.handle_listen"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.handle_listen">[docs]</a>    <span class="k">def</span> <span class="nf">handle_listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upon receiving a message, call the appropriate listen method</span>
<span class="sd">        in a new thread.</span>

<span class="sd">        If the message is :attr:`~.Message.to` us, send confirmation.</span>

<span class="sd">        If the message is not :attr:`~.Message.to` us, attempt to forward it.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (str): JSON :meth:`.Message.serialize` d message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This check is v. fragile, pyzmq has a way of sending the stream along with the message</span>
        <span class="c1">#####################33</span>
        <span class="c1"># Parse the message</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># from our dealer</span>
            <span class="n">send_type</span> <span class="o">=</span> <span class="s1">&#39;dealer&#39;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="o">**</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
            <span class="c1"># from the router</span>
            <span class="n">send_type</span> <span class="o">=</span> <span class="s1">&#39;router&#39;</span>
            <span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># if this message was a multihop message, store the route</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># if this is a new sender, add them to the list</span>
            <span class="k">if</span> <span class="n">sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">senders</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">senders</span><span class="p">[</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># connection pings are blank frames,</span>
            <span class="c1"># respond to let them know we&#39;re alive</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="o">**</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Dont know what this message is:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Check if our listen was sent properly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message failed to validate:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="k">return</span>




        <span class="c1">###################################</span>
        <span class="c1"># Handle the message</span>
        <span class="c1"># if this message has a multihop &#39;to&#39; field, forward it along</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># pop ourselves off the list</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># if the next recipient in the list is our push-parent, push it</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># if this message is to us, just handle it and return</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RECEIVED: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="c1"># Log and spawn thread to respond to listen</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">listen_funk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                <span class="n">listen_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listen_funk</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg</span><span class="p">,))</span>
                <span class="n">listen_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;ERROR: No function could be found for msg id {} with key: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>


            <span class="c1"># send a return message that confirms even if we except</span>
            <span class="c1"># don&#39;t confirm confirmations</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;NOREPEAT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">send_type</span> <span class="o">==</span> <span class="s1">&#39;router&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="s1">&#39;CONFIRM&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">send_type</span> <span class="o">==</span> <span class="s1">&#39;dealer&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="s1">&#39;CONFIRM&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># otherwise, if it&#39;s to someone we know about, send it there</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span>
            <span class="c1"># FIXME UGLY HACK</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">senders</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># otherwise, if we have a pusher, send it there</span>
        <span class="c1"># it&#39;s either for them or some other upstream node we don&#39;t know about</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Message to unconfirmed recipient, attempting to send: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># finally, if there&#39;s something we&#39;re supposed to do, do it</span>
        <span class="c1"># even if the message is not to us,</span>
        <span class="c1"># sometimes we do work en passant to reduce effort doubling</span>
        <span class="c1"># FIXME Seems like a really bad idea.</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">listen_funk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
            <span class="n">listen_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listen_funk</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg</span><span class="p">,))</span>
            <span class="n">listen_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># since we return if it&#39;s to us before, confirm is repeated down here.</span>
        <span class="c1"># FIXME: Inelegant</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;NOREPEAT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">send_type</span> <span class="o">==</span> <span class="s1">&#39;router&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="s1">&#39;CONFIRM&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">send_type</span> <span class="o">==</span> <span class="s1">&#39;dealer&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="s1">&#39;CONFIRM&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Networking.init_logging"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.init_logging">[docs]</a>    <span class="k">def</span> <span class="nf">init_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize logging to a timestamped file in `prefs.LOGDIR` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setup logging</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">LOGDIR</span><span class="p">,</span> <span class="s1">&#39;Networking_Log_{}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestr</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;networking&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> : </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Networking Logging Initiated&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Networking.get_ip"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Networking.get_ip">[docs]</a>    <span class="k">def</span> <span class="nf">get_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find our IP address</span>

<span class="sd">        returns (str): our IPv4 address.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># shamelessly stolen from https://www.w3resource.com/python-exercises/python-basic-exercise-55.php</span>
        <span class="c1"># variables are badly named because this is just a rough unwrapping of what was a monstrous one-liner</span>
        <span class="c1"># (and i don&#39;t really understand how it works)</span>

        <span class="c1"># get ips that aren&#39;t the loopback</span>
        <span class="n">unwrap00</span> <span class="o">=</span> <span class="p">[</span><span class="n">ip</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;127.&quot;</span><span class="p">)][:</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># ??? truly dk</span>
        <span class="n">unwrap01</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;8.8.8.8&#39;</span><span class="p">,</span> <span class="mi">53</span><span class="p">)),</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span>
                     <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)]][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">unwrap2</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="n">unwrap00</span><span class="p">,</span> <span class="n">unwrap01</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">unwrap2</span></div></div>

<div class="viewcode-block" id="Terminal_Networking"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking">[docs]</a><span class="k">class</span> <span class="nc">Terminal_Networking</span><span class="p">(</span><span class="n">Networking</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :class:`~.networking.Networking` object used by :class:`~.Terminal`</span>
<span class="sd">    objects.</span>

<span class="sd">    Spawned without a :attr:`~.Networking.pusher`.</span>

<span class="sd">    **Listens**</span>

<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | Key         | Method                                    | Description                                   |</span>
<span class="sd">    +=============+===========================================+===============================================+</span>
<span class="sd">    | &#39;PING&#39;      | :meth:`~.Terminal_Networking.l_ping`      | We are asked to confirm that we are alive     |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;INIT&#39;      | :meth:`~.Terminal_Networking.l_init`      | Ask all pilots to confirm that they are alive |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;CHANGE&#39;    | :meth:`~.Terminal_Networking.l_change`    | Change a parameter on the Pi                  |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;STOPALL&#39;   | :meth:`~.Terminal_Networking.l_stopall`   | Stop all pilots and plots                     |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;KILL&#39;      | :meth:`~.Terminal_Networking.l_kill`      | Terminal wants us to die :(                   |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;DATA&#39;      | :meth:`~.Terminal_Networking.l_data`      | Stash incoming data from a Pilot              |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;STATE&#39;     | :meth:`~.Terminal_Networking.l_state`     | A Pilot has changed state                     |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;HANDSHAKE&#39; | :meth:`~.Terminal_Networking.l_handshake` | A Pi is telling us it&#39;s alive and its IP      |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | &#39;FILE&#39;      | :meth:`~.Terminal_Networking.l_file`      | The pi needs some file from us                |</span>
<span class="sd">    +-------------+-------------------------------------------+-----------------------------------------------+</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pilots</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            pilots (dict): The :attr:`.Terminal.pilots` dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Terminal_Networking</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># by default terminal doesn&#39;t have a pusher, everything connects to it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Store some prefs values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen_port</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">MSGPORT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;T&#39;</span>

        <span class="c1"># Message dictionary - What method to call for each type of message received by the terminal class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;PING&#39;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">l_ping</span><span class="p">,</span>  <span class="c1"># We are asked to confirm that we are alive</span>
            <span class="s1">&#39;INIT&#39;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">l_init</span><span class="p">,</span>  <span class="c1"># We should ask all the pilots to confirm that they are alive</span>
            <span class="s1">&#39;CHANGE&#39;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">l_change</span><span class="p">,</span>  <span class="c1"># Change a parameter on the Pi</span>
            <span class="s1">&#39;STOPALL&#39;</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">l_stopall</span><span class="p">,</span> <span class="c1"># Stop all pilots and plots</span>
            <span class="s1">&#39;KILL&#39;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">l_kill</span><span class="p">,</span>  <span class="c1"># Terminal wants us to die :(</span>
            <span class="s1">&#39;DATA&#39;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">l_data</span><span class="p">,</span>  <span class="c1"># Stash incoming data from an rpilot</span>
            <span class="s1">&#39;STATE&#39;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">l_state</span><span class="p">,</span>  <span class="c1"># The Pi is confirming/notifying us that it has changed state</span>
            <span class="s1">&#39;HANDSHAKE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_handshake</span><span class="p">,</span> <span class="c1"># initial connection with some initial info</span>
            <span class="s1">&#39;FILE&#39;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">l_file</span><span class="p">,</span>  <span class="c1"># The pi needs some file from us</span>
        <span class="p">})</span>

        <span class="c1"># dictionary that keeps track of our pilots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span> <span class="o">=</span> <span class="n">pilots</span>



    <span class="c1">##########################</span>
    <span class="c1"># Message Handling Methods</span>

<div class="viewcode-block" id="Terminal_Networking.l_ping"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_ping">[docs]</a>    <span class="k">def</span> <span class="nf">l_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We are asked to confirm that we are alive</span>

<span class="sd">        Respond with a blank &#39;STATE&#39; message.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># we are being asked if we&#39;re alive</span>
        <span class="c1"># respond with blank message since the terminal isn&#39;t really stateful</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="s1">&#39;STATE&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Terminal_Networking.l_init"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_init">[docs]</a>    <span class="k">def</span> <span class="nf">l_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ask all pilots to confirm that they are alive</span>

<span class="sd">        Sends a &quot;PING&quot; to everyone in the pilots dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ping all pis that we are expecting given our pilot db</span>
        <span class="c1"># Responses will be handled with l_state so not much needed here</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;PING&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Terminal_Networking.l_change"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_change">[docs]</a>    <span class="k">def</span> <span class="nf">l_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change a parameter on the Pi</span>

<span class="sd">        Warning:</span>
<span class="sd">            Not Implemented</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Should also handle param changes to GUI objects like ntrials, etc.</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Terminal_Networking.l_stopall"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_stopall">[docs]</a>    <span class="k">def</span> <span class="nf">l_stopall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop all pilots and plots</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># let all the pilots and plot objects know that they should stop</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;STOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;P_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="s1">&#39;STOP&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Terminal_Networking.l_kill"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_kill">[docs]</a>    <span class="k">def</span> <span class="nf">l_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminal wants us to die :(</span>

<span class="sd">        Stop the :attr:`.Networking.loop`</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Received kill request&#39;</span><span class="p">)</span>

        <span class="c1"># Stopping the loop should kill the process, as it&#39;s what&#39;s holding us in run()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="Terminal_Networking.l_data"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_data">[docs]</a>    <span class="k">def</span> <span class="nf">l_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stash incoming data from a Pilot</span>

<span class="sd">        Just forward this along to the internal terminal object (&#39;_T&#39;)</span>
<span class="sd">        and a copy to the relevant plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Send through to terminal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;_T&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Send to plot widget, which should be listening to &quot;P_{pilot_name}&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;P_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;pilot&#39;</span><span class="p">]),</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Terminal_Networking.l_state"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_state">[docs]</a>    <span class="k">def</span> <span class="nf">l_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Pilot has changed state.</span>

<span class="sd">        Stash in &#39;state&#39; field of pilot dict and send along to _T</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">][</span><span class="s1">&#39;state&#39;</span><span class="p">]:</span>
                    <span class="c1"># if we&#39;ve already gotten this one, don&#39;t send to terminal</span>
                    <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pilots</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">][</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># Tell the terminal so it can update the pilot_db file</span>
            <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;pilot&#39;</span><span class="p">:</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;_T&#39;</span><span class="p">,</span> <span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

            <span class="c1"># Tell the plot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;P_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">),</span> <span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">senders</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="Terminal_Networking.l_handshake"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_handshake">[docs]</a>    <span class="k">def</span> <span class="nf">l_handshake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Pi is telling us it&#39;s alive and its IP.</span>

<span class="sd">        Send along to _T</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># only rly useful for our terminal object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;_T&#39;</span><span class="p">,</span> <span class="s1">&#39;HANDSHAKE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="Terminal_Networking.l_file"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Terminal_Networking.l_file">[docs]</a>    <span class="k">def</span> <span class="nf">l_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Pilot needs some file from us.</span>

<span class="sd">        Send it back after :meth:`base64.b64encode` ing it.</span>

<span class="sd">        TODO:</span>
<span class="sd">            Split large files into multiple messages...</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`): The value field of the message should contain some</span>
<span class="sd">                relative path to a file contained within `prefs.SOUNDDIR` . eg.</span>
<span class="sd">                `&#39;/songs/sadone.wav&#39;` would return `&#39;os.path.join(prefs.SOUNDDIR/songs.sadone.wav&#39;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The &lt;target&gt; pi has requested some file &lt;value&gt; from us, let&#39;s send it back</span>
        <span class="c1"># This assumes the file is small, if this starts crashing we&#39;ll have to split the message...</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">SOUNDDIR</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
            <span class="c1"># encode in base64 so json doesn&#39;t complain</span>
            <span class="n">file_contents</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">open_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">file_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span><span class="n">file_contents</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;FILE&#39;</span><span class="p">,</span> <span class="n">file_message</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Pilot_Networking"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking">[docs]</a><span class="k">class</span> <span class="nc">Pilot_Networking</span><span class="p">(</span><span class="n">Networking</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :class:`~.networking.Networking` object used by :class:`~.Pilot`</span>
<span class="sd">    objects.</span>

<span class="sd">    Spawned with a :attr:`~.Networking.pusher` connected back to the </span>
<span class="sd">    :class:`~.Terminal` .</span>

<span class="sd">    **Listens**</span>
<span class="sd">    </span>
<span class="sd">    +-------------+-------------------------------------+-----------------------------------------------+</span>
<span class="sd">    | Key         | Method                              | Description                                   |</span>
<span class="sd">    +=============+=====================================+===============================================+</span>
<span class="sd">    | &#39;STATE&#39;     | :meth:`~.Pilot_Networking.l_state`  | Pilot has changed state                       |</span>
<span class="sd">    | &#39;COHERE&#39;    | :meth:`~.Pilot_Networking.l_cohere` | Make sure our data and the Terminal&#39;s match.  |</span>
<span class="sd">    | &#39;PING&#39;      | :meth:`~.Pilot_Networking.l_ping`   | The Terminal wants to know if we&#39;re listening |</span>
<span class="sd">    | &#39;START&#39;     | :meth:`~.Pilot_Networking.l_start`  | We are being sent a task to start             |</span>
<span class="sd">    | &#39;STOP&#39;      | :meth:`~.Pilot_Networking.l_stop`   | We are being told to stop the current task    |</span>
<span class="sd">    | &#39;PARAM&#39;     | :meth:`~.Pilot_Networking.l_change` | The Terminal is changing some task parameter  |</span>
<span class="sd">    | &#39;FILE&#39;      | :meth:`~.Pilot_Networking.l_file`   | We are receiving a file                       |</span>
<span class="sd">    +-------------+-------------------------------------+-----------------------------------------------+</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Pilot has a pusher - connects back to terminal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pusher</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">prefs</span><span class="o">.</span><span class="n">LINEAGE</span> <span class="o">==</span> <span class="s1">&#39;CHILD&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_id</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">PARENTID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_port</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">PARENTPORT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_ip</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">PARENTIP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_id</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_port</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">PUSHPORT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_ip</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">TERMINALIP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">-</span> <span class="bp">False</span>

        <span class="c1"># Store some prefs values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen_port</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">MSGPORT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">NAME</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_id</span> <span class="o">=</span> <span class="s2">&quot;_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Store current mouse ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># store current pi state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># Are we acting as a child right now?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># Are we acting as a parent right now?</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Pilot_Networking</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;STATE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_state</span><span class="p">,</span>  <span class="c1"># Confirm or notify terminal of state change</span>
            <span class="s1">&#39;COHERE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_cohere</span><span class="p">,</span> <span class="c1"># Sending our temporary data table at the end of a run to compare w/ terminal&#39;s copy</span>
            <span class="s1">&#39;PING&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_ping</span><span class="p">,</span>  <span class="c1"># The Terminal wants to know if we&#39;re listening</span>
            <span class="s1">&#39;START&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_start</span><span class="p">,</span>  <span class="c1"># We are being sent a task to start</span>
            <span class="s1">&#39;STOP&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_stop</span><span class="p">,</span>  <span class="c1"># We are being told to stop the current task</span>
            <span class="s1">&#39;PARAM&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_change</span><span class="p">,</span>  <span class="c1"># The Terminal is changing some task parameter</span>
            <span class="s1">&#39;FILE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_file</span><span class="p">,</span>  <span class="c1"># We are receiving a file</span>
            <span class="s1">&#39;CONTINUOUS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_continuous</span><span class="p">,</span> <span class="c1"># we are sending continuous data to the terminal</span>
            <span class="s1">&#39;CHILD&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_child</span><span class="p">,</span>
            <span class="s1">&#39;HANDSHAKE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_noop</span><span class="p">,</span>
            <span class="s1">&#39;CALIBRATE_PORT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_forward</span><span class="p">,</span>
            <span class="s1">&#39;CALIBRATE_RESULT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_forward</span>
        <span class="p">})</span>

    <span class="c1">###########################3</span>
    <span class="c1"># Message/Listen handling methods</span>

<div class="viewcode-block" id="Pilot_Networking.l_noop"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_noop">[docs]</a>    <span class="k">def</span> <span class="nf">l_noop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_state"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_state">[docs]</a>    <span class="k">def</span> <span class="nf">l_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pilot has changed state</span>

<span class="sd">        Stash it and alert the Terminal</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Save locally so we can respond to queries on our own, then push &#39;er on through</span>
        <span class="c1"># Value will just have the state, we want to add our name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">push_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pilot_Networking.l_cohere"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_cohere">[docs]</a>    <span class="k">def</span> <span class="nf">l_cohere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send our local version of the data table so the terminal can double check</span>

<span class="sd">        Warning:</span>
<span class="sd">            Not Implemented</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_ping"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_ping">[docs]</a>    <span class="k">def</span> <span class="nf">l_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The Terminal wants to know our status</span>

<span class="sd">        Push back our current state.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The terminal wants to know if we are alive, respond with our name and IP</span>
        <span class="c1"># don&#39;t bother the pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_start"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_start">[docs]</a>    <span class="k">def</span> <span class="nf">l_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We are being sent a task to start</span>

<span class="sd">        If we need any files, request them.</span>

<span class="sd">        Then send along to the pilot.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`): value will contain a dictionary containing a task</span>
<span class="sd">                description.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span>

        <span class="c1"># TODO: Refactor into a general preflight check.</span>
        <span class="c1"># First make sure we have any sound files that we need</span>
        <span class="k">if</span> <span class="s1">&#39;sounds&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># nested list comprehension to get value[&#39;sounds&#39;][&#39;L/R&#39;][0-n]</span>
            <span class="n">f_sounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">sound</span> <span class="k">for</span> <span class="n">sounds</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;sounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">sound</span> <span class="ow">in</span> <span class="n">sounds</span>
                        <span class="k">if</span> <span class="n">sound</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="s1">&#39;Speech&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f_sounds</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># check to see if we have these files, if not</span>
                <span class="c1">#     def update(self, data):</span>
                <span class="c1">#         &quot;&quot;&quot;</span>
                <span class="c1">#         Args:</span>
                <span class="c1">#             data (:class:`numpy.ndarray`): an x_width x 2 array where</span>
                <span class="c1">#                 column 0 is trial number and column 1 is the value.</span>
                <span class="c1">#         &quot;&quot;&quot;</span>
                <span class="c1">#         # data should come in as an n x 2 array,</span>
                <span class="c1">#         # 0th column - trial number (x), 1st - (y) value</span>
                <span class="c1">#         data = data.astype(np.float)</span>
                <span class="c1">#</span>
                <span class="c1">#         self.series = pd.Series(data[...,1])</span>
                <span class="c1">#         ys = self.series.rolling(self.winsize, min_periods=0).mean().as_matrix()</span>
                <span class="c1">#</span>
                <span class="c1">#         #print(ys)</span>
                <span class="c1">#</span>
                <span class="c1">#         self.curve.setData(data[...,0], ys, fillLevel=0.5), request them</span>
                <span class="k">for</span> <span class="n">sound</span> <span class="ow">in</span> <span class="n">f_sounds</span><span class="p">:</span>
                    <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">SOUNDDIR</span><span class="p">,</span> <span class="n">sound</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                        <span class="c1"># We ask the terminal to send us the file and then wait.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REQUESTING SOUND {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
                        <span class="c1"># wait here to get the sound,</span>
                        <span class="c1"># the receiving thread will set() when we get it.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">file_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">file_block</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># If we&#39;re starting the task as a child, stash relevant params</span>
        <span class="k">if</span> <span class="s1">&#39;child&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;child&#39;</span><span class="p">][</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;child&#39;</span><span class="p">][</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="bp">False</span>


        <span class="c1"># once we make sure we have everything, tell the Pilot to start.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_id</span><span class="p">,</span> <span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_stop"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_stop">[docs]</a>    <span class="k">def</span> <span class="nf">l_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell the pi to stop the task</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_id</span><span class="p">,</span> <span class="s1">&#39;STOP&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_change"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_change">[docs]</a>    <span class="k">def</span> <span class="nf">l_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The terminal is changing a parameter</span>

<span class="sd">        Warning:</span>
<span class="sd">            Not implemented</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Changing some task parameter from the Terminal</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_file"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_file">[docs]</a>    <span class="k">def</span> <span class="nf">l_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We are receiving a file.</span>

<span class="sd">        Decode from b64 and save. Set the file_block.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (:class:`.Message`): value will have &#39;path&#39; and &#39;file&#39;,</span>
<span class="sd">                where the path determines where in `prefs.SOUNDDIR` the</span>
<span class="sd">                b64 encoded &#39;file&#39; will be saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The file should be of the structure {&#39;path&#39;:path, &#39;file&#39;:contents}</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">SOUNDDIR</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
        <span class="c1"># TODO: give Message full deserialization capabilities including this one</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># TODO: Make more specific - only if dir already exists</span>
            <span class="k">pass</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
            <span class="n">open_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SOUND RECEIVED {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]))</span>

        <span class="c1"># If we requested a file, some poor start fn is probably waiting on us</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_block</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_continuous"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_continuous">[docs]</a>    <span class="k">def</span> <span class="nf">l_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;pilot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mouse</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_child"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_child">[docs]</a>    <span class="k">def</span> <span class="nf">l_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Telling our child to run a task.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg ():</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">CHILDID</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pilot_Networking.l_forward"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Pilot_Networking.l_forward">[docs]</a>    <span class="k">def</span> <span class="nf">l_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just forward the message to the pi.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div></div>





<span class="c1">#####################################</span>

<div class="viewcode-block" id="Net_Node"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node">[docs]</a><span class="k">class</span> <span class="nc">Net_Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop in networking object to be given to any sub-object</span>
<span class="sd">    behind some external-facing :class:`.Networking` object.</span>

<span class="sd">    These objects are intended to communicate locally, within a piece of hardware,</span>
<span class="sd">    though not necessarily within the same process.</span>

<span class="sd">    To minimize the complexity of the network topology, Net_Nodes</span>
<span class="sd">    must communicate through a :class:`.Networking` ROUTER, rather than</span>
<span class="sd">    address each other directly.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        context (:class:`zmq.Context`):  zeromq context</span>
<span class="sd">        loop (:class:`tornado.ioloop.IOLoop`): a tornado ioloop</span>
<span class="sd">        sock (:class:`zmq.Socket`): Our DEALER socket.</span>
<span class="sd">        id (str): What are we known as? What do we set our :attr:`~zmq.Socket.identity` as?</span>
<span class="sd">        upstream (str): The identity of the ROUTER socket used by our upstream :class:`.Networking` object.</span>
<span class="sd">        port (int): The port that our upstream ROUTER socket is bound to</span>
<span class="sd">        listens (dict): Dictionary of functions to call for different types of messages. keys match the :attr:`.Message.key`.</span>
<span class="sd">        outbox (dict): Messages that have been sent but have not been confirmed</span>
<span class="sd">        timers (dict): dict of :class:`threading.Timer` s that will check in on outbox messages</span>
<span class="sd">        logger (:class:`logging.Logger`): Used to log messages and network events.</span>
<span class="sd">        log_handler (:class:`logging.FileHandler`): Handler for logging</span>
<span class="sd">        log_formatter (:class:`logging.Formatter`): Formats log entries as::</span>

<span class="sd">            &quot;%(asctime)s %(levelname)s : %(message)s&quot;</span>

<span class="sd">        msg_counter (:class:`itertools.count`): counter to index our sent messages</span>
<span class="sd">        loop_thread (:class:`threading.Thread`): Thread that holds our loop. initialized with `daemon=True`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">upstream</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># ID of router we connect to</span>
    <span class="n">port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">listens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">outbox</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">timers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#connected = False</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">log_handler</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">log_formatter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">loop_thread</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">listens</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            id (str): What are we known as? What do we set our :attr:`~zmq.Socket.identity` as?</span>
<span class="sd">            upstream (str): The identity of the ROUTER socket used by our upstream :class:`.Networking` object.</span>
<span class="sd">            port (int): The port that our upstream ROUTER socket is bound to</span>
<span class="sd">            listens (dict): Dictionary of functions to call for different types of messages.</span>
<span class="sd">                keys match the :attr:`.Message.key`.</span>
<span class="sd">            instance (bool): Should the node try and use the existing zmq context and tornado loop?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>    <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>    <span class="o">=</span> <span class="n">IOLoop</span><span class="p">()</span>

        <span class="c1"># we have a few builtin listens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;CONFIRM&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_confirm</span>
        <span class="p">}</span>
        <span class="c1"># then add the rest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">listens</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upstream</span> <span class="o">=</span> <span class="n">upstream</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

        <span class="c1"># self.connected = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

        <span class="c1"># try to get a logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_logging</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_networking</span><span class="p">()</span>

<div class="viewcode-block" id="Net_Node.init_networking"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.init_networking">[docs]</a>    <span class="k">def</span> <span class="nf">init_networking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates socket, connects to specified port on localhost,</span>
<span class="sd">        and starts the :meth:`~Net_Node.threaded_loop` as a daemon thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="c1">#self.sock.probe_router = 1</span>

        <span class="c1"># net nodes are local only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;tcp://localhost:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

        <span class="c1"># wrap in zmqstreams and start loop thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">ZMQStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">on_recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_listen</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threaded_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

        <span class="c1">#self.connected = True</span>

<div class="viewcode-block" id="Net_Node.threaded_loop"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.threaded_loop">[docs]</a>    <span class="k">def</span> <span class="nf">threaded_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run in a thread, either starts the IOLoop, or if it</span>
<span class="sd">        is already started (ie. running in another thread),</span>
<span class="sd">        breaks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="c1"># loop already started</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="Net_Node.handle_listen"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.handle_listen">[docs]</a>    <span class="k">def</span> <span class="nf">handle_listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upon receiving a message, call the appropriate listen method</span>
<span class="sd">        in a new thread and send confirmation it was received.</span>

<span class="sd">        Note:</span>
<span class="sd">            Unlike :meth:`.Networking.handle_listen` , only the :attr:`.Message.value`</span>
<span class="sd">            is given to listen methods. This was initially intended to simplify these</span>
<span class="sd">            methods, but this might change in the future to unify the messaging system.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (str): JSON :meth:`.Message.serialize` d message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># messages from dealers are single frames because we only have one connected partner</span>
        <span class="c1"># and that&#39;s the dealer spec lol</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="o">**</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check if our listen was sent properly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message failed to validate:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{} - RECEIVED: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

        <span class="c1"># if msg.key == &#39;CONFIRM&#39;:</span>
        <span class="c1">#     if msg.value in self.outbox.keys():</span>
        <span class="c1">#         del self.outbox[msg.value]</span>
        <span class="c1">#</span>
        <span class="c1">#     # stop a timer thread if we have it</span>
        <span class="c1">#     if msg.value in self.timers.keys():</span>
        <span class="c1">#         self.timers[msg.value].cancel()</span>
        <span class="c1">#         del self.timers[msg.value]</span>
        <span class="c1">#</span>
        <span class="c1">#     self.logger.info(&#39;CONFIRMED MESSAGE {}&#39;.format(msg.value))</span>
        <span class="c1"># else:</span>
        <span class="c1"># Log and spawn thread to respond to listen</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># not to us, just keep it going</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">listen_funk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
            <span class="n">listen_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listen_funk</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">,))</span>
            <span class="n">listen_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;MSG ID {} - No listen function found for key: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;NOREPEAT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">:</span>
            <span class="c1"># send confirmation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="s1">&#39;CONFIRM&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Net_Node.send"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message via our :attr:`~.Net_Node.sock` , DEALER socket.</span>

<span class="sd">        `to` is not required. Every message</span>
<span class="sd">        is always sent to :attr:`~.Net_Node.upstream` . `to` can be included</span>
<span class="sd">        to send a message further up the network tree to a networking object</span>
<span class="sd">        we&#39;re not directly connected to.</span>

<span class="sd">        Either an already created :class:`.Message` should be passed as `msg`,</span>
<span class="sd">        or at least `key` must be provided for a new message created</span>
<span class="sd">        by :meth:`~.Net_Node.prepare_message` .</span>

<span class="sd">        A :class:`threading.Timer` is created to resend the message using</span>
<span class="sd">        :meth:`~.Net_Node.repeat` unless `repeat` is False.</span>

<span class="sd">        Args:</span>
<span class="sd">            to (str, list): The identity of the socket this message is to. If not included,</span>
<span class="sd">                sent to :meth:`~.Net_Node.upstream` .</span>
<span class="sd">            key (str): The type of message - used to select which method the receiver</span>
<span class="sd">                uses to process this message.</span>
<span class="sd">            value: Any information this message should contain. Can be any type, but</span>
<span class="sd">                must be JSON serializable.</span>
<span class="sd">            msg (`.Message`): An already created message.</span>
<span class="sd">            repeat (bool): Should this message be resent if confirmation is not received?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># send message via the dealer</span>
        <span class="c1"># even though we only have one connection over our dealer,</span>
        <span class="c1"># we still include &#39;to&#39; in case we are sending further upstream</span>
        <span class="c1"># but can push without &#39;to&#39;, just fill in with upstream id</span>
        <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Push sent without Key&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_message</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repeat</span><span class="p">)</span>

        <span class="c1"># Make sure our message has everything</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message Invalid:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="c1"># encode message</span>
        <span class="n">msg_enc</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_enc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message could not be encoded:</span><span class="se">\n</span><span class="s1">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
            <span class="k">return</span>

   
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream</span><span class="p">),</span> <span class="n">msg_enc</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MESSAGE SENT - {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">repeat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;CONFIRM&quot;</span><span class="p">:</span>
            <span class="c1"># add to outbox and spawn timer to resend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Net_Node.repeat"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.repeat">[docs]</a>    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by a :class:`threading.Timer` to resend a message that hasn&#39;t</span>
<span class="sd">        been confirmed by its recipient.</span>

<span class="sd">        TTL is decremented, and messages are resent until their TTL is 0.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg_id (str): The ID of our message, the key used to store it</span>
<span class="sd">                in :attr:`~.Net_Node.outbox` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle repeated messages</span>
        <span class="c1"># If we still have the message in our outbox...</span>
        <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># TODO: Do we really need this warning? this should be normal behavior...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Republish called for message {}, but missing message&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg_id</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># decrement ttl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">ttl</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1"># If our TTL is now zero, delete the message and log its failure</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;PUBLISH FAILED {} - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span>
            <span class="k">return</span>


        <span class="c1"># Send the message again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REPUBLISH {} - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream</span><span class="p">),</span> <span class="n">msg</span><span class="o">.</span><span class="n">serialize</span><span class="p">()])</span>

        <span class="c1"># Spawn a thread to check in on our message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Net_Node.l_confirm"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.l_confirm">[docs]</a>    <span class="k">def</span> <span class="nf">l_confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confirm that a message was received.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str): The ID of the message we are confirming.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># delete message from outbox if we still have it</span>
        <span class="c1"># msg.value should contain the if of the message that was confirmed</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="c1"># stop a timer thread if we have it</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CONFIRMED MESSAGE {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Net_Node.prepare_message"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.prepare_message">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">repeat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate a :class:`.Message` class, give it an ID and</span>
<span class="sd">        the rest of its attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            to (str): The identity of the socket this message is to</span>
<span class="sd">            key (str): The type of message - used to select which method the receiver</span>
<span class="sd">                uses to process this message.</span>
<span class="sd">            value: Any information this message should contain. Can be any type, but</span>
<span class="sd">                must be JSON serializable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>

        <span class="c1"># if our name is _{something} and our upstream is {something}, replace sender with our upstream node</span>
        <span class="c1"># upstream node should handle all incoming information to those types of nodes</span>
        <span class="c1">#if self.id == &quot;_{}&quot;.format(self.upstream):</span>
        <span class="c1">#    msg.sender = self.upstream</span>
        <span class="c1">#else:</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

        <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">to</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">msg_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;{}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg_num</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;NOREPEAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="Net_Node.init_logging"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Net_Node.init_logging">[docs]</a>    <span class="k">def</span> <span class="nf">init_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize logging to a timestamped file in `prefs.LOGDIR` .</span>

<span class="sd">        The logger name will be `&#39;node.{id}&#39;` .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">LOGDIR</span><span class="p">,</span> <span class="s1">&#39;NetNode_{}_{}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">timestr</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;node.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> : </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{} Logging Initiated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></div></div>



<div class="viewcode-block" id="Message"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message">[docs]</a><span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A formatted message.</span>

<span class="sd">    `id`, `to`, `sender`, and `key` are required attributes,</span>
<span class="sd">    but any other key-value pair passed on init is added to the message&#39;s attributes</span>
<span class="sd">    and included in the message.</span>

<span class="sd">    Can be indexed and set like a dictionary (message[&#39;key&#39;], etc.)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id (str): ID that uniquely identifies a message.</span>
<span class="sd">            format {sender.id}_{number}</span>
<span class="sd">        to (str): ID of socket this message is addressed to</span>
<span class="sd">        sender (str): ID of socket where this message originates</span>
<span class="sd">        key (str): Type of message, used to select a listen method to process it</span>
<span class="sd">        value: Body of message, can be any type but must be JSON serializable.</span>
<span class="sd">        ttl (int): Time-To-Live, each message is sent this many times at max,</span>
<span class="sd">            each send decrements ttl.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: just make serialization handle all attributes except Files which need to be b64 encoded first.</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># number of message, format {sender.id}_{number}</span>
    <span class="n">to</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># value is the only attribute that can be left None,</span>
    <span class="c1"># ie. with signal-type messages like &quot;STOP&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ttl</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># every message starts with 5 retries. only relevant to the sender so not serialized.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># type: (object, object) -&gt; None</span>
        <span class="c1"># Messages don&#39;t need to have all attributes on creation,</span>
        <span class="c1"># but do need them to serialize</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            *args:</span>
<span class="sd">            **kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Messages cannot be constructed with positional arguments&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># type: () -&gt; str</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;FILE&#39;</span><span class="p">:</span>
            <span class="n">me_string</span> <span class="o">=</span> <span class="s2">&quot;ID: {}; TO: {}; SENDER: {}; KEY: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">me_string</span> <span class="o">=</span> <span class="s2">&quot;ID: {}; TO: {}; SENDER: {}; KEY: {}; VALUE: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">me_string</span>

    <span class="c1"># enable dictionary-like behavior</span>
<div class="viewcode-block" id="Message.__getitem__"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message.__getitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="Message.__setitem__"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message.__setitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key:</span>
<span class="sd">            value:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Message.__delitem__"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message.__delitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="Message.__contains__"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message.__contains__">[docs]</a>    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            key:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

<div class="viewcode-block" id="Message.validate"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if `id`, `to`, `sender`, and `key` are all defined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool (True): Does message have all required attributes set?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">valid</span></div>




<div class="viewcode-block" id="Message.serialize"><a class="viewcode-back" href="../../../rpilot.core.networking.html#rpilot.core.networking.Message.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serializes all attributes in `__dict__` using json.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: JSON serialized message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Message invalid at the time of serialization!</span><span class="se">\n</span><span class="s2"> {}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="c1"># msg = {</span>
        <span class="c1">#     &#39;id&#39;: self.id,</span>
        <span class="c1">#     &#39;to&#39;: self.to,</span>
        <span class="c1">#     &#39;sender&#39;: self.sender,</span>
        <span class="c1">#     &#39;key&#39;: self.key,</span>
        <span class="c1">#     &#39;value&#39;: self.value</span>
        <span class="c1"># }</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg_enc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg_enc</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></div></div>















































</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Jonny Saunders.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>