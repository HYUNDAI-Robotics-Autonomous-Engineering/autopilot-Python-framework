


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>autopilot.core.subject &mdash; Autopilot 0.3.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="docs.auto-pi-lot.com_modules/autopilot/core/subject.html"/>
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/autopilot_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/restyle.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/autopilot_sass.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/autopilot_sass.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

    <link href="https://fonts.googleapis.com/css?family=Cutive+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Dosis&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lexend+Deca&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="_static/css/autopilot_sass.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.2.0/anime.min.js" integrity="sha256-BuxrUdr/4YoztQLxT6xmdO6hSQw2d6BtBUY1pteGds4=" crossorigin="anonymous"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Autopilot
          

          
            
            <img src="../../../_static/autopilot_logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.overview.html#program-structure">Program Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.overview.html#tasks">Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.overview.html#module-tour">Module Tour</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.installation.pilot.html">Pilot Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.pilot.html#scripted-installation">Scripted Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.pilot.html#manual-preinstall">Manual Preinstall</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#rasbian-installation">Rasbian Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#raspbian-performance-improvements">Raspbian Performance Improvements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#audio-setup">Audio Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#video-setup">Video Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#optional-installation-steps">Optional Installation Steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.installation.terminal.html">Terminal Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.terminal.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.terminal.html#scripted-terminal-setup">Scripted Terminal Setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.training.html">Training a Subject</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#connecting-the-pilot">Connecting the Pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#creating-a-protocol">Creating a Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.training.html#using-the-protocol-wizard">Using the Protocol Wizard</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.training.html#manual-protocol-creation">Manual Protocol Creation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#creating-a-subject">Creating a Subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#running-the-task">Running the Task</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#debugging-a-task">Debugging a Task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.task.html">Writing a Task</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.task.html#the-nafc-task">The Nafc Task</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#the-task-class">The <code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code> class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#four-task-attributes">Four Task Attributes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#params">PARAMS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#data">Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#plot">PLOT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#hardware">HARDWARE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#stage-methods">Stage Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#request">Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#discrim">Discrim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#reinforcement">Reinforcement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#additional-methods">Additional Methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.task.html#distributed-go-no-go-using-child-agents">Distributed Go/No-Go - Using Child Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#additional-prefs">Additional Prefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#go-no-go-parameterization">Go/No-Go Parameterization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#id5">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#the-child-task">The Child Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#a-very-smart-wheel">A Very Smart Wheel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#go-no-go-stage-methods">Go/No-Go Stage Methods</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.hardware.html">Writing a Hardware Class</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.hardware.html#gpio-with-pigpio">GPIO with pigpio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.hardware.html#input-beambreak">Input - Beambreak</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.hardware.html#output-led-rgb">Output - LED_RGB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.hardware.html#usb-hardware-with-inputs">USB Hardware with inputs</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.core.html">Core Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.gui.html">gui</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.networking.html">networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.pilot.html">pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.plots.html">plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.styles.html">styles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.subject.html">subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.terminal.html">terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.hardware.html">Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.cameras.html">cameras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.gpio.html">gpio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.i2c.html">i2c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.usb.html">usb</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.tasks.html">Tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.children.html">children</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.free_water.html">free_water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.graduation.html">graduation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.nafc.html">nafc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.task.html">task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.stim.html">Stimuli</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.stim.managers.html">managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.stim.sound.html">sound</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../autopilot.stim.sound.jackclient.html">jackclient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autopilot.stim.sound.pyoserver.html">pyoserver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autopilot.stim.sound.sounds.html">sounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.viz.html">Visualization Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.viz.trial_viewer.html">trial_viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.viz.psychometric.html">psychometric</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.setup.html">Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.setup.setup_pilot.html">setup_pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.setup.setup_scale.html">setup_scale</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.setup.setup_terminal.html">setup_terminal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.prefs.html">Prefs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.external.html">External</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/autopilot-users">Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todo.html">To-Do</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#visions">Visions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../todo.html#integrations">Integrations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../todo.html#roadmap-deeplabcut-integration">DeepLabCut Integration<span><a href="https://groups.google.com/forum/#!topic/autopilot-users/T-PNfrHDtzA" class="roadmap-dblink">priority: high | discuss>></a></span></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../todo.html#roadmap-open-ephys-integration">Open Ephys Integration<span><a href="https://google.com" class="roadmap-dblink">priority: medium | discuss>></a></span></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../todo.html#roadmap-bonsai-integration">Bonsai Integration<span><a href="https://google.com" class="roadmap-dblink">priority: low | discuss>></a></span></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../todo.html#closed-loop-behavior-processing-pipelines">Closed-Loop Behavior &amp; Processing Pipelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#improvements">Improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#bugs">Bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#completed">Completed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#lowest-priority">Lowest Priority</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog/index.html#version-0-3">Version 0.3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog/v0.3.0.html">v0.3.0 (March 3rd, 2020)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#major-updates">Major Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#minor-updates">Minor Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#new-features">New Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#bugfixes">Bugfixes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#code-structure">Code Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#external-libraries">External Libraries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog/index.html#version-0-2">Version 0.2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog/v0.2.0.html">v0.2.0 (October 26, 2019)</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Autopilot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>autopilot.core.subject</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for autopilot.core.subject</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Classes for managing data and protocol access and storage.</span>

<span class="sd">Currently named subject, but will likely be refactored to include other data</span>
<span class="sd">models should the need arise.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO: store pilot in biography</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">from</span> <span class="nn">tables.nodes</span> <span class="kn">import</span> <span class="n">filenode</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
<span class="kn">from</span> <span class="nn">autopilot.tasks</span> <span class="kn">import</span> <span class="n">GRAD_LIST</span><span class="p">,</span> <span class="n">TASK_LIST</span>
<span class="kn">from</span> <span class="nn">autopilot</span> <span class="kn">import</span> <span class="n">prefs</span>
<span class="kn">from</span> <span class="nn">autopilot.stim.sound.sounds</span> <span class="kn">import</span> <span class="n">STRING_PARAMS</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">queue</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="k">as</span> <span class="nn">queue</span>

<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="Subject"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject">[docs]</a><span class="k">class</span> <span class="nc">Subject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for managing one subject&#39;s data and protocol.</span>

<span class="sd">    Creates a :mod:`tables` hdf5 file in `prefs.DATADIR` with the general structure::</span>

<span class="sd">        / root</span>
<span class="sd">        |--- current (tables.filenode) storing the current task as serialized JSON</span>
<span class="sd">        |--- data (group)</span>
<span class="sd">        |    |--- task_name  (group)</span>
<span class="sd">        |         |--- S##_step_name</span>
<span class="sd">        |         |    |--- trial_data</span>
<span class="sd">        |         |    |--- continuous_data</span>
<span class="sd">        |         |--- ...</span>
<span class="sd">        |--- history (group)</span>
<span class="sd">        |    |--- hashes - history of git commit hashes</span>
<span class="sd">        |    |--- history - history of changes: protocols assigned, params changed, etc.</span>
<span class="sd">        |    |--- weights - history of pre and post-task weights</span>
<span class="sd">        |    |--- past_protocols (group) - stash past protocol params on reassign</span>
<span class="sd">        |         |--- date_protocol_name - tables.filenode of a previous protocol&#39;s params.</span>
<span class="sd">        |         |--- ...</span>
<span class="sd">        |--- info - group with biographical information as attributes</span>

<span class="sd">    Attributes:</span>
<span class="sd">        lock (:class:`threading.Lock`): manages access to the hdf5 file</span>
<span class="sd">        name (str): Subject ID</span>
<span class="sd">        file (str): Path to hdf5 file - usually `{prefs.DATADIR}/{self.name}.h5`</span>
<span class="sd">        current (dict): current task parameters. loaded from</span>
<span class="sd">            the &#39;current&#39; :mod:`~tables.filenode` of the h5 file</span>
<span class="sd">        step (int): current step</span>
<span class="sd">        protocol_name (str): name of currently assigned protocol</span>
<span class="sd">        current_trial (int): number of current trial</span>
<span class="sd">        running (bool): Flag that signals whether the subject is currently running a task or not.</span>
<span class="sd">        data_queue (:class:`queue.Queue`): Queue to dump data while running task</span>
<span class="sd">        thread (:class:`threading.Thread`): thread used to keep file open while running task</span>
<span class="sd">        did_graduate (:class:`threading.Event`): Event used to signal if the subject has graduated the current step</span>
<span class="sd">        STRUCTURE (list): list of tuples with order:</span>

<span class="sd">            * full path, eg. &#39;/history/weights&#39;</span>
<span class="sd">            * relative path, eg. &#39;/history&#39;</span>
<span class="sd">            * name, eg. &#39;weights&#39;</span>
<span class="sd">            * type, eg. :class:`.Subject.Weight_Table` or &#39;group&#39;</span>

<span class="sd">        node locations (eg. &#39;/data&#39;) to types, either &#39;group&#39; for groups or a</span>
<span class="sd">            :class:`tables.IsDescriptor` for tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">biography</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            name (str): subject ID</span>
<span class="sd">            dir (str): path where the .h5 file is located, if `None`, `prefs.DATADIR` is used</span>
<span class="sd">            file (str): load a subject from a filename. if `None`, ignored.</span>
<span class="sd">            new (bool): if True, a new file is made (a new file is made if one does not exist anyway)</span>
<span class="sd">            biography (dict): If making a new subject file, a dictionary with biographical data can be passed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">STRUCTURE</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/hashes&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;hashes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hash_Table</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/history&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">History_Table</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/weights&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Weight_Table</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/history/past_protocols&#39;</span><span class="p">,</span> <span class="s1">&#39;/history&#39;</span><span class="p">,</span> <span class="s1">&#39;past_protocols&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/info&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># use a filter to compress continuous data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continuous_filter</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">dir</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">DATADIR</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="p">:</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Need to either have a name or a file, how else would we find the .h5 file?&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;no file was found at passed file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;file passed, but so was name, defaulting to using name + dir&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_subject_file</span><span class="p">(</span><span class="n">biography</span><span class="p">)</span>

        <span class="c1"># before we open, make sure we have the stuff we need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_structure</span><span class="p">()</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;No Name attribute saved, trying to recover from filename&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>



        <span class="c1"># If subject has a protocol, load it to a dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;/current&quot;</span> <span class="ow">in</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="c1"># We load the info from &#39;current&#39; but don&#39;t keep the node open</span>
            <span class="c1"># Stash it as a dict so better access from Python</span>
            <span class="n">current_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">open_node</span><span class="p">(</span><span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">protocol_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;protocol_name&#39;</span><span class="p">]</span>

        <span class="c1"># get last session number if we have it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># We will get handles to trial and continuous data when we start running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span>  <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Is the subject currently running (ie. we expect data to be incoming)</span>
        <span class="c1"># Used to keep the subject object alive, otherwise we close the file whenever we don&#39;t need it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># We use a threading queue to dump data into a kept-alive h5f file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">did_graduate</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Every time we are initialized we stash the git hash</span>
        <span class="n">history_row</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hashes</span><span class="o">.</span><span class="n">row</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">HASH</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">history_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

        <span class="c1"># we have to always open and close the h5f</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

<div class="viewcode-block" id="Subject.open_hdf"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.open_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">open_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the hdf5 file.</span>

<span class="sd">        This should be called at the start of every method that access the h5 file</span>
<span class="sd">        and :meth:`~.Subject.close_hdf` should be called at the end. Otherwise</span>
<span class="sd">        the file will close and we risk file corruption.</span>

<span class="sd">        See the pytables docs</span>
<span class="sd">        `here &lt;https://www.pytables.org/cookbook/threading.html&gt;`_ and</span>
<span class="sd">        `here &lt;https://www.pytables.org/FAQ.html#can-pytables-be-used-in-concurrent-access-scenarios&gt;`_</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (str): a file access mode, can be:</span>

<span class="sd">                * &#39;r&#39;: Read-only - no data can be modified.</span>
<span class="sd">                * &#39;w&#39;: Write - a new file is created (an existing file with the same name would be deleted).</span>
<span class="sd">                * &#39;a&#39; Append - an existing file is opened for reading and writing, and if the file does not exist it is created.</span>
<span class="sd">                * &#39;r+&#39; (default) - Similar to &#39;a&#39;, but file must already exist.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`tables.File`: Opened hdf file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use a decorator around methods instead of explicitly calling</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.close_hdf"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.close_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">close_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5f</span><span class="p">):</span>
        <span class="c1"># type: (tables.file.File) -&gt; None</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes &amp; closes the open hdf file.</span>
<span class="sd">        Must be called whenever :meth:`~.Subject.open_hdf` is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            h5f (:class:`tables.File`): the hdf file opened by :meth:`~.Subject.open_hdf`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">h5f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Subject.new_subject_file"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.new_subject_file">[docs]</a>    <span class="k">def</span> <span class="nf">new_subject_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">biography</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new subject file and make the general filestructure.</span>

<span class="sd">        If a file already exists, open it in append mode, otherwise create it.</span>

<span class="sd">        Args:</span>
<span class="sd">            biography (dict): Biographical details like DOB, mass, etc.</span>
<span class="sd">                Typically created by :class:`~.gui.New_Subject_Wizard.Biography_Tab`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If a file already exists, we open it for appending so we don&#39;t lose data.</span>
        <span class="c1"># For now we are assuming that the existing file has the basic structure,</span>
        <span class="c1"># but that&#39;s probably a bad assumption for full reliability</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
            <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Make Basic file structure</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="s2">&quot;Trial Record Data&quot;</span><span class="p">)</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="s2">&quot;Biographical Info&quot;</span><span class="p">)</span>
            <span class="n">history_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;history&quot;</span><span class="p">,</span><span class="s2">&quot;History&quot;</span><span class="p">)</span>

            <span class="c1"># When a whole protocol is changed, we stash the old protocol as a filenode in the past_protocols group</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/history&quot;</span><span class="p">,</span> <span class="s2">&quot;past_protocols&quot;</span><span class="p">,</span><span class="s1">&#39;Past Protocol Files&#39;</span><span class="p">)</span>

            <span class="c1"># Also canonical to the basic file structure is the &#39;current&#39; filenode which stores the current protocol,</span>
            <span class="c1"># but since we want to be able to tell that a protocol hasn&#39;t been assigned yet we don&#39;t instantiate it here</span>
            <span class="c1"># See http://www.pytables.org/usersguide/filenode.html</span>
            <span class="c1"># filenode.new_node(h5f, where=&quot;/&quot;, name=&quot;current&quot;)</span>

            <span class="c1"># We keep track of changes to parameters, promotions, etc. in the history table</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">history_group</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">History_Table</span><span class="p">,</span> <span class="s2">&quot;Change History&quot;</span><span class="p">)</span>

            <span class="c1"># Make table for weights</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">history_group</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Weight_Table</span><span class="p">,</span> <span class="s2">&quot;Subject Weights&quot;</span><span class="p">)</span>

            <span class="c1"># And another table to stash the git hash every time we&#39;re open.</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">history_group</span><span class="p">,</span> <span class="s1">&#39;hashes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hash_Table</span><span class="p">,</span> <span class="s2">&quot;Git commit hash history&quot;</span><span class="p">)</span>

        <span class="c1"># Save biographical information as node attributes</span>
        <span class="k">if</span> <span class="n">biography</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">biography</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.ensure_structure"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.ensure_structure">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that our h5f has the appropriate baseline structure as defined in `self.STRUCTURE`</span>

<span class="sd">        Checks that all groups and tables are made, makes them if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRUCTURE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                <span class="c1">#pdb.set_trace()</span>
                <span class="c1"># try to make it</span>
                <span class="c1"># python 3 compatibility</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
                            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
                        <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

                <span class="c1"># python 2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
                            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
                        <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Subject.update_biography"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.update_biography">[docs]</a>    <span class="k">def</span> <span class="nf">update_biography</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change or make a new biographical attribute, stored as</span>
<span class="sd">        attributes of the `info` group.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (dict): biographical attributes to be updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.update_history"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.update_history">[docs]</a>    <span class="k">def</span> <span class="nf">update_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the history table when changes are made to the subject&#39;s protocol.</span>

<span class="sd">        The current protocol is flushed to the past_protocols group and an updated</span>
<span class="sd">        filenode is created.</span>

<span class="sd">        Note:</span>
<span class="sd">            This **only** updates the history table, and does not make the changes itself.</span>

<span class="sd">        Args:</span>
<span class="sd">            type (str): What type of change is being made? Can be one of</span>

<span class="sd">                * &#39;param&#39; - a parameter of one task stage</span>
<span class="sd">                * &#39;step&#39; - the step of the current protocol</span>
<span class="sd">                * &#39;protocol&#39; - the whole protocol is being updated.</span>

<span class="sd">            name (str): the name of either the parameter being changed or the new protocol</span>
<span class="sd">            value (str): the value that the parameter or step is being changed to,</span>
<span class="sd">                or the protocol dictionary flattened to a string.</span>
<span class="sd">            step (int): When type is &#39;param&#39;, changes the parameter at a particular step,</span>
<span class="sd">                otherwise the current step is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure the updates are written to the subject file</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;param&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">step</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">step</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_current</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_current</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;protocol&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_current</span><span class="p">()</span>


        <span class="c1"># Check that we&#39;re all strings in here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># log the change</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">history_row</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">row</span>

        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">history_row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">history_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>


    <span class="c1"># def update_params(self, param, value):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Args:</span>
    <span class="c1">#         param:</span>
    <span class="c1">#         value:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # TODO: this</span>
    <span class="c1">#     pass</span>

<div class="viewcode-block" id="Subject.assign_protocol"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.assign_protocol">[docs]</a>    <span class="k">def</span> <span class="nf">assign_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">step_n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign a protocol to the subject.</span>

<span class="sd">        If the subject has a currently assigned task, stashes it with :meth:`~.Subject.stash_current`</span>

<span class="sd">        Creates groups and tables according to the data descriptions in the task class being assigned.</span>
<span class="sd">        eg. as described in :class:`.Task.TrialData`.</span>

<span class="sd">        Updates the history table.</span>

<span class="sd">        Args:</span>
<span class="sd">            protocol (str): the protocol to be assigned. Can be one of</span>

<span class="sd">                * the name of the protocol (its filename minus .json) if it is in `prefs.PROTOCOLDIR`</span>
<span class="sd">                * filename of the protocol (its filename with .json) if it is in the `prefs.PROTOCOLDIR`</span>
<span class="sd">                * the full path and filename of the protocol.</span>

<span class="sd">            step_n (int): Which step is being assigned?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Protocol will be passed as a .json filename in prefs.PROTOCOLDIR</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="c1">## Assign new protocol</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>

        <span class="c1"># try prepending the protocoldir if we were passed just the name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
            <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">PROTOCOLDIR</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fullpath</span><span class="p">):</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find either </span><span class="si">{}</span><span class="s1"> or </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">))</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="n">fullpath</span>

        <span class="c1"># Set name and step</span>
        <span class="c1"># Strip off path and extension to get the protocol name</span>
        <span class="n">protocol_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">protocol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Load protocol to dict</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="k">as</span> <span class="n">protocol_file</span><span class="p">:</span>
            <span class="n">prot_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">protocol_file</span><span class="p">)</span>

        <span class="c1"># Check if there is an existing protocol, archive it if there is.</span>
        <span class="k">if</span> <span class="s2">&quot;/current&quot;</span> <span class="ow">in</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">protocol_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">prot_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stash_current</span><span class="p">()</span>
            <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="c1"># Make filenode and save as serialized json</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">new_node</span><span class="p">(</span><span class="n">h5f</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prot_dict</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># save some protocol attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">prot_dict</span>

        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;protocol_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="n">protocol_name</span>

        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_n</span><span class="p">)</span>

        <span class="c1"># always start out on session 0 on a new task</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Make file group for protocol</span>
        <span class="k">if</span> <span class="s2">&quot;/data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">protocol_name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="n">current_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">protocol_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">protocol_name</span><span class="p">)</span>


        <span class="c1"># Create groups for each step</span>
        <span class="c1"># There are two types of data - continuous and trialwise.</span>
        <span class="c1"># Each gets a single table within a group: since each step should have</span>
        <span class="c1"># consistent data requirements over time and hdf5 doesn&#39;t need to be in</span>
        <span class="c1"># memory, we can just keep appending to keep things simple.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># First we get the task class for this step</span>
            <span class="n">task_class</span> <span class="o">=</span> <span class="n">TASK_LIST</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]]</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>
            <span class="c1"># group name is S##_&#39;step_name&#39;</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;S</span><span class="si">{:02d}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_group</span><span class="p">:</span>
                <span class="n">step_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">current_group</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step_group</span> <span class="o">=</span> <span class="n">current_group</span><span class="o">.</span><span class="n">_f_get_child</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>

            <span class="c1"># The task class *should* have at least one PyTables DataTypes descriptor</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="s2">&quot;TrialData&quot;</span><span class="p">):</span>
                    <span class="n">trial_descriptor</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">TrialData</span>
                    <span class="c1"># add a session column, everyone needs a session column</span>
                    <span class="k">if</span> <span class="s1">&#39;session&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()})</span>
                    <span class="c1"># same thing with trial_num</span>
                    <span class="k">if</span> <span class="s1">&#39;trial_num&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;trial_num&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()})</span>
                    <span class="c1"># if this task has sounds, make columns for them</span>
                    <span class="c1"># TODO: Make stim managers return a list of properties for their sounds</span>
                    <span class="k">if</span> <span class="s1">&#39;stim&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;manager&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># managers have stim nested within groups, but this is still really ugly</span>
                            <span class="n">sound_params</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">side</span><span class="p">,</span> <span class="n">sounds</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;sounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="k">for</span> <span class="n">sound</span> <span class="ow">in</span> <span class="n">sounds</span><span class="p">:</span>
                                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sound</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">STRING_PARAMS</span><span class="p">:</span>
                                                <span class="n">sound_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">sound_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
                            <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sound_params</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="s1">&#39;sounds&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># for now we just assume they&#39;re floats</span>
                            <span class="n">sound_params</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">side</span><span class="p">,</span> <span class="n">sounds</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;sounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="c1"># each side has a list of sounds</span>
                                <span class="k">for</span> <span class="n">sound</span> <span class="ow">in</span> <span class="n">sounds</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sound</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">STRING_PARAMS</span><span class="p">:</span>
                                            <span class="n">sound_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">sound_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
                            <span class="n">trial_descriptor</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sound_params</span><span class="p">)</span>

                    <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">step_group</span><span class="p">,</span> <span class="s2">&quot;trial_data&quot;</span><span class="p">,</span> <span class="n">trial_descriptor</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">NodeError</span><span class="p">:</span>
                <span class="c1"># we already have made this table, that&#39;s fine</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if we have continuous data, make a folder for each data stream.</span>
                <span class="c1"># each session will make its own subfolder,</span>
                <span class="c1"># which contains tables for each of the streams for that session</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="s2">&quot;ContinuousData&quot;</span><span class="p">):</span>
                    <span class="n">cont_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">step_group</span><span class="p">,</span> <span class="s2">&quot;continuous_data&quot;</span><span class="p">)</span>

                    <span class="c1"># save data names as attributes</span>
                    <span class="n">data_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">task_class</span><span class="o">.</span><span class="n">ContinuousData</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                    <span class="n">cont_group</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_names</span>
                    <span class="c1">#cont_descriptor = task_class.ContinuousData</span>
                    <span class="c1">#cont_descriptor.columns.update({&#39;session&#39;: tables.Int32Col()})</span>
                    <span class="c1">#h5f.create_table(step_group, &quot;continuous_data&quot;, cont_descriptor)</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">NodeError</span><span class="p">:</span>
                <span class="c1"># already made it</span>
                <span class="k">pass</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

        <span class="c1"># Update history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="n">protocol_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.flush_current"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.flush_current">[docs]</a>    <span class="k">def</span> <span class="nf">flush_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes the &#39;current&#39; attribute in the subject object to the current filenode</span>
<span class="sd">        in the .h5</span>

<span class="sd">        Used to make sure the stored .json representation of the current task stays up to date</span>
<span class="sd">        with the params set in the subject object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="s1">&#39;/current&#39;</span><span class="p">)</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">new_node</span><span class="p">(</span><span class="n">h5f</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="n">current_node</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;protocol_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.stash_current"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.stash_current">[docs]</a>    <span class="k">def</span> <span class="nf">stash_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the current protocol in the history group and delete the node</span>

<span class="sd">        Typically this is called when assigning a new protocol.</span>

<span class="sd">        Stored as the date that it was changed followed by its name if it has one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protocol_name</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/current&#39;</span><span class="p">,</span> <span class="s1">&#39;protocol_name&#39;</span><span class="p">)</span>
            <span class="n">archive_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">protocol_name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;protocol_name attribute couldn&#39;t be accessed, using timestamp to stash protocol&quot;</span><span class="p">)</span>
            <span class="n">archive_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># TODO: When would we want to prefer the .h5f copy over the live one?</span>
        <span class="c1">#current_node = filenode.open_node(h5f.root.current)</span>
        <span class="c1">#old_protocol = current_node.readall()</span>

        <span class="n">archive_node</span> <span class="o">=</span> <span class="n">filenode</span><span class="o">.</span><span class="n">new_node</span><span class="p">(</span><span class="n">h5f</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;/history/past_protocols&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">archive_name</span><span class="p">)</span>
        <span class="n">archive_node</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">h5f</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="s1">&#39;/current&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.prepare_run"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.prepare_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the Subject object to receive data while running the task.</span>

<span class="sd">        Gets information about current task, trial number,</span>
<span class="sd">        spawns :class:`~.tasks.graduation.Graduation` object,</span>
<span class="sd">        spawns :attr:`~.Subject.data_queue` and calls :meth:`~.Subject.data_thread`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: the parameters for the current step, with subject id, step number,</span>
<span class="sd">                current trial, and session number included.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trial_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cont_table</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="c1"># Get current task parameters and handles to tables</span>
        <span class="n">task_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">]</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>

        <span class="c1"># file structure is &#39;/data/protocol_name/##_step_name/tables&#39;</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/</span><span class="si">{}</span><span class="s2">/S</span><span class="si">{:02d}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
        <span class="c1">#try:</span>
        <span class="n">trial_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;trial_data&#39;</span><span class="p">)</span>
        <span class="c1">#self.trial_row = self.trial_table.row</span>
        <span class="c1">#self.trial_keys = self.trial_table.colnames</span>

        <span class="c1"># get last trial number and session</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">trial_num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># should have gotten session from current node when we started</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># try:</span>
        <span class="c1">#     self.session = trial_table.cols.session[-1]+1</span>
        <span class="c1"># except IndexError:</span>
        <span class="c1">#     self.session = 0</span>

        <span class="c1"># prepare continuous data group and tables</span>
        <span class="n">task_class</span> <span class="o">=</span> <span class="n">TASK_LIST</span><span class="p">[</span><span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]]</span>
        <span class="n">cont_group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="s1">&#39;ContinuousData&#39;</span><span class="p">):</span>

            <span class="n">cont_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;continuous_data&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">cont_group</span><span class="p">,</span> <span class="s2">&quot;session_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">tables</span><span class="o">.</span><span class="n">NodeError</span><span class="p">:</span>
                <span class="n">session_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">cont_group</span><span class="p">,</span> <span class="s2">&quot;session_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>

            <span class="c1"># don&#39;t create arrays for each dtype here, we will create them as we receive data</span>

        <span class="c1"># try:</span>
        <span class="c1">#     #cont_table = h5f.get_node(group_name, &#39;continuous_data&#39;)</span>
        <span class="c1">#     #self.cont_row   = self.cont_table.row</span>
        <span class="c1">#     #self.cont_keys  = self.cont_table.colnames</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">cont_group</span><span class="p">,</span> <span class="n">trial_table</span><span class="p">]):</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No data tables exist for step </span><span class="si">{}</span><span class="s2">! Is there a Trial or Continuous data descriptor in the task class?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>
        <span class="c1"># TODO: Spawn graduation checking object!</span>
        <span class="k">if</span> <span class="s1">&#39;graduation&#39;</span> <span class="ow">in</span> <span class="n">task_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">grad_type</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;graduation&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">grad_params</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;graduation&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># add other params asked for by the task class</span>
            <span class="n">grad_obj</span> <span class="o">=</span> <span class="n">GRAD_LIST</span><span class="p">[</span><span class="n">grad_type</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">:</span>
                <span class="c1"># these are params that should be set in the protocol settings</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">PARAMS</span><span class="p">:</span>
                    <span class="c1">#if param not in grad_params.keys():</span>
                    <span class="c1"># for now, try to find it in our attributes</span>
                    <span class="c1"># TODO: See where else we would want to get these from</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
                        <span class="n">grad_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">param</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)})</span>

            <span class="k">if</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">COLS</span><span class="p">:</span>
                <span class="c1"># these are columns in our trial table</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">grad_obj</span><span class="o">.</span><span class="n">COLS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">grad_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)})</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Graduation object requested column </span><span class="si">{}</span><span class="s1">, but it was not found in the trial table&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>

            <span class="c1">#grad_params[&#39;value&#39;][&#39;current_trial&#39;] = str(self.current_trial) # str so it&#39;s json serializable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span> <span class="o">=</span> <span class="n">grad_obj</span><span class="p">(</span><span class="o">**</span><span class="n">grad_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">did_graduate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

        <span class="c1"># spawn thread to accept data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># return a task parameter dictionary</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">])</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;current_trial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_trial</span><span class="p">)</span>
        <span class="n">task</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Subject.data_thread"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.data_thread">[docs]</a>    <span class="k">def</span> <span class="nf">data_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thread that keeps hdf file open and receives data while task is running.</span>

<span class="sd">        receives data through :attr:`~.Subject.queue` as dictionaries. Data can be</span>
<span class="sd">        partial-trial data (eg. each phase of a trial) as long as the task returns a dict with</span>
<span class="sd">        &#39;TRIAL_END&#39; as a key at the end of each trial.</span>

<span class="sd">        each dict given to the queue should have the `trial_num`, and this method can</span>
<span class="sd">        properly store data without passing `TRIAL_END` if so. I recommend being explicit, however.</span>

<span class="sd">        Checks graduation state at the end of each trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            queue (:class:`queue.Queue`): passed by :meth:`~.Subject.prepare_run` and used by other</span>
<span class="sd">                objects to pass data to be stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>

        <span class="n">task_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">]</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">task_params</span><span class="p">[</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>

        <span class="c1"># file structure is &#39;/data/protocol_name/##_step_name/tables&#39;</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/</span><span class="si">{}</span><span class="s2">/S</span><span class="si">{:02d}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
        <span class="c1">#try:</span>
        <span class="n">trial_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;trial_data&#39;</span><span class="p">)</span>
        <span class="n">trial_keys</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">colnames</span>
        <span class="n">trial_row</span> <span class="o">=</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">row</span>

        <span class="c1"># try to get continuous data table if any</span>
        <span class="n">cont_data</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="n">cont_tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cont_rows</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">continuous_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="s1">&#39;continuous_data&#39;</span><span class="p">)</span>
            <span class="n">session_group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">continuous_group</span><span class="p">,</span> <span class="s1">&#39;session_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>
            <span class="n">cont_data</span> <span class="o">=</span> <span class="n">continuous_group</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>


            <span class="n">cont_tables</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cont_rows</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1">#continuous_keys  = continuous_table.colnames</span>
            <span class="c1">#continous_row    = continuous_table.row</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">continuous_table</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># start getting data</span>
        <span class="c1"># stop when &#39;END&#39; gets put in the queue</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
            <span class="c1"># wrap everything in try because this thread shouldn&#39;t crash</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if we get continuous data, this should be simple because we always get a whole row</span>
                <span class="c1"># there must be a more elegant way to check if something is a key and it is true...</span>
                <span class="c1"># yet here we are</span>
                <span class="k">if</span> <span class="s1">&#39;continuous&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># if this isn&#39;t data that we&#39;re expecting, ignore it</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cont_data</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># if we haven&#39;t made a table yet, do it</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cont_tables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># make atom for this data</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># if it&#39;s a numpy array...</span>
                                <span class="n">col_atom</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Atom</span><span class="o">.</span><span class="n">from_type</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="n">temp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                <span class="n">col_atom</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Atom</span><span class="o">.</span><span class="n">from_type</span><span class="p">(</span><span class="n">temp_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">temp_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="c1"># should have come in with a timestamp</span>
                            <span class="c1"># TODO: Log if no timestamp is received</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">temp_timestamp_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
                                <span class="n">timestamp_atom</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Atom</span><span class="o">.</span><span class="n">from_type</span><span class="p">(</span><span class="n">temp_timestamp_arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                       <span class="n">temp_timestamp_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;no timestamp sent with continuous data&#39;</span><span class="p">)</span>
                                <span class="k">continue</span>


                            <span class="n">cont_tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">session_group</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="p">{</span>
                                <span class="n">k</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Col</span><span class="o">.</span><span class="n">from_atom</span><span class="p">(</span><span class="n">col_atom</span><span class="p">),</span>
                                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="o">.</span><span class="n">Col</span><span class="o">.</span><span class="n">from_atom</span><span class="p">(</span><span class="n">timestamp_atom</span><span class="p">)</span>
                            <span class="p">},</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">continuous_filter</span><span class="p">)</span>

                            <span class="n">cont_rows</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cont_tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">row</span>

                        <span class="n">cont_rows</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="n">cont_rows</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                        <span class="n">cont_rows</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

                    <span class="c1"># continue, the rest is for handling trial data</span>
                    <span class="k">continue</span>



                <span class="c1"># Check if this is the same</span>
                <span class="c1"># if we&#39;ve already recorded a trial number for this row,</span>
                <span class="c1"># and the trial number we just got is not the same,</span>
                <span class="c1"># we edit that row if we already have some data on it or else start a new row</span>
                <span class="k">if</span> <span class="s1">&#39;trial_num&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]):</span>

                        <span class="c1"># find row with this trial number if it exists</span>
                        <span class="c1"># this will return a list of rows with matching trial_num.</span>
                        <span class="c1"># if it&#39;s empty, we didn&#39;t receive a TRIAL_END and should create a new row</span>
                        <span class="n">other_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;trial_num == </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]))]</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># proceed to fill the row below</span>
                            <span class="n">trial_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># update the row and continue so we don&#39;t double write</span>
                            <span class="c1"># have to be in the middle of iteration to use update()</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">trial_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;trial_num == </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">])):</span>
                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trial_keys</span><span class="p">:</span>
                                        <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                            <span class="k">continue</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># we have more than one row with this trial_num.</span>
                            <span class="c1"># shouldn&#39;t happen, but we dont&#39; want to throw any data away</span>
                            <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Found multiple rows with same trial_num: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trial_num&#39;</span><span class="p">]))</span>
                            <span class="c1"># continue just for data conservancy&#39;s sake</span>
                            <span class="n">trial_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># some bug where some columns are not always detected,</span>
                    <span class="c1"># rather than failing out here, just log error</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trial_keys</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">trial_row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># TODO: Logging here</span>
                            <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Data dropped: key: </span><span class="si">{}</span><span class="s2">, value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

                <span class="c1"># TODO: Or if all the values have been filled, shouldn&#39;t need explicit TRIAL_END flags</span>
                <span class="k">if</span> <span class="s1">&#39;TRIAL_END&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">trial_row</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
                    <span class="n">trial_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
                    <span class="n">trial_table</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span><span class="p">:</span>
                        <span class="c1"># set our graduation flag, the terminal will get the rest rolling</span>
                        <span class="n">did_graduate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graduation</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">trial_row</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">did_graduate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">did_graduate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="c1"># always flush so that our row iteration routines above will find what they&#39;re looking for</span>
                <span class="n">trial_table</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># TODO: Get logger and log this</span>
                <span class="c1"># we shouldn&#39;t throw any exception in this thread, just log it and move on</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.save_data"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alternate and equivalent method of putting data in the queue as `Subject.data_queue.put(data)`</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): trial data. each should have a &#39;trial_num&#39;, and a dictionary with key</span>
<span class="sd">                &#39;TRIAL_END&#39; should be passed at the end of each trial.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.stop_run"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.stop_run">[docs]</a>    <span class="k">def</span> <span class="nf">stop_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        puts &#39;END&#39; in the data_queue, which causes :meth:`~.Subject.data_thread` to end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Data thread did not exit&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.to_csv"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export trial data to .csv</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): output path of .csv</span>
<span class="sd">            task (str, int):  not implemented, but in the future pull data from &#39;current&#39; or other named task</span>
<span class="sd">            step (str, int, list, tuple): Step to select, see :meth:`.Subject.get_trial_data`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Jonny just scratching out temporarily, doesn&#39;t have all features implemented</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trial_data</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Subject </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">dataframe saved to:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">========================</span>
<span class="s2">N Trials:   </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">N Sessions: </span><span class="si">{}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span></div>



<div class="viewcode-block" id="Subject.get_trial_data"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.get_trial_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_trial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get trial data from the current task.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (int, list, &#39;all&#39;): Step that should be returned, can be one of</span>

<span class="sd">                * -1: most recent step</span>
<span class="sd">                * int: a single step</span>
<span class="sd">                * list of two integers eg. [0, 5], an inclusive range of steps.</span>
<span class="sd">                * anything else, eg. &#39;all&#39;: all steps.</span>

<span class="sd">            what (str): What should be returned?</span>

<span class="sd">                * &#39;data&#39; : Dataframe of requested steps&#39; trial data</span>
<span class="sd">                * &#39;variables&#39;: dict of variables *without* loading data into memory</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: DataFrame of requested steps&#39; trial data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># step= -1 is just most recent step,</span>
        <span class="c1"># step= int is an integer specified step</span>
        <span class="c1"># step= [n1, n2] is from step n1 to n2 inclusive</span>
        <span class="c1"># step= &#39;all&#39; or anything that isn&#39;t an int or a list is all steps</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="n">step_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># find the last trial step with data</span>
            <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">trial_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NROWS&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You provided a step number (</span><span class="si">{}</span><span class="s1">) greater than the number of steps in the subjects assigned protocol: ()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_groups</span><span class="p">)))</span>
            <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_groups</span><span class="p">[</span><span class="n">step</span><span class="p">]]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># since step names have S##_ prepended in the hdf5 file,</span>
            <span class="c1"># but we want to be able to call them by their human readable name,</span>
            <span class="c1"># have to make sure we have the right form</span>
            <span class="n">_step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">step_groups</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">step</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_step_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">step_groups</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">step_groups</span> <span class="o">=</span> <span class="n">_step_groups</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">step_groups</span> <span class="o">=</span> <span class="n">step_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_step_groups</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">a_step</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
                    <span class="n">step_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">step_groups</span> <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="n">a_step</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">step_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">step_groups</span> <span class="k">if</span> <span class="n">a_step</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
                    <span class="n">_step_groups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">step_name</span><span class="p">)</span>

                <span class="n">step_groups</span> <span class="o">=</span> <span class="n">_step_groups</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step groups:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">step_groups</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">step_key</span> <span class="ow">in</span> <span class="n">step_groups</span><span class="p">:</span>
            <span class="n">step_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># beginning of keys will be &#39;S##&#39;</span>
            <span class="n">step_tab</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_key</span><span class="p">]</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="s1">&#39;trial_data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
                <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">step_tab</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_n</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">return_data</span> <span class="o">=</span> <span class="n">return_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                    <span class="n">return_data</span> <span class="o">=</span> <span class="n">step_df</span>

            <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;variables&quot;</span><span class="p">:</span>
                <span class="n">return_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">return_data</span><span class="p">[</span><span class="n">step_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_tab</span><span class="o">.</span><span class="n">coldescrs</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">return_data</span></div>

<div class="viewcode-block" id="Subject.apply_along"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.apply_along">[docs]</a>    <span class="k">def</span> <span class="nf">apply_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">along</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="n">step_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">along</span> <span class="o">==</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># find the last trial step with data</span>
                <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">trial_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NROWS&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                    <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;You provided a step number (</span><span class="si">{}</span><span class="s1">) greater than the number of steps in the subjects assigned protocol: ()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">step</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_groups</span><span class="p">)))</span>
                <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_groups</span><span class="p">[</span><span class="n">step</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">step_key</span> <span class="ow">in</span> <span class="n">step_groups</span><span class="p">:</span>
                <span class="n">step_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># beginning of keys will be &#39;S##&#39;</span>
                <span class="n">step_tab</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_key</span><span class="p">]</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="s1">&#39;trial_data&#39;</span><span class="p">]</span>
                <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">step_tab</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_n</span>
                <span class="k">yield</span> <span class="n">step_df</span></div>





<div class="viewcode-block" id="Subject.get_step_history"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.get_step_history">[docs]</a>    <span class="k">def</span> <span class="nf">get_step_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_history</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a dataframe of step numbers, timestamps, and step names</span>
<span class="sd">        as a coarse view of training status.</span>

<span class="sd">        Args:</span>
<span class="sd">            use_history (bool): whether to use the history table or to reconstruct steps and dates from the trial table itself.</span>
<span class="sd">                compatibility fix for old versions that didn&#39;t stash step changes when the whole protocol was updated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">use_history</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span>
            <span class="c1"># return a dataframe of step number, datetime and step name</span>
            <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">])</span>

            <span class="n">step_df</span> <span class="o">=</span> <span class="n">step_df</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;step_n&#39;</span><span class="p">,</span>
                                      <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
                                      <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>

            <span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">step_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
                                                  <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;/data/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
            <span class="n">step_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># find the last trial step with data</span>
            <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">step_groups</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">trial_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NROWS&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">step_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="c1"># Iterate through steps, find first timestamp, use that.</span>
            <span class="k">for</span> <span class="n">step_key</span> <span class="ow">in</span> <span class="n">step_groups</span><span class="p">:</span>
                <span class="n">step_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># beginning of keys will be &#39;S##&#39;</span>
                <span class="n">step_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">step_n</span><span class="p">][</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>
                <span class="n">step_tab</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="n">step_key</span><span class="p">]</span><span class="o">.</span><span class="n">_v_children</span><span class="p">[</span><span class="s1">&#39;trial_data&#39;</span><span class="p">]</span>
                <span class="c1"># find name of column that is a timestamp</span>
                <span class="n">colnames</span> <span class="o">=</span> <span class="n">step_tab</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">_v_colnames</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ts_column</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colnames</span> <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="n">step_tab</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">ts_column</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;No Timestamp column found, only returning step numbers and named that were reached&#39;</span><span class="p">)</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">step_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;step_n&#39;</span><span class="p">:</span><span class="n">step_n</span><span class="p">,</span>
                     <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span><span class="n">ts</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">step_name</span>
                    <span class="p">})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">return_df</span> <span class="o">=</span> <span class="n">return_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                    <span class="n">return_df</span> <span class="o">=</span> <span class="n">step_df</span>

            <span class="n">step_df</span> <span class="o">=</span> <span class="n">return_df</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">step_df</span></div>

<div class="viewcode-block" id="Subject.get_timestamp"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.get_timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># type: (bool) -&gt; str</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a timestamp.</span>

<span class="sd">        Args:</span>
<span class="sd">            simple (bool):</span>
<span class="sd">                if True:</span>
<span class="sd">                    returns as format &#39;%y%m%d-%H%M%S&#39;, eg &#39;190201-170811&#39;</span>
<span class="sd">                if False:</span>
<span class="sd">                    returns in isoformat, eg. &#39;2019-02-01T17:08:02.058808&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            basestring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Timestamps have two different applications, and thus two different formats:</span>
        <span class="c1"># coarse timestamps that should be human-readable</span>
        <span class="c1"># fine timestamps for data analysis that don&#39;t need to be</span>
        <span class="k">if</span> <span class="n">simple</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span></div>

<div class="viewcode-block" id="Subject.get_weight"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.get_weight">[docs]</a>    <span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="n">include_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets start and stop weights.</span>

<span class="sd">        TODO:</span>
<span class="sd">            add ability to get weights by session number, dates, and ranges.</span>

<span class="sd">        Args:</span>
<span class="sd">            which (str):  if &#39;last&#39;, gets most recent weights. Otherwise returns all weights.</span>
<span class="sd">            include_baseline (bool): if True, includes baseline and minimum mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get either the last start/stop weights, optionally including baseline</span>
        <span class="c1"># TODO: Get by session</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">weight_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">column</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">include_baseline</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">_v_attrs</span><span class="p">[</span><span class="s1">&#39;baseline_mass&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">*</span><span class="mf">0.8</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;baseline_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline</span>
            <span class="n">weights</span><span class="p">[</span><span class="s1">&#39;minimum_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimum</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="Subject.set_weight"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.set_weight">[docs]</a>    <span class="k">def</span> <span class="nf">set_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates an existing weight in the weight table.</span>

<span class="sd">        TODO:</span>
<span class="sd">            Yes, i know this is bad. Merge with update_weights</span>

<span class="sd">        Args:</span>
<span class="sd">            date (str): date in the &#39;simple&#39; format, %y%m%d-%H%M%S</span>
<span class="sd">            col_name (&#39;start&#39;, &#39;stop&#39;): are we updating a pre-task or post-task weight?</span>
<span class="sd">            new_value (float): New mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="n">weight_table</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span>
        <span class="c1"># there should only be one matching row since it includes seconds</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">weight_table</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;date == b&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">)):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Subject.update_weights"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.update_weights">[docs]</a>    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store either a starting or stopping mass.</span>

<span class="sd">        `start` and `stop` can be passed simultaneously, `start` can be given in one</span>
<span class="sd">        call and `stop` in a later call, but `stop` should not be given before `start`.</span>

<span class="sd">        Args:</span>
<span class="sd">            start (float): Mass before running task in grams</span>
<span class="sd">            stop (float): Mass after running task in grams.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_row</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">row</span>
            <span class="n">weight_row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">weight_row</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
            <span class="n">weight_row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">weight_row</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: Make this more robust - don&#39;t assume we got a start weight</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">stop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Need either a start or a stop weight&quot;</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hdf</span><span class="p">(</span><span class="n">h5f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subject.graduate"><a class="viewcode-back" href="../../../autopilot.core.subject.html#autopilot.core.subject.Subject.graduate">[docs]</a>    <span class="k">def</span> <span class="nf">graduate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increase the current step by one, unless it is the last step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Tried to graduate from the last step!</span><span class="se">\n</span><span class="s1"> Task has </span><span class="si">{}</span><span class="s1"> steps and we are on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># increment step, update_history should handle the rest</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">[</span><span class="n">step</span><span class="p">][</span><span class="s1">&#39;step_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

    <span class="k">class</span> <span class="nc">History_Table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to describe parameter and protocol change history</span>

<span class="sd">        Attributes:</span>
<span class="sd">            time (str): timestamps</span>
<span class="sd">            type (str): Type of change - protocol, parameter, step</span>
<span class="sd">            name (str): Name - Which parameter was changed, name of protocol, manual vs. graduation step change</span>
<span class="sd">            value (str): Value - What was the parameter/protocol/etc. changed to, step if protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">4028</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Weight_Table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to describe table for weight history</span>

<span class="sd">        Attributes:</span>
<span class="sd">            start (float): Pre-task mass</span>
<span class="sd">            stop (float): Post-task mass</span>
<span class="sd">            date (str): Timestamp in simple format</span>
<span class="sd">            session (int): Session number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
        <span class="n">stop</span>  <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Float32Col</span><span class="p">()</span>
        <span class="n">date</span>  <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">Int32Col</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Hash_Table</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to describe table for hash history</span>

<span class="sd">        Attributes:</span>
<span class="sd">            time (str): Timestamps</span>
<span class="sd">            hash (str): Hash of the currently checked out commit of the git repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jonny Saunders

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>