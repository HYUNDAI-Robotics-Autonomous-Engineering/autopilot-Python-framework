


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>autopilot.hardware.cameras &mdash; Autopilot 0.3.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="docs.auto-pi-lot.com_modules/autopilot/hardware/cameras.html"/>
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/autopilot_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/restyle.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/autopilot_sass.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/autopilot_sass.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

    <link href="https://fonts.googleapis.com/css?family=Cutive+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Dosis&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lexend+Deca&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="_static/css/autopilot_sass.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.2.0/anime.min.js" integrity="sha256-BuxrUdr/4YoztQLxT6xmdO6hSQw2d6BtBUY1pteGds4=" crossorigin="anonymous"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Autopilot
          

          
            
            <img src="../../../_static/autopilot_logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.overview.html#program-structure">Program Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.overview.html#tasks">Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.overview.html#module-tour">Module Tour</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.installation.pilot.html">Pilot Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.pilot.html#scripted-installation">Scripted Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.pilot.html#manual-preinstall">Manual Preinstall</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#rasbian-installation">Rasbian Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#raspbian-performance-improvements">Raspbian Performance Improvements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#audio-setup">Audio Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#video-setup">Video Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.installation.pilot.html#optional-installation-steps">Optional Installation Steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.installation.terminal.html">Terminal Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.terminal.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.installation.terminal.html#scripted-terminal-setup">Scripted Terminal Setup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.training.html">Training a Subject</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#connecting-the-pilot">Connecting the Pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#creating-a-protocol">Creating a Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.training.html#using-the-protocol-wizard">Using the Protocol Wizard</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.training.html#manual-protocol-creation">Manual Protocol Creation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#creating-a-subject">Creating a Subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#running-the-task">Running the Task</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.training.html#debugging-a-task">Debugging a Task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.task.html">Writing a Task</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.task.html#the-nafc-task">The Nafc Task</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#the-task-class">The <code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code> class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#four-task-attributes">Four Task Attributes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#params">PARAMS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#data">Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#plot">PLOT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#hardware">HARDWARE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#stage-methods">Stage Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#request">Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#discrim">Discrim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guide.task.html#reinforcement">Reinforcement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#additional-methods">Additional Methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.task.html#distributed-go-no-go-using-child-agents">Distributed Go/No-Go - Using Child Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#additional-prefs">Additional Prefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#go-no-go-parameterization">Go/No-Go Parameterization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#id5">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#the-child-task">The Child Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#a-very-smart-wheel">A Very Smart Wheel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.task.html#go-no-go-stage-methods">Go/No-Go Stage Methods</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.hardware.html">Writing a Hardware Class</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.hardware.html#gpio-with-pigpio">GPIO with pigpio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.hardware.html#input-beambreak">Input - Beambreak</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guide.hardware.html#output-led-rgb">Output - LED_RGB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide.hardware.html#usb-hardware-with-inputs">USB Hardware with inputs</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.core.html">Core Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.gui.html">gui</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.networking.html">networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.pilot.html">pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.plots.html">plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.styles.html">styles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.subject.html">subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.terminal.html">terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.core.utils.html">utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.hardware.html">Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.cameras.html">cameras</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.gpio.html">gpio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.i2c.html">i2c</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.hardware.usb.html">usb</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.tasks.html">Tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.children.html">children</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.free_water.html">free_water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.graduation.html">graduation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.nafc.html">nafc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.tasks.task.html">task</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.stim.html">Stimuli</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.stim.managers.html">managers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.stim.sound.html">sound</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../autopilot.stim.sound.jackclient.html">jackclient</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autopilot.stim.sound.pyoserver.html">pyoserver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autopilot.stim.sound.sounds.html">sounds</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.viz.html">Visualization Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.viz.trial_viewer.html">trial_viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.viz.psychometric.html">psychometric</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.setup.html">Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.setup.setup_pilot.html">setup_pilot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.setup.setup_scale.html">setup_scale</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autopilot.setup.setup_terminal.html">setup_terminal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.prefs.html">Prefs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autopilot.external.html">External</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/autopilot-users">Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todo.html">To-Do</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#visions">Visions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../todo.html#integrations">Integrations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../todo.html#roadmap-deeplabcut-integration">DeepLabCut Integration<span><a href="https://groups.google.com/forum/#!topic/autopilot-users/T-PNfrHDtzA" class="roadmap-dblink">priority: high | discuss>></a></span></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../todo.html#roadmap-open-ephys-integration">Open Ephys Integration<span><a href="https://google.com" class="roadmap-dblink">priority: medium | discuss>></a></span></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../todo.html#roadmap-bonsai-integration">Bonsai Integration<span><a href="https://google.com" class="roadmap-dblink">priority: low | discuss>></a></span></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../todo.html#closed-loop-behavior-processing-pipelines">Closed-Loop Behavior &amp; Processing Pipelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#improvements">Improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#bugs">Bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#completed">Completed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../todo.html#lowest-priority">Lowest Priority</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog/index.html#version-0-3">Version 0.3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog/v0.3.0.html">v0.3.0 (March 3rd, 2020)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#major-updates">Major Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#minor-updates">Minor Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#new-features">New Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#bugfixes">Bugfixes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#code-structure">Code Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../changelog/v0.3.0.html#external-libraries">External Libraries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog/index.html#version-0-2">Version 0.2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog/v0.2.0.html">v0.2.0 (October 26, 2019)</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Autopilot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../hardware.html">autopilot.hardware</a> &raquo;</li>
        
      <li>autopilot.hardware.cameras</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for autopilot.hardware.cameras</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">skvideo</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">skvideo.utils</span> <span class="kn">import</span> <span class="n">vshape</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>


<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">blosc</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_char_p</span>




<span class="c1"># import the Queue class from Python 3</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Full</span>

<span class="c1"># otherwise, import the Queue class for Python 2.7</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Full</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">PySpin</span>
    <span class="n">PYSPIN</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">PYSPIN_SYSTEM</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">PYSPIN</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="n">OPENCV</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">OPENCV</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">autopilot</span> <span class="kn">import</span> <span class="n">prefs</span>
<span class="kn">from</span> <span class="nn">autopilot.hardware</span> <span class="kn">import</span> <span class="n">Hardware</span>

<span class="n">OPENCV_LAST_INIT_TIME</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Time the last OpenCV camera was initialized (seconds, from time.time()).</span>

<span class="sd">v4l2 has an extraordinarily obnoxious ...feature -- </span>
<span class="sd">if you try to initialize two cameras at ~the same time,</span>
<span class="sd">you will get a neverending stream of informative error messages: ``VIDIOC_QBUF: Invalid argument``</span>

<span class="sd">The workaround seems to be relatively simple, we just wait ~2 seconds if another camera was just initialized.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">LAST_INIT_LOCK</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<div class="viewcode-block" id="Camera"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera">[docs]</a><span class="k">class</span> <span class="nc">Camera</span><span class="p">(</span><span class="n">Hardware</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass for Camera objects. Should not be instantiated on its own.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        fps (int): Framerate of video capture</span>
<span class="sd">        timed (bool, int, float): If False (default), camera captures indefinitely. If int or float, captures for this many seconds</span>
<span class="sd">        **kwargs: Arguments to :meth:`~Camera.stream`, :meth:`~Camera.write`, and :meth:`~Camera.queue` can be passed as dictionaries, eg.::</span>

<span class="sd">            stream={&#39;to&#39;:&#39;T&#39;, &#39;ip&#39;:&#39;localhost&#39;}</span>

<span class="sd">    When the camera is instantiated and :meth:`~.Camera.capture` is called,</span>
<span class="sd">    the class uses a series of methods that should be overwritten in subclasses.</span>
<span class="sd">    Further details for each can be found in the relevant method documentation.</span>

<span class="sd">    It is highly recommended to instantiate Cameras with a :attr:`.Hardware.name`,</span>
<span class="sd">    as it is used in :attr:`.output_filename` and to identify the network stream</span>

<span class="sd">    Three methods are required to be overwritten by all subclasses:</span>

<span class="sd">        * :meth:`~.Camera.init_cam` - **required** - used by :attr:`~.Camera.cam`, instantiating the camera object so that it can be queried and configured</span>
<span class="sd">        * :meth:`~.Camera._grab` - **required** - grab a frame from the :attr:`~.Camera.cam`</span>
<span class="sd">        * :meth:`~.Camera._timestamp` - **required** - get a timestamp for the frame</span>

<span class="sd">    The other methods are optional and depend on the particular camera:</span>

<span class="sd">        * :meth:`~.Camera.capture_init` - *optional* - any required routine to prepare the camera after it is instantiated but before it begins to capture</span>
<span class="sd">        * :meth:`~.Camera._process` - *optional* - the wrapper around a full acquisition cycle, including streaming, writing, and queueing frames</span>
<span class="sd">        * :meth:`~.Camera._write_frame` - *optional* - how to write an individual frame to disk</span>
<span class="sd">        * :meth:`~.Camera._write_deinit` - *optional* - any required routine to finish writing to disk after acquisition</span>
<span class="sd">        * :meth:`~.Camera.capture_deinit` - *optional* - any required routine to stop acquisition but not release the camera instance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        frame (tuple): The current captured frame as a tuple (timestamp, frame).</span>
<span class="sd">        shape (tuple): Shape of captured frames (height, width, channels)</span>
<span class="sd">        blosc (bool): If True (default), use blosc compression when</span>
<span class="sd">        cam: The object used to interact with the camera</span>
<span class="sd">        fps (int): Framerate of video capture</span>
<span class="sd">        timed (bool, int, float): If False (default), camera captures indefinitely. If int or float, captures for this many seconds</span>
<span class="sd">        q (Queue): Queue that allows frames to be pulled by other objects</span>
<span class="sd">        queue_size (int): How many frames should be buffered in the queue.</span>
<span class="sd">        initialized (threading.Event): Called in :meth:`~.init_cam` to indicate the camera has been initialized</span>
<span class="sd">        stopping (threading.Event): Called to signal that capturing should stop. when set, ends the threaded capture loop</span>
<span class="sd">        capturing (threading.Event): Set when camera is actively capturing</span>
<span class="sd">        streaming (threading.Event): Set to indicate that the camera is streaming data over the network</span>
<span class="sd">        writing (threading.Event): Set to indicate that the camera is writing video locally</span>
<span class="sd">        queueing (threading.Event): Indicates whether frames are being put into :attr:`~.Camera.q`</span>
<span class="sd">        indicating (threading.Event): Set to indicate that capture progress is being indicated in stdout by :class:`~tqdm.tqdm`</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#: test documenting input</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;CAMERA&quot;</span> <span class="c1">#: (str): what are we anyway?</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Camera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># internal attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cam</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: camera subobject test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_n</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blosc</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#self.fps = fps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">=</span> <span class="n">timed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_size</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># event to end acquisition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">capturing</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capturing</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writing</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queueing</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queueing</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indicating</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicating</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># initialize args passed by kwargs</span>
        <span class="k">if</span> <span class="s1">&#39;stream&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;write&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;queue&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;queue&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Camera.capture"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.capture">[docs]</a>    <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a thread to begin capturing.</span>


<span class="sd">        Args:</span>
<span class="sd">            timed (None, int, float): if None, record according to :attr:`.timed` (default). If numeric, record for ``timed`` seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capturing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Already Capturing!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">timed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">=</span> <span class="n">timed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame_n</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera._capture"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera._capture">[docs]</a>    <span class="k">def</span> <span class="nf">_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Threaded capture method started by :meth:`.capture`.</span>

<span class="sd">        Captures until :attr:`.stopping` is set.</span>

<span class="sd">        Calls capture methods, in order:</span>

<span class="sd">        * :meth:`~.Camera.capture_init` - any required routine to prepare the camera after it is instantiated but before it begins to capture</span>
<span class="sd">        * :meth:`~.Camera._process`  - the wrapper around a full acquisition cycle, including streaming, writing, and queueing frames</span>
<span class="sd">        * :meth:`~.Camera._grab`  - grab a frame from the :attr:`~.Camera.cam`</span>
<span class="sd">        * :meth:`~.Camera._timestamp`  - get a timestamp for the frame</span>
<span class="sd">        * :meth:`~.Camera._write_frame`  - how to write an individual frame to disk</span>
<span class="sd">        * :meth:`~.Camera._write_deinit` - any required routine to finish writing to disk after acquisition</span>
<span class="sd">        * :meth:`~.Camera.capture_deinit` - any required routine to stop acquisition but not release the camera instance.</span>



<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">capturing</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">capture_init</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;CAPTURING&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timed</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">end_time</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">frame_n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Capture Ending&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;STOPPING&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stream_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to end stream, error message: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_deinit</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to end writer, error message: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicating</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">capturing</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capture_deinit</span><span class="p">()</span></div>
            <span class="c1">#self.release()</span>
            <span class="c1">#self.logger.info(&#39;Camera Released&#39;)</span>

<div class="viewcode-block" id="Camera._process"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera._process">[docs]</a>    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A full frame capture cycle.</span>

<span class="sd">        :meth:`~Camera._grab`s the :attr:`.frame`, then handles streaming, writing, queueing, and indicating</span>
<span class="sd">        according to :meth:`~Camera.stream`, :meth:`~Camera.write`, :meth:`~Camera.queue`, and :attr:`~Camera.indicating`, respectively.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grab</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">({</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queueing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicating</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera.stream"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.stream">[docs]</a>    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable streaming frames on capture.</span>

<span class="sd">        Spawns a :class:`~.networking.Net_Node` with :meth:`.Hardware.init_networking`,</span>
<span class="sd">        and creates a streaming queue with :meth:`.Net_Node.get_stream` according to args.</span>

<span class="sd">        Sets :attr:`.Camera.streaming`</span>

<span class="sd">        Args:</span>
<span class="sd">            to (str): ID of the recipient. Default &#39;T&#39; for Terminal.</span>
<span class="sd">            ip (str): IP of recipient. If None (default), &#39;localhost&#39;. If None and ``to`` is &#39;T&#39;, ``prefs.TERMINALIP``</span>
<span class="sd">            port (int, str): Port of recipient socket. If None (default), ``prefs.MSGPORT``. If None and ``to`` is &#39;T&#39;, ``prefs.TERMINALPORT``.</span>
<span class="sd">            **kwargs: passed to :meth:`.Hardware.init_networking` and thus to :class:`.Net_Node`</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="n">to</span><span class="o">==</span><span class="s1">&#39;T&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">TERMINALIP</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">TERMINALPORT</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ip not passed, using localhost as default&#39;</span><span class="p">)</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;port not passed, using prefs.MSGPORT&#39;</span><span class="p">)</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">MSGPORT</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">listens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;START&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_start</span><span class="p">,</span>
            <span class="s1">&#39;STOP&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_stop</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_networking</span><span class="p">(</span><span class="n">listens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listens</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prefs</span><span class="p">,</span> <span class="s1">&#39;SUBJECT&#39;</span><span class="p">):</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">SUBJECT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;nothing found for prefs.SUBJECT, probably running outside of task context&#39;</span><span class="p">)</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span>
            <span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="s1">&#39;CONTINUOUS&#39;</span><span class="p">,</span> <span class="n">upstream</span><span class="o">=</span><span class="n">to</span><span class="p">,</span>
            <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera.l_start"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.l_start">[docs]</a>    <span class="k">def</span> <span class="nf">l_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Begin capturing by calling :meth:`Camera.capture`</span>

<span class="sd">        Args:</span>
<span class="sd">            val: unused</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera.l_stop"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.l_stop">[docs]</a>    <span class="k">def</span> <span class="nf">l_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop capture by calling :meth:`Camera.release`</span>

<span class="sd">        Args:</span>
<span class="sd">            val: unused</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>



<div class="viewcode-block" id="Camera.write"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blosc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable writing frames locally on capture</span>

<span class="sd">        Spawns a :class:`.Video_Writer` to encode video, sets :attr:`.writing`</span>

<span class="sd">        Args:</span>
<span class="sd">            output_filename (str): path and filename of the output video. extension should be ``.mp4``,</span>
<span class="sd">                as videos are encoded with libx264 by default.</span>
<span class="sd">            timestamps (bool): if True, (timestamp, frame) tuples will be put in the :attr:`._write_q`.</span>
<span class="sd">                if False, timestamps will be generated by :class:`.Video_Writer` (not recommended at all).</span>
<span class="sd">            blosc (bool): if true, compress frames with :func:`blosc.pack_array` before putting in :attr:`._write_q`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span> <span class="o">=</span> <span class="n">output_filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blosc</span> <span class="o">=</span> <span class="n">blosc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">Video_Writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">blosc</span><span class="o">=</span><span class="n">blosc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing initialized, writing to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_filename</span><span class="p">))</span></div>

<div class="viewcode-block" id="Camera._write_frame"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera._write_frame">[docs]</a>    <span class="k">def</span> <span class="nf">_write_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Put :attr:`.frame` into the :attr:`._write_q`, optionally compressing it with :func:`blosc.pack_array`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blosc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">blosc</span><span class="o">.</span><span class="n">pack_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Full</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Frame </span><span class="si">{}</span><span class="s1"> could not be written, queue full&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_n</span><span class="p">))</span></div>



<div class="viewcode-block" id="Camera._write_deinit"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera._write_deinit">[docs]</a>    <span class="k">def</span> <span class="nf">_write_deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        End the :class:`.Video_Writer`.</span>

<span class="sd">        Blocks until the :attr:`._write_q` is empty, holding the release of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="s1">&#39;END&#39;</span><span class="p">)</span>
        <span class="n">checked_empty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">checked_empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Writer still has ~</span><span class="si">{}</span><span class="s1"> frames, waiting on it to finish&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()))</span>
                <span class="n">checked_empty</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writer finished, closing&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera.queue"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.queue">[docs]</a>    <span class="k">def</span> <span class="nf">queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable stashing frames in a queue for a local consumer.</span>

<span class="sd">        Other objects can get frames as they are acquired from :attr:`.q`</span>

<span class="sd">        Args:</span>
<span class="sd">            queue_size (int): max number of frames that can be held in :attr:`~Camera.q`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_size</span> <span class="o">=</span> <span class="n">queue_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queueing</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Queueing initialized, queue size </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">queue_size</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Camera object.</span>

<span class="sd">        If :attr:`._cam` hasn&#39;t been initialized yet, use :meth:`.init_cam` to do so</span>

<span class="sd">        Returns:</span>
<span class="sd">            Camera object, different for each camera.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cam</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_cam</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cam</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filename given to video writer.</span>

<span class="sd">        If explicitly set, returns as expected.</span>

<span class="sd">        If None, or path already exists while the camera isn&#39;t capturing,</span>
<span class="sd">        a new filename is generated in the user directory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str) :attr:`._output_filename`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: choose output directory</span>

        <span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">capturing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">user_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="s2">&quot;capture_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.mp4&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                                            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                                                                                                <span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span>

    <span class="nd">@output_filename</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">output_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_filename</span> <span class="o">=</span> <span class="n">output_filename</span>

<div class="viewcode-block" id="Camera._grab"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera._grab">[docs]</a>    <span class="k">def</span> <span class="nf">_grab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Capture a frame and timestamp.</span>

<span class="sd">        Method must be overridden by subclass</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str, :class:`numpy.ndarray`) Tuple of isoformatted (str) or numeric timestamp returned by :meth:`._timestamp`,</span>
<span class="sd">                and captured frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;internal _grab method must be overwritten by camera subclass!!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera._timestamp"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera._timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a timestamp for each :meth:`~Camera._grab`</span>

<span class="sd">        Must be overridden by subclass</span>

<span class="sd">        Args:</span>
<span class="sd">            frame: If needed by camera subclass, pass the frame or image object to get timestamp</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str, int, float) Either an isoformatted (str) or numeric timestamp</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;internal _timestamp method must be overwritten by camera subclass!!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Camera.init_cam"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.init_cam">[docs]</a>    <span class="k">def</span> <span class="nf">init_cam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to initialize camera object</span>

<span class="sd">        Must be overridden by camera subclass</span>

<span class="sd">        Returns:</span>
<span class="sd">            camera object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;init_cam must be overwritten by camera subclass!!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera.capture_init"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.capture_init">[docs]</a>    <span class="k">def</span> <span class="nf">capture_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optional: Prepare :attr:`.cam` after initialization, but before capture</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Camera.capture_deinit"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.capture_deinit">[docs]</a>    <span class="k">def</span> <span class="nf">capture_deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optional: Return :attr:`.cam` to an idle state after capturing, but before releasing</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Camera.stop"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop capture by setting  :attr:`.stopping`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera.release"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release resources held by Camera.</span>

<span class="sd">        Must be overridden by subclass.</span>

<span class="sd">        Does not raise exception in case some general camera release logic should be put here...</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span></div></div>
        <span class="c1"># raise Exception(&#39;release must be overwritten by camera subclass!!&#39;)</span>






<div class="viewcode-block" id="Camera_CV"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_CV">[docs]</a><span class="k">class</span> <span class="nc">Camera_CV</span><span class="p">(</span><span class="n">Camera</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Capture Video from a webcam with OpenCV</span>

<span class="sd">        By default, OpenCV will select a suitable backend for the indicated camera. Some backends have difficulty</span>
<span class="sd">        operating multiple cameras at once, so the performance of this class will be variable depending on camera</span>
<span class="sd">        type.</span>

<span class="sd">        Args:</span>
<span class="sd">            camera_idx (int): The index of the desired camera</span>
<span class="sd">            **kwargs: Passed to the :class:`.Camera` metaclass.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            camera_idx (int): The index of the desired camera</span>
<span class="sd">            last_opencv_init (float): See :data:`~cameras.OPENCV_LAST_INIT_TIME`</span>
<span class="sd">            last_init_lock (:class:`threading.Lock`): Lock for setting :attr:`.last_opencv_init`</span>


<span class="sd">        .. note::</span>

<span class="sd">            OpenCV must be installed to use this class! A Prebuilt opencv binary is available for the raspberry pi,</span>
<span class="sd">            but it doesn&#39;t take advantage of some performance-enhancements available to OpenCV. Use the ``install_opencv.sh``</span>
<span class="sd">            script in the setup directory to compile OpenCV with these enhancements.</span>

<span class="sd">        If your camera isn&#39;t working, to print debugging information you can run::</span>

<span class="sd">            echo 3 &gt; /sys/class/video4linux/videox/dev_debug</span>

<span class="sd">            # check logs</span>
<span class="sd">            dmesg</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">OPENCV</span><span class="p">:</span>
            <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;opencv was not imported, and is required for Camera_CV&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Camera_CV</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_v4l_info</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_opencv_init</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;OPENCV_LAST_INIT_TIME&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_init_lock</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;LAST_INIT_LOCK&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_idx</span> <span class="o">=</span> <span class="n">camera_idx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to get FPS with ``cv2.CAP_PROP_FPS``, uses 30fps as a default</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: framerate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Couldnt get fps from camera, using </span><span class="si">{}</span><span class="s1"> as default&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fps</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to get image shape from ``cv2.CAP_PROP_FRAME_WIDTH`` and ``HEIGHT``</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: (width, height)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>

<div class="viewcode-block" id="Camera_CV._grab"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_CV._grab">[docs]</a>    <span class="k">def</span> <span class="nf">_grab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a frame with :meth:`.cam.read`</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (timestamp, frame)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera_CV._timestamp"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_CV._timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to get timestamp with ``cv2.CAP_PROP_POS_MSEC``.</span>
<span class="sd">        Frame does not need to be passed to this method, as</span>
<span class="sd">        timestamps are retrieved from :attr:`.cam`</span>

<span class="sd">        .. todo::</span>

<span class="sd">            Convert this float timestamp to an isoformatted system timestamp</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: milliseconds since capture start</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_MSEC</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        capture backend used by OpenCV for this camera</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: name of capture backend used by OpenCV for this camera</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">getBackendName</span><span class="p">()</span>

<div class="viewcode-block" id="Camera_CV.init_cam"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_CV.init_cam">[docs]</a>    <span class="k">def</span> <span class="nf">init_cam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes OpenCV Camera</span>

<span class="sd">        To avoid overlapping resource allocation requests,</span>
<span class="sd">        checks the last time any :class:`.Camera_CV` object was instantiated</span>
<span class="sd">        and makes sure it has been at least 2 seconds since then.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`cv2.VideoCapture`: camera object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_init_lock</span><span class="p">:</span>
            <span class="n">time_since_last_init</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_opencv_init</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">time_since_last_init</span> <span class="o">&lt;</span> <span class="mf">2.</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">time_since_last_init</span><span class="p">)</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_opencv_init</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Camera Initialized&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vid</span></div>

<div class="viewcode-block" id="Camera_CV.release"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_CV.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Camera_CV</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">v4l_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Device information from ``v4l2-ctl``</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Information for all devices available through v4l2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v4l_info</span><span class="p">:</span>
            <span class="c1"># query v4l device info</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/v4l2-ctl&quot;</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">]</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">err</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># split by \n to get lines, then group by \t</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">n_indents</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>

                <span class="c1"># if we&#39;re a sublist, but not a subsublist, split and strip, make a subdictionary</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">this_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>
                    <span class="n">subkey</span><span class="p">,</span> <span class="n">subval</span> <span class="o">=</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">this_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">subval</span>

                <span class="c1"># but if we&#39;re a subsublist... shouldn&#39;t have a dictionary</span>
                <span class="k">elif</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">subkey</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="c1"># catch the previously assined value from the top level of the subdictionary</span>
                        <span class="n">vals</span><span class="p">[</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">subkey</span><span class="p">]]</span>

                    <span class="n">vals</span><span class="p">[</span><span class="n">subkey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># otherwise if we&#39;re at the bottom level, stash the key and any value dictioanry we&#39;ve gathered before</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">:</span>
                        <span class="n">out_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># get the last one</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_v4l_info</span> <span class="o">=</span> <span class="n">out_dict</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v4l_info</span></div>


<div class="viewcode-block" id="Camera_Spinnaker"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker">[docs]</a><span class="k">class</span> <span class="nc">Camera_Spinnaker</span><span class="p">(</span><span class="n">Camera</span><span class="p">):</span>

    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;CAMERA_SPIN&quot;</span>

    <span class="c1"># only create class attributes if pyspin is detected,</span>
    <span class="c1"># otherwise can&#39;t import this module without having pyspin</span>


    <span class="n">ATTR_TYPES</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#: Conversion from data types to pointer types</span>
    <span class="n">ATTR_TYPE_NAMES</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#: Conversion from data types to human-readable names</span>
    <span class="n">RW_MODES</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#: Conversion from read/write mode to {&#39;read&#39;:bool, &#39;write&#39;:bool} descriptor</span>

    <span class="k">if</span> <span class="n">PYSPIN</span><span class="p">:</span>
        <span class="n">ATTR_TYPES</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIFloat</span>      <span class="p">:</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CFloatPtr</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIBoolean</span>    <span class="p">:</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CBooleanPtr</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIInteger</span>    <span class="p">:</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CIntegerPtr</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIEnumeration</span><span class="p">:</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CEnumerationPtr</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIString</span>     <span class="p">:</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CStringPtr</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">ATTR_TYPE_NAMES</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIFloat</span>      <span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIBoolean</span>    <span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIInteger</span>    <span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIEnumeration</span><span class="p">:</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfIString</span>     <span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">intfICommand</span>    <span class="p">:</span> <span class="s1">&#39;command&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">RW_MODES</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">RO</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">RW</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">WO</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="n">PySpin</span><span class="o">.</span><span class="n">NA</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="p">}</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Capture video from a FLIR brand camera with the Spinnaker SDK.</span>

<span class="sd">        Args:</span>
<span class="sd">            serial (str): Serial number of desired camera</span>
<span class="sd">            camera_idx (int): If no serial provided, select camera by index. Using ``serial`` is HIGHLY RECOMMENDED.</span>
<span class="sd">            **kwargs: passed to :class:`.Camera` metaclass</span>

<span class="sd">        .. note::</span>

<span class="sd">            PySpin and the Spinnaker SDK must be installed to use this class. Please use the</span>
<span class="sd">            ``install_pyspin.sh`` script in ``setup``</span>

<span class="sd">        See the documentation for the Spinnaker SDK and PySpin here:</span>

<span class="sd">        `&lt;https://www.flir.com/products/spinnaker-sdk/&gt;`_</span>



<span class="sd">        Attributes:</span>
<span class="sd">            serial (str): Serial number of desired camera</span>
<span class="sd">            camera_idx (int): If no serial provided, select camera by index. Using ``serial`` is HIGHLY RECOMMENDED.</span>
<span class="sd">            system (:class:`PySpin.System`): The PySpin System object</span>
<span class="sd">            cam_list (:class:`PySpin.CameraList`): The list of PySpin Cameras available to the system</span>
<span class="sd">            nmap: A reference to the nodemap from the GenICam XML description of the device</span>
<span class="sd">            base_path (str): The directory and base filename that images will be written to if object is :attr:`.writing`. eg::</span>

<span class="sd">                base_path = &#39;/home/user/capture_directory/capture_&#39;</span>
<span class="sd">                image_path = base_path + &#39;image1.png&#39;</span>

<span class="sd">            img_opts (:class:`PySpin.PNGOption`): Options for saving .png images, made by :meth:`~Camera_Spinnaker.write`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">PYSPIN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;PySpin was not imported, and is required for Camera_Spinnaker&#39;</span><span class="p">)</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#spinnaker system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_opts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># internal variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exposure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_trigger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acquisition_mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera_node_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readable_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writable_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamps</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="nb">super</span><span class="p">(</span><span class="n">Camera_Spinnaker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">serial</span> <span class="ow">and</span> <span class="n">camera_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;serial and camera_idx were both passed, defaulting to serial&quot;</span><span class="p">)</span>
            <span class="n">camera_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">serial</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_idx</span> <span class="o">=</span> <span class="n">camera_idx</span>



        <span class="c1"># set passed parameters</span>
        <span class="c1"># has to be done in a specific order, as they are mutually dependent.</span>
        <span class="c1"># eg. exposure depends on fps, which depends on bin, etc.</span>
        <span class="k">if</span> <span class="s1">&#39;pixel_format&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PixelFormat&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pixel_format&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PixelFormat&#39;</span><span class="p">,</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">PixelFormat_Mono8</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="s1">&#39;bin&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;fps&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fps&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;acquisition_mode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;AcquisitionMode&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;acquisition_mode&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_mode</span> <span class="o">=</span> <span class="s1">&#39;continuous&#39;</span>



<div class="viewcode-block" id="Camera_Spinnaker.init_cam"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.init_cam">[docs]</a>    <span class="k">def</span> <span class="nf">init_cam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Spinnaker Camera</span>

<span class="sd">        Initializes the camera, system, cam_list, node map, and the camera methods and</span>
<span class="sd">        attributes used by :meth:`~Camera_Spinnaker.get` and :meth:`~Camera_Spinnaker.set`</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`PySpin.Camera`: The Spinnaker camera object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find our camera!</span>
        <span class="c1"># get the spinnaker system handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">GetInstance</span><span class="p">()</span>
        <span class="c1"># need to hang on to camera list for some reason, could be cargo cult code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">GetCameras</span><span class="p">()</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="p">:</span>
            <span class="n">cam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span><span class="o">.</span><span class="n">GetBySerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;No camera serial number provided. </span><span class="se">\n</span><span class="s1">Addressing cameras by serial number is STRONGLY recommended to avoid randomly using the wrong one&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="s1">&#39;noserial&#39;</span>
            <span class="n">cam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span><span class="o">.</span><span class="n">GetByIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;No camera serial number OR camera index provided. Trying to use the first camera. This is a really bad way to call this object&#39;</span>
            <span class="p">)</span>
            <span class="n">cam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span><span class="o">.</span><span class="n">GetByIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># initialize the cam - need to do this before messing w the values</span>
        <span class="n">cam</span><span class="o">.</span><span class="n">Init</span><span class="p">()</span>
        <span class="c1"># TODO: Document what a nodemap is...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmap</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">GetTLDeviceNodeMap</span><span class="p">()</span>

        <span class="c1"># get list of camera methods and attributes for use with &#39;get&#39; and &#39;set&#39; methods</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cam</span><span class="o">.</span><span class="n">GetNodeMap</span><span class="p">()</span><span class="o">.</span><span class="n">GetNodes</span><span class="p">():</span>
            <span class="n">pit</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">GetPrincipalInterfaceType</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_camera_node_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTR_TYPE_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pit</span><span class="p">,</span> <span class="n">pit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pit</span> <span class="o">==</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">intfICommand</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CCommandPtr</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTR_TYPES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTR_TYPES</span><span class="p">[</span><span class="n">pit</span><span class="p">](</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cam</span></div>

<div class="viewcode-block" id="Camera_Spinnaker.capture_init"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.capture_init">[docs]</a>    <span class="k">def</span> <span class="nf">capture_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the camera for acquisition</span>

<span class="sd">        calls the camera&#39;s ``BeginAcquisition`` method and populate :attr:`.shape`</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BeginAcquisition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grab</span><span class="p">()</span>
        <span class="c1"># FIXME: I think this will break single-shot or multishot modes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetNDArray</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span></div>


<div class="viewcode-block" id="Camera_Spinnaker.capture_deinit"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.capture_deinit">[docs]</a>    <span class="k">def</span> <span class="nf">capture_deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        De-initializes the camera after acquisition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">EndAcquisition</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera_Spinnaker._process"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker._process">[docs]</a>    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modification of the :meth:`.Camera._process` method for Spinnaker cameras</span>

<span class="sd">        Because the objects returned from the :meth:`~Camera_Spinnaker._grab` method are image *pointers*</span>
<span class="sd">        rather than :class:`numpy.ndarray`s, they need to be handled differently.</span>

<span class="sd">        More details on the differences are given in the :meth:`_write_frame`,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame_array</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grab</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1">#self._frame[:] = self.frame[1].GetNDArray()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_frame</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_array</span><span class="p">:</span>
                <span class="n">frame_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetNDArray</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stream_q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">({</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="p">:</span> <span class="n">frame_array</span><span class="p">})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queueing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_array</span><span class="p">:</span>
                <span class="n">frame_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetNDArray</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frame_array</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicating</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Release</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera_Spinnaker._grab"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker._grab">[docs]</a>    <span class="k">def</span> <span class="nf">_grab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get next timestamp and PySpin Image</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (timestamp, :class:`PySpin.Image`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">GetNextImage</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">img</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera_Spinnaker._timestamp"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker._timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the timestamp from the passed image</span>

<span class="sd">        Args:</span>
<span class="sd">            frame (:class:`PySpin.Image`): Currently grabbed image</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: PySpin timestamp</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame</span><span class="o">.</span><span class="n">GetTimeStamp</span><span class="p">()</span></div>


<div class="viewcode-block" id="Camera_Spinnaker.write"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blosc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets camera to save acquired images to a directory for later encoding.</span>

<span class="sd">        For performance, rather than encoding during acquisition, save each image as</span>
<span class="sd">        a (lossless) .png image in a directory generated by :attr:`.output_filename`.</span>

<span class="sd">        After capturing is complete, a :class:`.Directory_Writer` encodes the images to an</span>
<span class="sd">        x264 encoded .mp4 video.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_filename (str): Directory to write images to. If None (default), generated by :attr:`.output_filename`</span>
<span class="sd">            timestamps (bool): Not used, timestamps are always appended to filenames.</span>
<span class="sd">            blosc (bool): Not used, images are directly saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_filename</span> <span class="o">=</span> <span class="n">output_filename</span>


        <span class="c1"># PNG images are losslessly compressed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_opts</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">PNGOption</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_opts</span><span class="o">.</span><span class="n">compressionLevel</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># make directory</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># create base_path for output images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;capture_</span><span class="si">{}</span><span class="s2">__&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="Camera_Spinnaker._write_frame"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker._write_frame">[docs]</a>    <span class="k">def</span> <span class="nf">_write_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write frame to :attr:`.base_path` + timestamp + &#39;.png&#39; with :meth:`PySpin.Image.Save`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_opts</span><span class="p">)</span></div>


<div class="viewcode-block" id="Camera_Spinnaker._write_deinit"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker._write_deinit">[docs]</a>    <span class="k">def</span> <span class="nf">_write_deinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After capture, write images in :attr:`.base_path` to video with :class:`.Directory_Writer`</span>

<span class="sd">        Camera object will remain open until writer has finished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing images in </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">+</span> <span class="s1">&#39;.mp4&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">Directory_Writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Camera Binning.</span>

<span class="sd">        Attempts to bin on-device, and use averaging if possible. If averaging not available,</span>
<span class="sd">        uses summation.</span>

<span class="sd">        Args:</span>
<span class="sd">            tuple: tuple of integers, (Horizontal, Vertical binning)</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (Horizontal, Vertical binning)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningHorizontal</span><span class="o">.</span><span class="n">ToString</span><span class="p">()),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningVertical</span><span class="o">.</span><span class="n">ToString</span><span class="p">()))</span>

    <span class="nd">@bin</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bin</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningSelector</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">BinningSelector_All</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningHorizontalMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">BinningHorizontalMode_Average</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningVerticalMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">BinningVerticalMode_Average</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">SpinnakerException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Average binning not supported, using sum&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningHorizontal</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">BinningVertical</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set Exposure of camera</span>

<span class="sd">        Can be set with</span>

<span class="sd">        * ``&#39;auto&#39;`` - automatic exposure control. note that this will limit framerate</span>
<span class="sd">        * ``float`` from 0-1 - exposure duration proportional to fps. eg. if fps = 10, setting exposure = 0.5 means exposure will be set as 50ms</span>
<span class="sd">        * ``float`` or ``int``  &gt;1 - absolute exposure time in microseconds</span>

<span class="sd">        Returns:</span>
<span class="sd">            str, float: If exposure has been set, return set value. Otherwise return ``.get(&#39;ExposureTime&#39;)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exposure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ExposureTime&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exposure</span>

    <span class="nd">@exposure</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">exposure</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">ExposureAuto</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">ExposureAuto_Continuous</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exposure</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exposure</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># proportional to fps</span>
                <span class="n">exposure</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span> <span class="o">*</span> <span class="n">exposure</span> <span class="o">*</span> <span class="mf">1e6</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;GainAuto&#39;</span><span class="p">,</span> <span class="s1">&#39;Off&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Gain&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">ExposureAuto</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">ExposureAuto_Off</span><span class="p">)</span>
            <span class="c1"># self.cam.ExposureMode.SetValue(PySpin.ExposureMode_Timed)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">ExposureTime</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exposure</span> <span class="o">=</span> <span class="n">exposure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Dont know how to set exposure </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exposure</span><span class="p">))</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acquisition Framerate</span>

<span class="sd">        Set with integer. If set with None, ignored (superclass sets FPS to None on init)</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: from ``cam.AcquisitionFrameRate.GetValue()``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">AcquisitionFrameRate</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>

    <span class="nd">@fps</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fps</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fps</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1">#self.cam.AcquisitionFrameRateEnable.SetValue(True)</span>
            <span class="c1">#self.cam.AcquisitionFrameRate.SetValue(fps)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;AcquisitionFrameRateAuto&#39;</span><span class="p">,</span> <span class="s1">&#39;Off&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;AcquisitionFrameRateEnable&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;AcquisitionFrameRate&#39;</span><span class="p">,</span><span class="n">fps</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">fps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># initially set to None on superclass init</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Need to set FPS with an integer&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">frame_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set camera to lead or follow hardware triggers</span>

<span class="sd">        If ``&#39;lead&#39;``, Camera will send TTL pulses from Line 2.</span>

<span class="sd">        If ``&#39;follow&#39;``, Camera will follow triggers from Line 3.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            * `&lt;https://www.flir.com/support-center/iis/machine-vision/application-note/configuring-synchronized-capture-with-multiple-cameras&gt;`_</span>
<span class="sd">            * `&lt;https://www.flir.com/support-center/iis/machine-vision/knowledge-base/what-external-iidc-trigger-modes-are-supported-by-my-camera/&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_trigger</span>

    <span class="nd">@frame_trigger</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">frame_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_trigger</span><span class="p">):</span>

        <span class="c1"># if we&#39;re generating the triggers...</span>
        <span class="k">if</span> <span class="n">frame_trigger</span> <span class="o">==</span> <span class="s2">&quot;lead&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">LineSelector</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">LineSelector_Line2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">V3_3Enable</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">frame_trigger</span> <span class="o">==</span> <span class="s2">&quot;follow&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">TriggerMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">TriggerMode_Off</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">TriggerSource</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">TriggerSource_Line3</span><span class="p">)</span>
            <span class="c1"># this article says that setting triggeroverlap is necessary, but not sure what it does</span>
            <span class="c1"># http://justinblaber.org/acquiring-stereo-images-with-spinnaker-api-hardware-trigger/</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">TriggerOverlap</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">TriggerOverlap_ReadOut</span><span class="p">)</span>
            <span class="c1"># In continuous mode, each trigger captures one frame8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">TriggerSelector</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">TriggerSelector_FrameStart</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">TriggerMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">TriggerMode_On</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_trigger</span> <span class="o">=</span> <span class="n">frame_trigger</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acquisition_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Image acquisition mode</span>

<span class="sd">        One of</span>

<span class="sd">        * ``&#39;continuous&#39;`` - continuously acquire frame camera</span>
<span class="sd">        * ``&#39;single&#39;`` - acquire a single frame</span>
<span class="sd">        * ``&#39;multi&#39;`` - acquire a finite number of frames.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Only ``&#39;continuous&#39;`` has been tested.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">AcquisitionMode</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

    <span class="nd">@acquisition_mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">acquisition_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquisition_mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">acquisition_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">AcquisitionMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">AcquisitionMode_Continuous</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">acquisition_mode</span><span class="o">.</span><span class="n">startwsith</span><span class="p">(</span><span class="s2">&quot;single&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">AcquisitionMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">AcquisitionMode_SingleFrame</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">acquisition_mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;multi&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">AcquisitionMode</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">PySpin</span><span class="o">.</span><span class="n">AcquisitionMode_SingleFrame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Acquisition mode must be continuous, single, or multi&#39;</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">readable_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All device attributes that are currently readable with :meth:`~Camera_Spinnaker.get`</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of attributes that are readable and their current values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_attributes</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">IsReadable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_readable_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readable_attributes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">writable_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All device attributes that are currently writeable wth :meth:`~Camera_Spinnaker.set`</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of attributes that are writeable and their current values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writable_attributes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">IsWritable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_writable_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writable_attributes</span>


<div class="viewcode-block" id="Camera_Spinnaker.get"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a camera attribute.</span>

<span class="sd">        Any value in :attr:`.readable_attributes` can be read. Attempts to get numeric values</span>
<span class="sd">        with ``.GetValue``, otherwise gets a string with ``.ToString``, so be cautious with types.</span>

<span class="sd">        If ``attr`` is a method (ie. in ``._camera_methods``, execute the method and return the value</span>

<span class="sd">        Args:</span>
<span class="sd">            attr (str): Name of a readable attribute or executable method</span>

<span class="sd">        Returns:</span>
<span class="sd">            float, int, str: Value of ``attr``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">:</span>

            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">IsReadable</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Camera property &#39;</span><span class="si">%s</span><span class="s2">&#39; is not readable&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s2">&quot;GetValue&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s2">&quot;ToString&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Camera property &#39;</span><span class="si">%s</span><span class="s2">&#39; is not readable&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera_Spinnaker.set"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a camera attribute</span>

<span class="sd">        Any value in :attr:`.writeable_attributes` can be set. If attribute has a ``.SetValue`` method,</span>
<span class="sd">        (ie. accepts numeric values), attempt to use it, otherwise use ``.FromString``.</span>

<span class="sd">        Args:</span>
<span class="sd">            attr (str): Name of attribute to be set</span>
<span class="sd">            val (str, int, float): Value to set attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="p">:</span>
            <span class="c1"># checking ensures we have camera initialized</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">:</span>

                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">IsWritable</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Property &#39;</span><span class="si">%s</span><span class="s2">&#39; is not currently writable!&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s1">&#39;SetValue&#39;</span><span class="p">):</span>
                    <span class="n">prop</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prop</span><span class="o">.</span><span class="n">FromString</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Camera method &#39;</span><span class="si">%s</span><span class="s2">&#39; is a function -- you can&#39;t assign it a value!&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Not sure what to do with attr: </span><span class="si">{}</span><span class="s1">, value: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span></div>

        <span class="c1"># else:</span>
        <span class="c1">#</span>
        <span class="c1">#     self.__setattr__(attr, val)</span>


<div class="viewcode-block" id="Camera_Spinnaker.list_options"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.list_options">[docs]</a>    <span class="k">def</span> <span class="nf">list_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the possible values of a camera attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): name of attribute to query</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with {available options: descriptions}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a camera method or attribute&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">access</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;GetAccessMode&#39;</span><span class="p">):</span>
            <span class="n">access</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">GetAccessMode</span><span class="p">()</span>

        <span class="c1"># print(info)</span>
        <span class="k">if</span> <span class="n">access</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;GetEntries&#39;</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">():</span>
                    <span class="n">entries</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;EnumEntry_&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t access attribute </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">entries</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all information about the camera</span>

<span class="sd">        Note that this is distinct from camera *attributes* like fps, instead</span>
<span class="sd">        this is information like serial number, version, firmware revision, etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: {feature name: feature value}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">device_info</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CCategoryPtr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="o">.</span><span class="n">GetNode</span><span class="p">(</span><span class="s1">&#39;DeviceInformation&#39;</span><span class="p">))</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">device_info</span><span class="o">.</span><span class="n">GetFeatures</span><span class="p">()</span>

        <span class="c1"># save information to a dictionary</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">node_feature</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CValuePtr</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="n">node_feature</span><span class="o">.</span><span class="n">GetName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">node_feature</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">info_dict</span>

<div class="viewcode-block" id="Camera_Spinnaker.release"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Camera_Spinnaker.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release all PySpin objects and wait on writer, if still active.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Camera_Spinnaker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopping</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_camera_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera_node_types</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">EndAcquisition</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam</span><span class="o">.</span><span class="n">DeInit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cam</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_list</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmap</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">ReleaseInstance</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writing</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div></div>




<span class="c1">#</span>
<span class="c1"># class Camera_Picam(Camera):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     also can be used w/ picapture</span>
<span class="c1">#     https://lintestsystems.com/wp-content/uploads/2016/09/PiCapture-SD1-Documentation.pdf</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     pass</span>

<span class="c1">#</span>
<span class="c1"># class FastWriter(io.FFmpegWriter):</span>
<span class="c1">#     def __init__(self, *args, **kwargs):</span>
<span class="c1">#         super(FastWriter, self).__init__(*args, **kwargs)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     def writeFrame(self, im):</span>
<span class="c1">#         &quot;&quot;&quot;Sends ndarray frames to FFmpeg</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         vid = vshape(im)</span>
<span class="c1">#</span>
<span class="c1">#         if not self.warmStarted:</span>
<span class="c1">#             T, M, N, C = vid.shape</span>
<span class="c1">#             self._warmStart(M, N, C, im.dtype)</span>
<span class="c1">#</span>
<span class="c1">#         #vid = vid.clip(0, (1 &lt;&lt; (self.dtype.itemsize &lt;&lt; 3)) - 1).astype(self.dtype)</span>
<span class="c1">#</span>
<span class="c1">#         try:</span>
<span class="c1">#             self._proc.stdin.write(vid.tostring())</span>
<span class="c1">#         except IOError as e:</span>
<span class="c1">#             # Show the command and stderr from pipe</span>
<span class="c1">#             msg = &#39;{0:}\n\nFFMPEG COMMAND:\n{1:}\n\nFFMPEG STDERR &#39; \</span>
<span class="c1">#                   &#39;OUTPUT:\n&#39;.format(e, self._cmd)</span>
<span class="c1">#             raise IOError(msg)</span>


<span class="k">class</span> <span class="nc">Directory_Writer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">IMG_EXTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">ffmpeg_bin</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode a directory of images to video with ffmpeg</span>

<span class="sd">        Images should be named such that they are machine-orderable, eg.::</span>

<span class="sd">            # this</span>
<span class="sd">            img-001.png, img-002.png, ... img-010.png</span>

<span class="sd">            # not this</span>
<span class="sd">            img-1.png, img-2.png, ... img-10.png</span>

<span class="sd">        Encoding settings are:</span>

<span class="sd">        * ``pix_fmt``: ``yuv420p``</span>
<span class="sd">        * ``vcodec`` : ``libx264``</span>
<span class="sd">        * ``preset``: ``veryfast``</span>

<span class="sd">        .. note::</span>

<span class="sd">            ffmpeg must be installed to use this object</span>

<span class="sd">        Args:</span>
<span class="sd">            dir (str): directory of images to encode</span>
<span class="sd">            fps (int): framerate of output video</span>
<span class="sd">            ext (str): extension of input images</span>
<span class="sd">            ffmpeg_bin (str): ffmpeg binary to use, default is to use ffmpeg in ``$PATH``,</span>
<span class="sd">                otherwise specific binary can be specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffmpeg_bin</span> <span class="o">=</span> <span class="n">ffmpeg_bin</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encode_thread</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Begin encoding.</span>

<span class="sd">        calls :meth:`._encode` in a thread.</span>

<span class="sd">        Encoding calls ffmpeg with a glob string like::</span>

<span class="sd">            self.dir + &#39;*&#39; + self.ext</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encode_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encode_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">glob_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>

        <span class="n">ffmpeg_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ffmpeg_bin</span><span class="p">,</span> <span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">),</span>
                      <span class="s1">&#39;-pattern_type&#39;</span><span class="p">,</span> <span class="s1">&#39;glob&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">glob_str</span><span class="p">,</span>
                      <span class="s1">&#39;-pix_fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;yuv420p&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">),</span>
                      <span class="s1">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s1">&#39;libx264&#39;</span><span class="p">,</span> <span class="s1">&#39;-preset&#39;</span><span class="p">,</span> <span class="s1">&#39;veryfast&#39;</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mp4&#39;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ffmpeg_cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``.join`` the encoding thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encode_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>



<div class="viewcode-block" id="Video_Writer"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Video_Writer">[docs]</a><span class="k">class</span> <span class="nc">Video_Writer</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blosc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode frames as they are acquired in a separate process.</span>

<span class="sd">        Must call :meth:`~Video_Writer.start` after initialization to begin encoding.</span>

<span class="sd">        Encoding continues until &#39;END&#39; is put in :attr:`~Video_Writer.q`.</span>

<span class="sd">        Timestamps are saved in a .csv file with the same path as the video.</span>

<span class="sd">        Args:</span>
<span class="sd">            q (:class:`~queue.Queue`): Queue into which frames will be dumped</span>
<span class="sd">            path (str): output path of video</span>
<span class="sd">            fps (int): framerate of output video</span>
<span class="sd">            timestamps (bool): if True (default), input will be of form (timestamp, frame). if False,</span>
<span class="sd">                input will just be frames and timestamps will be generated as the frame is encoded (**not recommended**)</span>
<span class="sd">            blosc (bool): if True, frames in the :attr:`~Video_Writer.q` will be compresed with blosc. if False, uncompressed</span>

<span class="sd">        Attributes:</span>
<span class="sd">            timestamps (list): Timestamps for frames, written to .csv on completion of encoding</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Video_Writer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">given_timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blosc</span> <span class="o">=</span> <span class="n">blosc</span>


        <span class="k">if</span> <span class="n">fps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No FPS given, using 30fps by default&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="mi">30</span>

<div class="viewcode-block" id="Video_Writer.run"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.Video_Writer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a :class:`skvideo.io.FFmpegWriter` and begin processing frames from :attr:`~Video_Writer.q`</span>

<span class="sd">        Should not be called by itself, overwrites the :meth:`multiprocessing.Process.run` method,</span>
<span class="sd">        so should call :meth:`Video_Writer.start`</span>

<span class="sd">        Continue encoding until &#39;END&#39; put in queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="n">out_vid_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="n">vid_out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FFmpegWriter</span><span class="p">(</span><span class="n">out_vid_fn</span><span class="p">,</span>
        <span class="c1">#vid_out = FastWriter(out_vid_fn,</span>
            <span class="n">inputdict</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;-r&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">),</span>
        <span class="p">},</span>
            <span class="n">outputdict</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;-vcodec&#39;</span><span class="p">:</span> <span class="s1">&#39;libx264&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-pix_fmt&#39;</span><span class="p">:</span> <span class="s1">&#39;yuv420p&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-r&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">),</span>
                <span class="s1">&#39;-preset&#39;</span><span class="p">:</span> <span class="s1">&#39;ultrafast&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;END&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">given_timestamps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blosc</span><span class="p">:</span>
                            <span class="n">vid_out</span><span class="o">.</span><span class="n">writeFrame</span><span class="p">(</span><span class="n">blosc</span><span class="o">.</span><span class="n">unpack_array</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vid_out</span><span class="o">.</span><span class="n">writeFrame</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blosc</span><span class="p">:</span>
                            <span class="n">vid_out</span><span class="o">.</span><span class="n">writeFrame</span><span class="p">(</span><span class="n">blosc</span><span class="o">.</span><span class="n">unpack_array</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vid_out</span><span class="o">.</span><span class="n">writeFrame</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">()</span>
                    <span class="c1"># TODO: Too general</span>
                    <span class="k">break</span>

        <span class="k">finally</span><span class="p">:</span>

            <span class="c1"># save timestamps as .csv</span>
            <span class="n">ts_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ts_file</span><span class="p">:</span>
                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">ts_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">:</span>
                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">ts</span><span class="p">])</span>

            <span class="n">vid_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="list_spinnaker_cameras"><a class="viewcode-back" href="../../../autopilot.hardware.cameras.html#autopilot.hardware.cameras.list_spinnaker_cameras">[docs]</a><span class="k">def</span> <span class="nf">list_spinnaker_cameras</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all available Spinnaker cameras and their ``DeviceInformation``</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of dictionaries of device information for each camera.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">GetInstance</span><span class="p">()</span>
    <span class="n">cam_list</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">GetCameras</span><span class="p">()</span>

    <span class="n">cam_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">cam_list</span><span class="p">:</span>
        <span class="n">nmap</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">GetTLDeviceNodeMap</span><span class="p">()</span>

        <span class="n">device_info</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CCategoryPtr</span><span class="p">(</span><span class="n">nmap</span><span class="o">.</span><span class="n">GetNode</span><span class="p">(</span><span class="s1">&#39;DeviceInformation&#39;</span><span class="p">))</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">device_info</span><span class="o">.</span><span class="n">GetFeatures</span><span class="p">()</span>

        <span class="c1"># save information to a dictionary</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="n">node_feature</span> <span class="o">=</span> <span class="n">PySpin</span><span class="o">.</span><span class="n">CValuePtr</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="n">node_feature</span><span class="o">.</span><span class="n">GetName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">node_feature</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

        <span class="n">cam_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">cam</span>
    <span class="n">cam_list</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
    <span class="n">system</span><span class="o">.</span><span class="n">ReleaseInstance</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cam_info</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Jonny Saunders

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>